<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneFlow Life</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f4f8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800">

    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-white px-6 py-3 rounded-full shadow-lg border hidden z-50 flex items-center gap-2 transition-all duration-300">
        <i id="toast-icon" class="fa-solid"></i>
        <span id="toast-message" class="font-bold text-sm"></span>
    </div>

    <div class="min-h-screen flex items-center justify-center p-4">
        
        <!-- Auth Container -->
        <div id="auth-container" class="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden fade-in">
            <div class="p-8 text-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white">
                <h1 class="text-3xl font-black tracking-tight mb-1">OneFlow <span class="text-blue-200">Life</span></h1>
                <p class="text-blue-100 text-sm opacity-90">ניהול פיננסי חכם</p>
            </div>

            <!-- Login View -->
            <div id="view-login" class="p-8">
                <h2 class="text-xl font-bold mb-6 text-gray-800">כניסה</h2>
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <input type="email" id="login-email" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="מייל קבוצה (אדמין)">
                    <input type="text" id="login-nickname" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="הכינוי שלך">
                    <input type="password" id="login-password" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="סיסמה">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition shadow-md flex justify-center items-center">
                        <span id="btn-login-text">התחבר</span>
                        <div id="btn-login-loader" class="loader ml-2 hidden border-white border-t-transparent"></div>
                    </button>
                </form>
                <div class="mt-6 flex flex-col gap-3 text-center text-sm">
                    <button onclick="switchView('create')" class="text-blue-600 font-bold hover:underline">אין לך חשבון? הקם קבוצה חדשה</button>
                    <button onclick="switchView('join')" class="text-gray-400 font-bold hover:text-gray-600">רוצה להצטרף לקבוצה קיימת?</button>
                </div>
            </div>

            <!-- Create View -->
            <div id="view-create" class="p-8 hidden">
                <h2 class="text-xl font-bold mb-2 text-gray-800">הקמת קבוצה</h2>
                <form onsubmit="handleCreate(event)" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div onclick="selectType('FAMILY')" id="type-family" class="cursor-pointer border-2 border-blue-500 bg-blue-50 text-blue-700 p-3 rounded-xl text-center transition"><i class="fa-solid fa-heart mb-1"></i><div class="font-bold text-xs">משפחה</div></div>
                        <div onclick="selectType('GROUP')" id="type-group" class="cursor-pointer border-2 border-gray-100 text-gray-400 p-3 rounded-xl text-center hover:border-blue-200 transition"><i class="fa-solid fa-briefcase mb-1"></i><div class="font-bold text-xs">שותפים</div></div>
                    </div>
                    <input type="hidden" id="create-type" value="FAMILY">
                    <input type="text" id="create-group-name" required placeholder="שם הקבוצה" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none text-sm">
                    <input type="email" id="create-email" required placeholder="מייל שלך (מנהל)" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none text-sm">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="create-nickname" required placeholder="כינוי" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none text-sm">
                        <input type="number" id="create-year" required placeholder="שנת לידה" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none text-sm">
                    </div>
                    <input type="password" id="create-password" required placeholder="סיסמה" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none text-sm">
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl mt-2 flex justify-center items-center"><span id="btn-create-text">הרשמה</span><div id="btn-create-loader" class="loader ml-2 hidden border-white border-t-transparent"></div></button>
                </form>
                <button onclick="switchView('login')" class="w-full mt-4 text-gray-400 text-sm">ביטול</button>
            </div>

            <!-- Join View -->
            <div id="view-join" class="p-8 hidden">
                <h2 class="text-xl font-bold mb-2 text-gray-800">הצטרפות</h2>
                <form onsubmit="handleJoin(event)" class="space-y-4">
                    <input type="email" id="join-email" required placeholder="מייל מנהל הקבוצה" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                    <input type="text" id="join-nickname" required placeholder="כינוי רצוי" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                    <input type="number" id="join-year" required placeholder="שנת לידה" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                    <input type="password" id="join-password" required placeholder="סיסמה אישית" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl mt-2 flex justify-center items-center"><span id="btn-join-text">שלח בקשה</span><div id="btn-join-loader" class="loader ml-2 hidden border-white border-t-transparent"></div></button>
                </form>
                <button onclick="switchView('login')" class="w-full mt-4 text-gray-400 text-sm">ביטול</button>
            </div>
        </div>

        <!-- Dashboard Module 1 -->
        <div id="dashboard-container" class="w-full max-w-4xl hidden fade-in pb-20">
            <header class="bg-white rounded-2xl shadow-sm p-4 mb-6 flex justify-between items-center sticky top-4 z-10">
                <div class="flex items-center gap-3">
                    <div id="group-icon" class="w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold shadow-md"></div>
                    <div>
                        <h1 id="dash-group-name" class="font-black text-gray-800 text-lg"></h1>
                        <p class="text-xs text-gray-500">שלום, <span id="dash-nickname" class="font-bold text-blue-600"></span></p>
                    </div>
                </div>
                <button onclick="logout()" class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 hover:bg-red-50 hover:text-red-500 transition"><i class="fa-solid fa-right-from-bracket"></i></button>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Status Card -->
                <div class="md:col-span-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-3xl shadow-lg flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold mb-1">OneFlow Life</h2>
                        <p class="opacity-80 text-sm" id="welcome-msg"></p>
                    </div>
                    <div class="text-4xl opacity-20"><i class="fa-solid fa-users"></i></div>
                </div>

                <!-- Active Members List (FIX FOR ISSUE 6) -->
                <div class="md:col-span-2 bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-4 border-b border-gray-50 bg-gray-50/50">
                        <h3 class="font-bold text-gray-700 flex items-center gap-2"><i class="fa-solid fa-user-group text-blue-500"></i> חברי הקבוצה</h3>
                    </div>
                    <div id="members-list" class="divide-y divide-gray-50 p-2">
                        <p class="text-center text-gray-400 py-4 text-sm">טוען...</p>
                    </div>
                </div>

                <!-- Admin: Pending Requests -->
                <div id="admin-panel" class="md:col-span-2 bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden hidden">
                    <div class="p-4 border-b border-gray-50 bg-yellow-50/50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700 flex items-center gap-2"><i class="fa-solid fa-user-clock text-yellow-500"></i> ממתינים לאישור</h3>
                        <span id="pending-count" class="bg-red-100 text-red-600 text-xs font-bold px-2 py-1 rounded-full hidden">0</span>
                    </div>
                    <div id="pending-list" class="divide-y divide-gray-50 p-2">
                        <p class="text-center text-gray-400 py-4 text-sm">אין בקשות חדשות.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = window.location.hostname === 'localhost' ? 'http://localhost:3000/api' : '/api';
        let currentUser = null;
        let currentGroup = null;
        let pollInterval = null;

        // --- Init: Check Session (FIX FOR ISSUE 8) ---
        window.onload = () => {
            const savedSession = localStorage.getItem('ofl_session');
            if(savedSession) {
                const data = JSON.parse(savedSession);
                currentUser = data.user;
                currentGroup = data.group;
                loadDashboard();
            }
        };

        function switchView(viewName) {
            ['login', 'create', 'join'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
        }

        function selectType(type) {
            document.getElementById('create-type').value = type;
            const activeClass = 'border-blue-500 bg-blue-50 text-blue-700';
            const inactiveClass = 'border-gray-100 text-gray-400 hover:border-blue-200';
            document.getElementById('type-family').className = `cursor-pointer border-2 p-3 rounded-xl text-center transition ${type === 'FAMILY' ? activeClass : inactiveClass}`;
            document.getElementById('type-group').className = `cursor-pointer border-2 p-3 rounded-xl text-center transition ${type === 'GROUP' ? activeClass : inactiveClass}`;
        }

        async function handleLogin(e) {
            e.preventDefault();
            toggleLoader('login', true);
            const payload = {
                groupEmail: document.getElementById('login-email').value,
                nickname: document.getElementById('login-nickname').value,
                password: document.getElementById('login-password').value
            };
            try {
                const res = await fetch(`${API}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await res.json();
                if (data.success) {
                    currentUser = data.user;
                    currentGroup = data.group;
                    // Save Session
                    localStorage.setItem('ofl_session', JSON.stringify({user: currentUser, group: currentGroup}));
                    showToast('success', 'התחברת בהצלחה!');
                    loadDashboard();
                } else { showToast('error', data.error); }
            } catch (err) { showToast('error', 'שגיאת תקשורת'); }
            finally { toggleLoader('login', false); }
        }

        async function handleCreate(e) {
            e.preventDefault();
            toggleLoader('create', true);
            const payload = {
                type: document.getElementById('create-type').value,
                groupName: document.getElementById('create-group-name').value,
                adminEmail: document.getElementById('create-email').value,
                adminNickname: document.getElementById('create-nickname').value,
                birthYear: document.getElementById('create-year').value,
                password: document.getElementById('create-password').value
            };
            try {
                const res = await fetch(`${API}/groups`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await res.json();
                if (data.success) {
                    currentUser = data.user;
                    currentGroup = data.group;
                    localStorage.setItem('ofl_session', JSON.stringify({user: currentUser, group: currentGroup}));
                    showToast('success', 'הקבוצה נוצרה!');
                    loadDashboard();
                } else { showToast('error', data.error); }
            } catch (err) { showToast('error', 'שגיאה ביצירה'); }
            finally { toggleLoader('create', false); }
        }

        async function handleJoin(e) {
            e.preventDefault();
            toggleLoader('join', true);
            const payload = {
                groupEmail: document.getElementById('join-email').value,
                nickname: document.getElementById('join-nickname').value,
                birthYear: document.getElementById('join-year').value,
                password: document.getElementById('join-password').value
            };
            try {
                const res = await fetch(`${API}/join`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await res.json();
                if (data.success) {
                    showToast('success', 'בקשה נשלחה בהצלחה!');
                    switchView('login');
                } else { showToast('error', data.error); }
            } catch (err) { showToast('error', 'שגיאת תקשורת'); }
            finally { toggleLoader('join', false); }
        }

        function loadDashboard() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
            
            document.getElementById('dash-group-name').innerText = currentGroup.name;
            document.getElementById('dash-nickname').innerText = currentUser.nickname;
            document.getElementById('welcome-msg').innerText = `ברוכים הבאים ל${currentGroup.name}`;

            const iconDiv = document.getElementById('group-icon');
            iconDiv.className = `w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold shadow-md ${currentGroup.type==='FAMILY'?'bg-pink-500':'bg-blue-500'}`;
            iconDiv.innerHTML = currentGroup.type==='FAMILY'?'<i class="fa-solid fa-heart"></i>':'<i class="fa-solid fa-briefcase"></i>';

            fetchMembers(); // Show active members

            if (currentUser.role === 'ADMIN') {
                document.getElementById('admin-panel').classList.remove('hidden');
                fetchPendingUsers();
                // Polling for updates every 5 seconds (FIX FOR ISSUE 7)
                if(!pollInterval) pollInterval = setInterval(() => { fetchPendingUsers(); fetchMembers(); }, 5000);
            }
        }

        async function fetchMembers() {
            try {
                const res = await fetch(`${API}/group/members?groupId=${currentGroup.id}`);
                const members = await res.json();
                const list = document.getElementById('members-list');
                list.innerHTML = '';
                members.forEach(m => {
                    const roleBadge = m.role === 'ADMIN' ? '<span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-bold">מנהל</span>' : '';
                    list.innerHTML += `<div class="p-3 flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-sm">${m.nickname[0]}</div><div><p class="font-bold text-gray-800 text-sm">${m.nickname} ${roleBadge}</p></div></div><span class="text-xs font-bold text-gray-400">₪${m.balance}</span></div>`;
                });
            } catch(e) { console.error(e); }
        }

        async function fetchPendingUsers() {
            try {
                const res = await fetch(`${API}/admin/pending-users?groupId=${currentGroup.id}`);
                const users = await res.json();
                const list = document.getElementById('pending-list');
                const badge = document.getElementById('pending-count');
                
                if (users.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-400 py-4 text-xs">אין בקשות חדשות.</p>';
                    badge.classList.add('hidden');
                    return;
                }
                
                // Show notification only if count increased
                if(badge.classList.contains('hidden') || parseInt(badge.innerText) < users.length) {
                    // Optional: Play sound or visual cue
                }

                badge.innerText = users.length;
                badge.classList.remove('hidden');
                list.innerHTML = '';

                users.forEach(u => {
                    list.innerHTML += `<div class="p-3 flex items-center justify-between bg-yellow-50/50 rounded-lg mb-2"><div><p class="font-bold text-gray-800 text-sm">${u.nickname}</p><p class="text-[10px] text-gray-500">נולד/ה ב-${u.birth_year}</p></div><button onclick="approveUser(${u.id})" class="bg-green-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow hover:bg-green-600 transition">אשר</button></div>`;
                });
            } catch (err) { console.error(err); }
        }

        async function approveUser(userId) {
            try {
                await fetch(`${API}/admin/approve-user`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId }) });
                showToast('success', 'אושר בהצלחה!');
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
                fetchPendingUsers();
                fetchMembers();
            } catch (err) { showToast('error', 'שגיאה באישור'); }
        }

        function logout() {
            localStorage.removeItem('ofl_session');
            if(pollInterval) clearInterval(pollInterval);
            location.reload();
        }

        function toggleLoader(action, isLoading) {
            const btnText = document.getElementById(`btn-${action}-text`);
            const loader = document.getElementById(`btn-${action}-loader`);
            if (isLoading) { btnText.classList.add('hidden'); loader.classList.remove('hidden'); }
            else { btnText.classList.remove('hidden'); loader.classList.add('hidden'); }
        }

        function showToast(type, message) {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const text = document.getElementById('toast-message');
            toast.classList.remove('hidden');
            text.innerText = message;
            toast.className = `fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-lg border z-50 flex items-center gap-2 animate-bounce ${type==='success' ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'}`;
            icon.className = type==='success' ? 'fa-solid fa-circle-check' : 'fa-solid fa-circle-exclamation';
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }
    </script>
</body>
</html>
