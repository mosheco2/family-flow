<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); }
        .modal { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .animate-item { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .shop-check:checked + div { text-decoration: line-through; color: #9ca3af; }
        .nav-tab.active { background-color: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 bg-gray-50">

    <!-- ××¡×š ×‘×—×™×¨×ª ××©×ª××© -->
    <div id="user-select-screen" class="w-full max-w-2xl text-center">
        <h1 class="text-5xl font-black text-gray-800 mb-2 tracking-tight">FamilyFlow</h1>
        <p class="mb-12 text-gray-500 text-lg">×”××¢×¨×›×ª ×”×¤×™× × ×¡×™×ª ×©×œ ×”××©×¤×—×”</p>
        <div id="loading-spinner" class="mb-8"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-600"></i><p class="mt-2 text-sm text-gray-400">×˜×•×¢×Ÿ ×‘× ×§...</p></div>
        <div id="users-grid" class="grid grid-cols-2 md:grid-cols-3 gap-8 justify-center hidden"></div>
        <div id="connection-error" class="hidden text-red-500 mt-8">×©×’×™××ª ×—×™×‘×•×¨. <button onclick="location.reload()" class="underline font-bold">× ×¡×” ×©×•×‘</button></div>
        <div id="server-config" class="mt-12 text-xs text-gray-300"><button onclick="document.getElementById('manual-server-input').classList.toggle('hidden')">×”×’×“×¨×•×ª ×©×¨×ª</button><div id="manual-server-input" class="hidden mt-2"><input type="text" id="custom-app-name" placeholder="App Name" class="border p-1 rounded text-center"><button onclick="saveAppNameAndRetry()" class="bg-gray-200 px-2 py-1 rounded ml-1">×©××•×¨</button></div></div>
    </div>

    <!-- ××¡×›×™× ××•×¡×ª×¨×™× (×”×¨×©××”, ×¤×™×Ÿ) -->
    <div id="register-screen" class="hidden w-full max-w-md card p-8 text-center animate-item"><div class="mb-6 text-green-500 text-6xl"><i class="fa-solid fa-gift animate-bounce"></i></div><h2 class="text-3xl font-black text-gray-800 mb-2">×‘×¨×•×›×™× ×”×‘××™×!</h2><p id="register-role-desc" class="text-gray-500 mb-8 text-lg">×‘×•××• × ×¤×ª×— ×œ×›× ×—×©×‘×•×Ÿ</p><input type="text" id="reg-name" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-3 text-lg outline-none focus:border-green-500 transition" placeholder="××™×š ×§×•×¨××™× ×œ×š?"><input type="password" id="reg-pin" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-6 text-center text-xl tracking-[0.5em] outline-none focus:border-green-500 transition" placeholder="****" maxlength="4"><button onclick="completeRegistration()" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-2xl font-bold shadow-lg text-lg transition transform active:scale-95">×™×¦×™×¨×ª ×—×©×‘×•×Ÿ</button></div>
    <div id="pin-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-xs rounded-3xl p-8 shadow-2xl text-center"><div id="pin-user-icon" class="w-20 h-20 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl"></div><h3 id="pin-user-name" class="text-2xl font-bold mb-6 text-gray-800"></h3><input type="password" id="pin-input" class="w-full p-4 text-center text-3xl border-2 border-gray-200 rounded-2xl mb-6 focus:border-blue-500 outline-none tracking-[0.5em] transition" placeholder="****" maxlength="4"><div class="flex gap-3"><button onclick="closePinModal()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600">×‘×™×˜×•×œ</button><button onclick="login()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">×›× ×¡</button></div><p id="error-msg" class="text-red-500 mt-4 hidden text-sm font-bold">×§×•×“ ×©×’×•×™</p></div></div>

    <!-- ×“×©×‘×•×¨×“ ×¨××©×™ -->
    <div id="dashboard" class="hidden w-full max-w-md pb-32">
        <header class="flex justify-between items-center mb-6 p-4 sticky top-0 bg-[#f8fafc]/90 backdrop-blur-sm z-10">
            <div><h2 id="user-name" class="text-3xl font-black text-gray-800 tracking-tight"></h2><div class="flex items-center gap-2 mt-1"><span id="user-role" class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded-full"></span><span id="user-xp" class="text-xs font-bold bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full border border-yellow-200">âœ¨ 0 XP</span></div></div>
            <div class="flex gap-3"><button onclick="openInviteModal()" id="btn-invite" class="hidden w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-blue-600 hover:bg-blue-50 transition"><i class="fa-solid fa-user-plus"></i></button><button onclick="logout()" class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-right-from-bracket"></i></button></div>
        </header>

        <div class="mx-4 mb-8">
            <div class="card p-8 text-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white relative overflow-hidden shadow-xl transform transition hover:scale-[1.01]">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                <div class="relative z-10"><p class="text-blue-100 text-sm font-medium mb-1">×™×ª×¨×” × ×•×›×—×™×ª</p><h1 id="balance" class="text-6xl font-black tracking-tighter mb-2">â‚ª0</h1><div id="bank-info-child" class="hidden mt-4 flex justify-center gap-4 text-xs bg-white/10 p-2 rounded-xl backdrop-blur-md"><div class="px-2 border-l border-white/20"><span class="block opacity-70">×“××™ ×›×™×¡</span><span class="font-bold text-lg" id="info-allowance">â‚ª0</span></div><div class="px-2"><span class="block opacity-70">×¨×™×‘×™×ª</span><span class="font-bold text-lg" id="info-interest">0%</span></div></div></div>
            </div>
        </div>

        <div class="mx-4 mb-6 bg-white p-1.5 rounded-2xl shadow-sm flex overflow-x-auto gap-1 no-scrollbar">
            <button onclick="switchTab('academy')" id="tab-academy" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap bg-indigo-50 text-indigo-700 border border-indigo-200">××§×“××™×” ğŸ“</button>
            <button onclick="switchTab('feed')" id="tab-feed" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap">×¢×“×›×•× ×™× ğŸ””</button>
            <button onclick="switchTab('tasks')" id="tab-tasks" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap">××©×™××•×ª</button>
            <button onclick="switchTab('goals')" id="tab-goals" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap">×™×¢×“×™×</button>
            <button onclick="switchTab('shopping')" id="tab-shopping" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap">×§× ×™×•×ª</button>
            <button onclick="switchTab('bank')" id="tab-bank" class="nav-tab hidden flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap bg-purple-50 text-purple-700 border border-purple-100">×”×‘× ×§</button>
            <button onclick="switchTab('loans')" id="tab-loans" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap">×”×œ×•×•××•×ª</button>
            <button onclick="switchTab('budget')" id="tab-budget" class="nav-tab hidden flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap bg-teal-50 text-teal-700 border border-teal-100">×ª×§×¦×™×‘</button>
            <button onclick="switchTab('reports')" id="tab-reports" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap">×ª×—×–×™×ª</button>
        </div>

        <!-- ××–×•×¨ ××§×“××™×” (×—×“×©) -->
        <div id="section-academy" class="mx-4 mb-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-800 text-xl">×œ×•××“×™× ×•××¨×•×•×™×—×™×</h3>
                <button id="btn-add-quiz" onclick="openAddQuizModal()" class="hidden text-sm bg-indigo-100 text-indigo-700 px-4 py-2 rounded-full font-bold">+ ×”×•×¡×£ ×©×™×¢×•×¨</button>
            </div>
            <div id="quiz-list" class="space-y-4"></div>
            <p id="no-quiz-msg" class="text-center text-gray-400 text-sm py-8 bg-white rounded-2xl border border-dashed border-gray-200 hidden">×›×œ ×”×›×‘×•×“! ×¡×™×™××ª ××ª ×›×œ ×”××©×™××•×ª ×”×œ×™××•×“×™×•×ª ğŸ‰</p>
        </div>

        <!-- ××–×•×¨ ×¢×“×›×•× ×™× (×—×“×©) -->
        <div id="section-feed" class="mx-4 mb-8 hidden">
            <h3 class="font-bold text-gray-800 text-xl mb-4">×œ×•×— ××•×“×¢×•×ª ××©×¤×—×ª×™</h3>
            <div id="feed-list" class="space-y-3"></div>
        </div>

        <!-- ××–×•×¨×™× ×§×™×™××™× -->
        <div id="section-tasks" class="mx-4 mb-8 hidden"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 text-xl">××©×™××•×ª</h3><button id="btn-add-task" onclick="openTaskModal()" class="hidden text-sm bg-purple-100 text-purple-700 px-4 py-2 rounded-full font-bold">+ ××©×™××”</button></div><div id="tasks-list" class="space-y-3"></div><p id="no-tasks-msg" class="text-center text-gray-400 text-sm py-8 bg-white rounded-2xl border border-dashed border-gray-200 hidden">××™×Ÿ ××©×™××•×ª ğŸ‰</p></div>
        <div id="section-goals" class="mx-4 mb-8 hidden"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 text-xl">×”×™×¢×“×™× ×©×œ×™</h3><button onclick="openGoalModal()" class="text-sm bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full font-bold">+ ×—×“×©</button></div><div id="goals-list" class="space-y-4"></div><p id="no-goals-msg" class="text-center text-gray-400 text-sm py-8 bg-white rounded-2xl border border-dashed border-gray-200 hidden">×¢×•×“ ×œ× ×”×’×“×¨×ª ×™×¢×“×™× ×œ×—×œ×•××•×ª ×©×œ×š âœ¨</p></div>
        <div id="section-budget" class="mx-4 mb-8 hidden"><h3 class="font-bold text-gray-800 text-xl mb-4">×ª×§×¦×™×‘ ×—×•×“×©×™</h3><div id="budget-bars" class="space-y-4"></div></div>
        <div id="section-loans" class="mx-4 mb-8 hidden"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 text-xl">×”×œ×•×•××•×ª</h3><button onclick="openLoanModal()" class="text-sm bg-indigo-100 text-indigo-700 px-4 py-2 rounded-full font-bold">+ ×‘×§×© ×”×œ×•×•××”</button></div><div id="loans-list" class="space-y-4"></div><p id="no-loans-msg" class="text-center text-gray-400 text-sm py-8 bg-white rounded-2xl border border-dashed border-gray-200 hidden">××™×Ÿ ×”×œ×•×•××•×ª ×¤×¢×™×œ×•×ª</p></div>
        <div id="section-bank" class="mx-4 mb-8 hidden"><div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-6 text-white mb-6 shadow-lg"><h3 class="text-xl font-bold mb-1">× ×™×”×•×œ ×”×‘× ×§</h3><button onclick="runPayday()" class="w-full bg-white text-purple-700 font-bold py-3 rounded-xl shadow mt-4">×”×¤×¢×œ ×™×•× ×ª×©×œ×•× (PayDay)</button></div><h4 class="font-bold text-gray-800 mb-3 px-1">×—×©×‘×•× ×•×ª ×™×œ×“×™×</h4><div id="bank-accounts-list" class="space-y-3 mb-8"></div><h4 class="font-bold text-gray-800 mb-3 px-1">ğŸ† ××œ×•×¤×™ ×”×—×™×¡×›×•×Ÿ</h4><div id="leaderboard-list" class="space-y-2"></div></div>
        <div id="section-reports" class="mx-4 mb-8 hidden"><h3 class="font-bold text-gray-800 text-xl mb-4">×ª×—×–×™×ª ×•××’××•×ª</h3><div class="card p-6 flex flex-col items-center mb-6"><h4 class="text-sm text-gray-500 mb-2 font-bold w-full text-right">×”×ª×¤×œ×’×•×ª ×”×•×¦××•×ª</h4><div class="w-full h-48 relative"><canvas id="expensesChart"></canvas></div></div><div class="card p-6 flex flex-col items-center"><h4 class="text-sm text-gray-500 mb-2 font-bold w-full text-right">××›×•× ×ª ×”×–××Ÿ (×¦×¤×™ ×™×ª×¨×”) ğŸ”®</h4><div class="w-full h-48 relative"><canvas id="forecastChart"></canvas></div><p id="forecast-text" class="text-xs text-gray-500 mt-4 text-center"></p></div></div>
        <div id="section-shopping" class="mx-4 mb-8 hidden"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 text-xl">×¡×•×¤×¨</h3><button onclick="openShoppingModal()" class="text-sm bg-pink-100 text-pink-700 px-4 py-2 rounded-full font-bold">+ ×¤×¨×™×˜</button></div><div id="shopping-pending-area" class="mb-4 hidden"><h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 px-1">×××ª×™× ×™×</h4><div id="shopping-pending-list" class="space-y-2"></div></div><h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 px-1">×¤×¢×™×œ</h4><div id="shopping-active-list" class="space-y-2 bg-white rounded-2xl shadow-sm p-3 min-h-[100px]"></div><button id="btn-checkout" onclick="openCheckoutModal()" class="hidden w-full mt-6 bg-gray-900 text-white py-4 rounded-2xl font-bold shadow-xl flex items-center justify-center gap-3">×¡×™×•× ×§× ×™×™×”</button></div>

        <div class="fixed bottom-6 left-0 w-full px-4 pointer-events-none"><div class="max-w-md mx-auto grid grid-cols-2 gap-4 pointer-events-auto"><button onclick="openModal('income')" class="bg-white/90 backdrop-blur border border-green-100 text-green-700 p-4 rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2"><i class="fa-solid fa-circle-plus text-xl"></i> ×”×›× ×¡×”</button><button onclick="openModal('expense')" class="bg-white/90 backdrop-blur border border-red-100 text-red-700 p-4 rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2"><i class="fa-solid fa-circle-minus text-xl"></i> ×”×•×¦××”</button></div></div>
        <div id="family-section" class="mx-4 mb-8 hidden mt-8 pt-8 border-t border-gray-200"><h3 class="font-bold text-gray-800 text-lg mb-4">×‘× ×™ ×”××©×¤×—×”</h3><div id="family-list" class="flex gap-4 overflow-x-auto pb-4 no-scrollbar"></div></div>
        <div class="mx-4 pb-20"><h3 class="font-bold text-gray-800 text-lg mb-4">×¤×¢×™×œ×•×ª ××—×¨×•× ×”</h3><div id="transactions-list" class="space-y-3"></div></div>
    </div>

    <!-- ××•×“×œ ×—×™×“×•×Ÿ -->
    <div id="quiz-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <div id="quiz-icon" class="text-center mb-4 text-4xl"></div>
            <h3 id="quiz-question" class="text-xl font-bold mb-4 text-center text-gray-800"></h3>
            <div id="quiz-content" class="bg-indigo-50 p-4 rounded-xl text-sm text-gray-700 mb-4 hidden leading-relaxed"></div>
            <input type="hidden" id="quiz-id">
            <div id="quiz-options" class="space-y-3 mb-4"></div>
            <button onclick="document.getElementById('quiz-modal').classList.add('hidden')" class="w-full py-3 bg-gray-100 font-bold rounded-xl mt-4">×¡×’×•×¨</button>
        </div>
    </div>

    <!-- ××•×“×œ ×”×•×¡×¤×ª ×©×™×¢×•×¨ (×œ×”×•×¨×™×) -->
    <div id="add-quiz-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4 text-center text-indigo-600">×”×•×¡×¤×ª ×©×™×¢×•×¨</h3>
            <label class="block text-xs font-bold text-gray-500 mb-1">×¡×•×’</label>
            <select id="new-quiz-type" class="w-full p-3 border rounded-xl mb-3 bg-white" onchange="toggleContentField()">
                <option value="trivia">×©××œ×” ×××¨×™×§××™×ª (×˜×¨×™×•×•×™×”)</option>
                <option value="math">×ª×¨×’×™×œ ×—×©×‘×•×Ÿ</option>
                <option value="reading">×”×‘× ×ª ×”× ×§×¨×</option>
            </select>
            <label class="block text-xs font-bold text-gray-500 mb-1">×’×™×œ ×™×¢×“</label>
            <select id="new-quiz-age" class="w-full p-3 border rounded-xl mb-3 bg-white">
                <option value="child_6_10">×™×œ×“ (6-10)</option>
                <option value="child_10_15">× ×¢×¨ (10-15)</option>
                <option value="teen_15_18">×‘×•×’×¨ (15+)</option>
            </select>
            <label class="block text-xs font-bold text-gray-500 mb-1">×”×©××œ×”/×”×ª×¨×’×™×œ</label>
            <input type="text" id="new-quiz-question" class="w-full p-3 border rounded-xl mb-3" placeholder="××” ×”×©××œ×”?">
            
            <div id="new-quiz-content-div" class="hidden">
                <label class="block text-xs font-bold text-gray-500 mb-1">×˜×§×¡×˜ ×œ×§×¨×™××”</label>
                <textarea id="new-quiz-content" class="w-full p-3 border rounded-xl mb-3" rows="3" placeholder="×”×˜×§×¡×˜ ×©×”×™×œ×“ ×™×§×¨×..."></textarea>
            </div>

            <label class="block text-xs font-bold text-gray-500 mb-1">×ª×©×•×‘×•×ª (×”×¨××©×•× ×” ×”×™× ×”× ×›×•× ×”, × ×¢×¨×‘×‘ ××—"×›)</label>
            <input type="text" id="new-quiz-opt1" class="w-full p-2 border rounded-xl mb-2 bg-green-50" placeholder="×”×ª×©×•×‘×” ×”× ×›×•× ×”">
            <input type="text" id="new-quiz-opt2" class="w-full p-2 border rounded-xl mb-2" placeholder="×ª×©×•×‘×” ×©×’×•×™×” 1">
            <input type="text" id="new-quiz-opt3" class="w-full p-2 border rounded-xl mb-2" placeholder="×ª×©×•×‘×” ×©×’×•×™×” 2">
            
            <label class="block text-xs font-bold text-gray-500 mb-1">×¤×¨×¡ (â‚ª)</label>
            <input type="number" id="new-quiz-reward" class="w-full p-3 border rounded-xl mb-6" value="5">

            <div class="flex gap-3">
                <button onclick="document.getElementById('add-quiz-modal').classList.add('hidden')" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">×‘×™×˜×•×œ</button>
                <button onclick="createQuiz()" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">×¦×•×¨</button>
            </div>
        </div>
    </div>

    <!-- ×©××¨ ×”××•×“×œ×™× (×§×™×™××™×) -->
    <div id="invite-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center text-blue-600">×”×–×× ×”</h3><div class="space-y-3 mb-6"><button onclick="generateInvite('parent','adult')" class="w-full text-right p-4 border rounded-2xl">×‘×Ÿ/×‘×ª ×–×•×’</button><button onclick="generateInvite('child','child_6_10')" class="w-full text-right p-4 border rounded-2xl">×™×œ×“ (6-10)</button><button onclick="generateInvite('child','child_10_15')" class="w-full text-right p-4 border rounded-2xl">× ×¢×¨ (10-15)</button></div><div id="invite-link-area" class="hidden bg-blue-50 p-4 rounded-2xl mb-4 text-center"><button id="btn-send-whatsapp" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold">×©×œ×— ×‘×•×•×¦××¤</button></div><button onclick="document.getElementById('invite-modal').classList.add('hidden');" class="w-full py-3 bg-gray-100 font-bold rounded-xl">×¡×’×•×¨</button></div></div>
    <div id="goal-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center text-yellow-600">×™×¢×“ ×—×“×©</h3><input type="text" id="goal-title" class="w-full p-3 border rounded-xl mb-3" placeholder="×œ××” ×—×•×¡×›×™×?"><input type="number" id="goal-target" class="w-full p-3 border rounded-xl mb-3" placeholder="×›××” ×¦×¨×™×š? (â‚ª)"><label class="block text-xs font-bold text-gray-500 mb-1 mr-1">××ª×™ ×¨×•×¦×™× ×œ×§× ×•×ª?</label><input type="date" id="goal-date" class="w-full p-3 border rounded-xl mb-6 bg-gray-50"><div class="flex gap-3"><button onclick="document.getElementById('goal-modal').classList.add('hidden')" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">×‘×™×˜×•×œ</button><button onclick="submitGoal()" class="flex-1 py-3 bg-yellow-500 text-white rounded-xl font-bold">×¦×•×¨</button></div></div></div>
    <div id="deposit-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-2 text-center text-green-600">×”×¤×§×“×” ×œ×—×™×¡×›×•×Ÿ</h3><p class="text-center text-gray-500 mb-6 text-sm">×”×›×¡×£ ×™×¨×“ ××”×™×ª×¨×” ×”× ×•×›×—×™×ª ×©×œ×š</p><input type="hidden" id="deposit-goal-id"><input type="number" id="deposit-amount" class="w-full p-4 border-2 border-green-100 rounded-2xl mb-6 text-3xl text-center font-bold text-green-600" placeholder="â‚ª0"><div class="flex gap-3"><button onclick="document.getElementById('deposit-modal').classList.add('hidden')" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">×‘×™×˜×•×œ</button><button onclick="submitDeposit()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold shadow-lg">×”×¤×§×“</button></div></div></div>
    <div id="edit-budget-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center text-teal-600">×¢×¨×™×›×ª ×ª×§×¦×™×‘</h3><p id="edit-budget-cat-name" class="text-center text-gray-600 mb-4"></p><input type="hidden" id="edit-budget-cat"><label class="block text-xs font-bold text-gray-500 mb-1">×ª×§×¨×” (â‚ª)</label><input type="number" id="edit-budget-limit" class="w-full p-4 border-2 rounded-2xl mb-6 text-xl font-bold text-center"><div class="flex gap-3"><button onclick="document.getElementById('edit-budget-modal').classList.add('hidden')" class="flex-1 bg-gray-100 rounded-xl">×‘×™×˜×•×œ</button><button onclick="saveBudgetLimit()" class="flex-1 bg-teal-600 text-white rounded-xl">×©××•×¨</button></div></div></div>
    <div id="task-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center">××©×™××” ×—×“×©×”</h3><input type="text" id="task-title" class="w-full p-3 border rounded-xl mb-3" placeholder="×ª×™××•×¨"><input type="number" id="task-reward" class="w-full p-3 border rounded-xl mb-3" placeholder="×ª×’××•×œ"><select id="task-assignee" class="w-full p-3 border rounded-xl mb-6 bg-white"></select><div class="flex gap-3"><button onclick="document.getElementById('task-modal').classList.add('hidden')" class="flex-1 bg-gray-100 rounded-xl">×‘×™×˜×•×œ</button><button onclick="submitTask()" class="flex-1 bg-purple-600 text-white rounded-xl">×¦×•×¨</button></div></div></div>
    <div id="shopping-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center">×”×•×¡×¤×” ×œ×¡×•×¤×¨</h3><input type="text" id="shop-item-name" class="w-full p-3 border rounded-xl mb-6" placeholder="×¤×¨×™×˜"><div class="flex gap-3"><button onclick="document.getElementById('shopping-modal').classList.add('hidden')" class="flex-1 bg-gray-100 rounded-xl">×‘×™×˜×•×œ</button><button onclick="submitShopItem()" class="flex-1 bg-pink-600 text-white rounded-xl">×”×•×¡×£</button></div></div></div>
    <div id="transaction-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 id="modal-title" class="text-xl font-bold mb-6 text-center">×ª× ×•×¢×”</h3><input type="number" id="t-amount" class="w-full p-3 border rounded-xl mb-3 text-lg" placeholder="×¡×›×•×"><input type="text" id="t-desc" class="w-full p-3 border rounded-xl mb-3" placeholder="×ª×™××•×¨"><select id="t-category" class="w-full p-3 border rounded-xl mb-3 bg-white"><option value="general">×›×œ×œ×™</option><option value="food">××•×›×œ</option><option value="toys">××©×—×§×™×</option><option value="clothes">×‘×’×“×™×</option><option value="entertainment">×‘×™×œ×•×™×™×</option><option value="transport">× ×¡×™×¢×•×ª</option></select><label class="block text-xs font-bold text-gray-500 mb-1 mr-1">×ª××¨×™×š ×‘×™×¦×•×¢/×¦×¤×•×™</label><input type="date" id="t-date" class="w-full p-3 border rounded-xl mb-3 bg-gray-50"><div id="t-user-select-container" class="hidden mb-6"><select id="t-user-select" class="w-full p-3 border rounded-xl bg-white"></select></div><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 bg-gray-100 rounded-xl">×‘×™×˜×•×œ</button><button onclick="submitTransaction()" class="flex-1 bg-blue-600 text-white rounded-xl">×©××•×¨</button></div></div></div>
    <div id="checkout-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center">×¡×™×•× ×§× ×™×™×”</h3><input type="number" id="checkout-amount" class="w-full p-4 border rounded-2xl mb-6 text-3xl text-center" placeholder="×¡×”×´×›"><div class="flex gap-3"><button onclick="document.getElementById('checkout-modal').classList.add('hidden')" class="flex-1 bg-gray-100 rounded-xl">×‘×™×˜×•×œ</button><button onclick="submitCheckout()" class="flex-1 bg-gray-900 text-white rounded-xl">××™×©×•×¨</button></div></div></div>
    <div id="loan-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center text-indigo-600">×‘×§×©×ª ×”×œ×•×•××”</h3><input type="number" id="loan-amount" class="w-full p-3 border rounded-xl mb-3" placeholder="×›××” ×¦×¨×™×š?"><input type="text" id="loan-reason" class="w-full p-3 border rounded-xl mb-6" placeholder="×œ××”?"><div class="flex gap-3"><button onclick="document.getElementById('loan-modal').classList.add('hidden')" class="flex-1 bg-gray-100 rounded-xl">×‘×™×˜×•×œ</button><button onclick="submitLoanRequest()" class="flex-1 bg-indigo-600 text-white rounded-xl">×©×œ×—</button></div></div></div>
    <div id="approve-loan-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-2 text-center text-indigo-600">××™×©×•×¨ ×”×œ×•×•××”</h3><p id="approve-loan-desc" class="text-center text-gray-600 text-sm mb-6"></p><input type="hidden" id="approve-loan-id"><label class="block text-xs font-bold text-gray-500 mb-1">×¨×™×‘×™×ª (%)</label><input type="number" id="approve-loan-interest" class="w-full p-3 border rounded-xl mb-6 text-lg font-bold" value="0"><div class="flex gap-3"><button onclick="handleLoan('rejected')" class="flex-1 bg-red-100 text-red-600 rounded-xl">×“×—×”</button><button onclick="handleLoan('active')" class="flex-1 bg-green-600 text-white rounded-xl">××©×¨</button></div></div></div>
    <div id="bank-settings-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-1 text-center">×”×’×“×¨×•×ª ×‘× ×§</h3><input type="hidden" id="bank-settings-id"><label class="block text-xs font-bold text-gray-500 mb-1">×“××™ ×›×™×¡</label><input type="number" id="bank-allowance" class="w-full p-3 border rounded-xl mb-4"><label class="block text-xs font-bold text-gray-500 mb-1">×¨×™×‘×™×ª</label><input type="number" id="bank-interest" class="w-full p-3 border rounded-xl mb-6"><div class="flex gap-3"><button onclick="document.getElementById('bank-settings-modal').classList.add('hidden')" class="flex-1 bg-gray-100 rounded-xl">×‘×™×˜×•×œ</button><button onclick="saveBankSettings()" class="flex-1 bg-purple-600 text-white rounded-xl">×©××•×¨</button></div></div></div>

    <script>
        const storedAppName = localStorage.getItem('custom_app_name');
        const defaultAppName = 'family-flow-app'; 
        const APP_NAME = storedAppName || defaultAppName;
        let API = window.location.hostname.includes('onrender.com') ? '/api' : `https://${APP_NAME}.onrender.com/api`;
        let currentUser = null;
        let selectedUserIdForLogin = null;
        let currentType = 'expense';
        const urlParams = new URLSearchParams(window.location.search);
        const isJoinMode = urlParams.get('join') === 'true';
        const joinRole = urlParams.get('role');
        const joinAge = urlParams.get('age');

        window.onload = async () => { if (isJoinMode) initRegisterMode(); else loadUsersForLogin(); };

        // --- Academy Logic (New) ---
        function renderAcademy(quizzes) {
            const list = document.getElementById('quiz-list');
            list.innerHTML = '';
            if(!quizzes || quizzes.length === 0) { document.getElementById('no-quiz-msg').classList.remove('hidden'); return; }
            document.getElementById('no-quiz-msg').classList.add('hidden');
            
            quizzes.forEach(q => {
                let icon = 'question-circle';
                let color = 'indigo';
                let typeName = '×—×™×“×•×Ÿ';
                if(q.type === 'math') { icon = 'calculator'; color = 'blue'; typeName = '×—×©×‘×•×Ÿ'; }
                if(q.type === 'reading') { icon = 'book-open'; color = 'green'; typeName = '×§×¨×™××”'; }

                list.innerHTML += `
                    <div onclick='openQuiz(${JSON.stringify(q).replace(/'/g, "&#39;")})' class="bg-${color}-600 text-white p-4 rounded-2xl shadow-lg cursor-pointer transform transition hover:scale-[1.02] active:scale-95 border-b-4 border-${color}-800">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-${icon}"></i> ${typeName}</span>
                            <span class="bg-white/20 px-3 py-1 rounded-full text-xs font-bold shadow-sm">+â‚ª${q.reward}</span>
                        </div>
                        <p class="text-${color}-100 text-sm leading-tight">${q.question.length > 40 ? q.question.substring(0,40)+'...' : q.question}</p>
                    </div>
                `;
            });
        }

        function openQuiz(q) {
            document.getElementById('quiz-id').value = q.id;
            document.getElementById('quiz-question').innerText = q.question;
            
            // ×”×¦×’×ª ×ª×•×›×Ÿ ×§×¨×™××” ×× ×§×™×™×
            const contentDiv = document.getElementById('quiz-content');
            if (q.content) {
                contentDiv.innerHTML = `<i class="fa-solid fa-quote-right text-indigo-200 text-2xl float-right ml-2"></i> ${q.content}`;
                contentDiv.classList.remove('hidden');
            } else {
                contentDiv.classList.add('hidden');
            }

            // ××™×™×§×•×Ÿ ××ª××™×
            let icon = '<i class="fa-solid fa-lightbulb text-yellow-400"></i>';
            if(q.type === 'math') icon = '<i class="fa-solid fa-calculator text-blue-400"></i>';
            if(q.type === 'reading') icon = '<i class="fa-solid fa-book-open text-green-400"></i>';
            document.getElementById('quiz-icon').innerHTML = icon;

            const optsContainer = document.getElementById('quiz-options');
            optsContainer.innerHTML = '';
            
            // ×¢×¨×‘×•×‘ ×ª×©×•×‘×•×ª (×›×“×™ ×©×”× ×›×•× ×” ×œ× ×ª×”×™×” ×ª××™×“ ×¨××©×•× ×”)
            // ××‘×œ ×× ×—× ×• ×¦×¨×™×›×™× ×œ×“×¢×ª ××” ×”××™× ×“×§×¡ ×”××§×•×¨×™ ×›×“×™ ×œ×‘×“×•×§ ××•×œ ×”×©×¨×ª
            // ×‘×©×¨×ª ×× ×—× ×• ×‘×•×“×§×™× ×œ×¤×™ correct_index ×©×œ ×”××¢×¨×š ×”××§×•×¨×™.
            // ×œ×›×Ÿ × ×¦×™×’ ××•×ª× ×‘×¡×“×¨ ××§×¨××™, ××‘×œ × ×©×œ×— ×œ×©×¨×ª ××ª ×”××™× ×“×§×¡ ×”××§×•×¨×™.
            
            const optionsWithIndex = q.options.map((opt, idx) => ({opt, idx}));
            // ×¢×¨×‘×•×‘ ×¤×©×•×˜
            optionsWithIndex.sort(() => Math.random() - 0.5);

            optionsWithIndex.forEach((item) => {
                optsContainer.innerHTML += `<button onclick="answerQuiz(${item.idx})" class="w-full text-right p-4 border-2 border-indigo-50 rounded-xl hover:bg-indigo-50 hover:border-indigo-200 font-medium transition mb-2">${item.opt}</button>`;
            });
            document.getElementById('quiz-modal').classList.remove('hidden');
        }

        // --- Parent Academy Management ---
        function openAddQuizModal() { document.getElementById('add-quiz-modal').classList.remove('hidden'); }
        function toggleContentField() {
            const type = document.getElementById('new-quiz-type').value;
            if(type === 'reading') document.getElementById('new-quiz-content-div').classList.remove('hidden');
            else document.getElementById('new-quiz-content-div').classList.add('hidden');
        }
        
        async function createQuiz() {
            const type = document.getElementById('new-quiz-type').value;
            const question = document.getElementById('new-quiz-question').value;
            const content = document.getElementById('new-quiz-content').value;
            const opt1 = document.getElementById('new-quiz-opt1').value; // Correct
            const opt2 = document.getElementById('new-quiz-opt2').value;
            const opt3 = document.getElementById('new-quiz-opt3').value;
            const reward = document.getElementById('new-quiz-reward').value;
            const targetAge = document.getElementById('new-quiz-age').value;

            if(!question || !opt1 || !opt2) return alert('×—×¡×¨×™× ×¤×¨×˜×™×');

            await fetch(`${API}/academy/create`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    type, question, content, 
                    options: [opt1, opt2, opt3], // opt1 is always correct index 0 in our logic before shuffle
                    correctIndex: 0,
                    reward, targetAge
                })
            });
            document.getElementById('add-quiz-modal').classList.add('hidden');
            alert('×”×©×™×¢×•×¨ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
            loadDashboard();
        }

        async function answerQuiz(index) {
            const id = document.getElementById('quiz-id').value;
            const res = await fetch(`${API}/academy/answer`, {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({userId: currentUser.id, quizId: id, answerIndex: index})
            });
            const data = await res.json();
            document.getElementById('quiz-modal').classList.add('hidden');
            if(data.correct) {
                triggerConfetti();
                alert(`× ×›×•×Ÿ! ×”×¨×•×•×—×ª â‚ª${data.reward}`);
                loadDashboard();
            } else {
                alert(`×˜×¢×•×ª... ×œ× × ×•×¨×!`);
            }
        }

        // --- Feed Logic ---
        function renderFeed(feed) {
            const list = document.getElementById('feed-list');
            list.innerHTML = '';
            if(!feed || feed.length === 0) { list.innerHTML = '<p class="text-center text-sm text-gray-400">××™×Ÿ ×¢×“×›×•× ×™× ×¢×“×™×™×Ÿ</p>'; return; }
            feed.forEach(item => {
                const time = new Date(item.created_at).toLocaleTimeString('he-IL', {hour: '2-digit', minute:'2-digit'});
                list.innerHTML += `
                    <div class="flex items-start gap-4 bg-white p-4 rounded-2xl border border-gray-50 shadow-sm animate-item">
                        <div class="bg-blue-50 text-blue-600 rounded-full w-10 h-10 flex items-center justify-center shrink-0 shadow-inner text-lg"><i class="fa-solid fa-${item.icon}"></i></div>
                        <div>
                            <p class="text-sm text-gray-800 leading-relaxed"><span class="font-bold text-blue-700">${item.user_name || '××¢×¨×›×ª'}</span> ${item.action}</p>
                            <p class="text-xs text-gray-400 mt-1 font-bold">${time}</p>
                        </div>
                    </div>
                `;
            });
        }

        // --- Core Functions ---
        async function loadDashboard() {
            document.getElementById('user-name').innerText = currentUser.name;
            document.getElementById('user-role').innerText = currentUser.role === 'parent' ? '×× ×”×œ/×ª' : '×œ×§×•×—';
            document.getElementById('user-xp').innerText = `âœ¨ ${currentUser.xp || 0} XP`; // ×”×¦×’×ª XP

            if (currentUser.role === 'child') {
                document.getElementById('tab-bank').classList.add('hidden');
                document.getElementById('tab-budget').classList.add('hidden');
                document.getElementById('section-bank').classList.add('hidden'); 
                
                // ×”×¡×ª×¨×ª ×˜××‘ ×”×œ×•×•××•×ª ×œ×™×œ×“×™× ×§×˜× ×™× (××•×¤×¦×™×•× ×œ×™, × ×©××™×¨ ×¤×ª×•×— ×œ×—×™× ×•×š)
                
                const balance = parseFloat(currentUser.balance);
                let rank = "×—×•×¡×š ××ª×—×™×œ ğŸŒ±"; if(balance > 100) rank = "×—×•×¡×š ××ª×§×“× ğŸŒ¿"; if(balance > 500) rank = "××œ×•×£ ×”×—×™×¡×›×•×Ÿ ğŸŒ³"; if(balance > 1000) rank = "×˜×™×™×§×•×Ÿ ×¦×¢×™×¨ ğŸ¦";
                document.getElementById('user-rank').innerText = rank; document.getElementById('user-rank').classList.remove('hidden');
                document.getElementById('bank-info-child').classList.remove('hidden'); 
                document.getElementById('info-allowance').innerText = `â‚ª${currentUser.weekly_allowance || 0}`; 
                document.getElementById('info-interest').innerText = `${currentUser.interest_rate || 0}%`;
            } else {
                document.getElementById('btn-invite').classList.remove('hidden');
                document.getElementById('tab-bank').classList.remove('hidden');
                document.getElementById('tab-budget').classList.remove('hidden');
                document.getElementById('btn-add-task').classList.remove('hidden');
                document.getElementById('btn-checkout').classList.remove('hidden');
                document.getElementById('bank-actions-parent').classList.remove('hidden');
                
                // ×”×•×¨×™× ×¨×•××™× ××ª ×”××§×“××™×” ×›×“×™ ×œ×”×•×¡×™×£ ×ª×›× ×™×
                document.getElementById('btn-add-quiz').classList.remove('hidden');
            }

            const res = await fetch(`${API}/data/${currentUser.id}`);
            const data = await res.json();
            if (data.user) currentUser.balance = parseFloat(data.user.balance);
            document.getElementById('balance').innerText = `â‚ª${currentUser.balance}`;

            if (currentUser.role === 'parent' && data.family) {
                document.getElementById('family-section').classList.remove('hidden');
                renderFamily(data.family);
            }

            renderTasks(data.tasks);
            renderShoppingList(data.shopping_list);
            renderTransactions(data.transactions);
            renderGoals(data.goals, data.transactions, currentUser.balance);
            renderLoans(data.loans);
            renderLeaderboard(data.leaderboard);
            renderForecastChart(data.transactions, currentUser.balance);
            renderReports(data.transactions);
            renderFeed(data.feed);
            renderAcademy(data.quizzes);

            if (document.querySelector('.nav-tab.bg-teal-50')) return; 
            switchTab('tasks');
        }

        // --- ×©××¨ ×”×¤×•× ×§×¦×™×•×ª (×”×¢×ª×§ ×–×”×”) ---
        function switchTab(tab) { ['tasks', 'shopping', 'goals', 'budget', 'bank', 'loans', 'feed', 'academy', 'reports'].forEach(t => { document.getElementById(`section-${t}`)?.classList.add('hidden'); const btn = document.getElementById(`tab-${t}`); if(btn) btn.className = "nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap text-gray-500 hover:bg-gray-50"; }); document.getElementById(`section-${tab}`).classList.remove('hidden'); if (tab === 'budget') loadBudget(); let color = 'bg-blue-100 text-blue-700'; if (tab === 'shopping') color = 'bg-pink-100 text-pink-700'; if (tab === 'goals') color = 'bg-yellow-100 text-yellow-700'; if (tab === 'reports') color = 'bg-gray-100 text-gray-700'; if (tab === 'bank') color = 'bg-purple-100 text-purple-700 border border-purple-200'; if (tab === 'loans') color = 'bg-indigo-100 text-indigo-700'; if (tab === 'budget') color = 'bg-teal-100 text-teal-700'; if (tab === 'feed') color = 'bg-orange-100 text-orange-700'; if (tab === 'academy') color = 'bg-indigo-100 text-indigo-700'; document.getElementById(`tab-${tab}`).className = `nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap ${color} shadow-sm`; }
        function calculateForecast(transactions, currentBalance) { const now = new Date(); const monthAgo = new Date(); monthAgo.setDate(monthAgo.getDate() - 30); let income = 0; let expense = 0; transactions.forEach(t => { const tDate = new Date(t.date); if (tDate >= monthAgo && tDate <= now) { if (t.type === 'income') income += parseFloat(t.amount); if (t.type === 'expense') expense += parseFloat(t.amount); } }); const monthlySavings = income - expense; const weeklySavings = monthlySavings / 4; const labels = ['×”×™×•×', '×¢×•×“ ×©×‘×•×¢', '×¢×•×“ ×©×‘×•×¢×™×™×', '×¢×•×“ 3 ×©×‘×•×¢×•×ª', '×¢×•×“ ×—×•×“×©']; const data = [currentBalance]; let predicted = currentBalance; for(let i=0; i<4; i++) { predicted += weeklySavings; data.push(predicted); } return { weeklySavings, labels, data }; }
        function renderForecastChart(transactions, currentBalance) { const ctx = document.getElementById('forecastChart').getContext('2d'); if (forecastChart) forecastChart.destroy(); const { weeklySavings, labels, data } = calculateForecast(transactions, currentBalance); const textEl = document.getElementById('forecast-text'); if (weeklySavings > 0) textEl.innerText = `××¢×•×œ×”! ××ª/×” ×—×•×¡×š/×ª ×›-â‚ª${weeklySavings.toFixed(0)} ×‘×©×‘×•×¢.`; else if (weeklySavings < 0) textEl.innerText = `×–×”×™×¨×•×ª: ××ª/×” ××•×¦×™×/×” ×›-â‚ª${Math.abs(weeklySavings).toFixed(0)} ×™×•×ª×¨ ×××” ×©× ×›× ×¡ ×‘×©×‘×•×¢.`; else textEl.innerText = "××™×Ÿ ×¢×“×™×™×Ÿ ××¡×¤×™×§ × ×ª×•× ×™× ×œ×—×™×©×•×‘ ××’××”."; const color = weeklySavings >= 0 ? '#10B981' : '#EF4444'; forecastChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: '×™×ª×¨×” ×¦×¤×•×™×”', data: data, borderColor: color, backgroundColor: color + '20', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } }); }
        function renderLeaderboard(leaderboard) { const list = document.getElementById('leaderboard-list'); list.innerHTML = ''; if(!leaderboard || leaderboard.length === 0) { list.innerHTML = '<p class="text-center text-sm text-gray-400">××™×Ÿ × ×ª×•× ×™× ×”×—×•×“×©</p>'; return; } leaderboard.forEach((u, index) => { let medal = ''; if(index === 0) medal = 'ğŸ¥‡'; if(index === 1) medal = 'ğŸ¥ˆ'; if(index === 2) medal = 'ğŸ¥‰'; list.innerHTML += `<div class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100 shadow-sm"><div class="flex items-center gap-3"><span class="text-xl font-bold w-6 text-center">${medal || index+1}</span><span class="font-bold text-gray-700">${u.name}</span></div><span class="font-bold text-green-600">+â‚ª${u.monthly_savings}</span></div>`; }); }
        function renderReports(transactions) { const ctx = document.getElementById('expensesChart').getContext('2d'); if (expensesChart) expensesChart.destroy(); const expenses = transactions.filter(t => t.type === 'expense'); if (expenses.length === 0) { document.getElementById('no-data-chart').classList.remove('hidden'); return; } document.getElementById('no-data-chart').classList.add('hidden'); const totals = {}; const labels = { 'general': '×›×œ×œ×™', 'food': '××•×›×œ', 'toys': '××©×—×§×™×', 'clothes': '×‘×’×“×™×', 'entertainment': '×‘×™×œ×•×™×™×', 'transport': '× ×¡×™×¢×•×ª', 'groceries': '×¡×•×¤×¨', 'savings': '×—×™×¡×›×•×Ÿ', 'loans': '×”×—×–×¨ ×”×œ×•×•××•×ª', 'education': '×œ×™××•×“×™×' }; expenses.forEach(t => { const cat = t.category || 'general'; totals[cat] = (totals[cat] || 0) + Number(t.amount); }); const dataValues = Object.values(totals); const dataLabels = Object.keys(totals).map(k => labels[k] || k); expensesChart = new Chart(ctx, { type: 'doughnut', data: { labels: dataLabels, datasets: [{ data: dataValues, backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } }); }
        
        async function submitGoal() { const title = document.getElementById('goal-title').value; const target = document.getElementById('goal-target').value; const date = document.getElementById('goal-date').value; if (!title || !target) return alert("×—×¡×¨×™× ×¤×¨×˜×™× ×œ×™×¢×“"); await fetch(`${API}/goals`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({userId: currentUser.id, title, targetAmount: target, targetDate: date}) }); document.getElementById('goal-modal').classList.add('hidden'); loadDashboard(); }
        async function runPayday() { if (currentUser.role !== 'parent') return alert("×¨×§ ×”×•×¨×™×"); if(!confirm('×”×× ×œ×—×œ×§?')) return; const res = await fetch(`${API}/bank/payday`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: currentUser.id }) }); const data = await res.json(); if(data.success) { alert('×‘×•×¦×¢!'); loadDashboard(); triggerConfetti(); } else { alert(data.message); } }
        async function submitDeposit() { const id = document.getElementById('deposit-goal-id').value; const amount = parseFloat(document.getElementById('deposit-amount').value); if(!amount || amount <= 0) return alert("×¡×›×•× ×œ× ×ª×§×™×Ÿ"); if (currentUser.balance < amount) return alert(`××™×Ÿ ××¡×¤×™×§ ×™×ª×¨×”.`); const res = await fetch(`${API}/goals/deposit`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({userId: currentUser.id, goalId: id, amount: amount}) }); const data = await res.json(); if (!data.success) return alert("×©×’×™××”: " + data.message); document.getElementById('deposit-modal').classList.add('hidden'); triggerConfetti(); loadDashboard(); }
        async function submitTransaction(){ const a=document.getElementById('t-amount').value; const d=document.getElementById('t-desc').value; const cat=document.getElementById('t-category').value; const date=document.getElementById('t-date').value; const u=currentUser.role==='parent'?document.getElementById('t-user-select').value:currentUser.id; if(!a) return alert('×—×¡×¨ ×¡×›×•×'); await fetch(`${API}/transaction`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:u,amount:a,description:d,category:cat,type:currentType, date: date}) }); closeModal(); loadDashboard(); }
        function openModal(t){ currentType=t; document.getElementById('transaction-modal').classList.remove('hidden'); document.getElementById('modal-title').innerText=t==='income'?'×”×›× ×¡×”':'×”×•×¦××”'; document.getElementById('t-date').valueAsDate = new Date(); if(currentUser.role==='parent'){ document.getElementById('t-user-select-container').classList.remove('hidden'); document.getElementById('t-user-select').value=currentUser.id; } }
        
        function triggerConfetti() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
        function saveAppNameAndRetry() { const input = document.getElementById('custom-app-name').value; if (!input) return alert('× × ×œ×”×–×™×Ÿ ×©×'); let cleanName = input.replace('https://', '').replace('.onrender.com', '').split('/')[0]; localStorage.setItem('custom_app_name', cleanName); location.reload(); }
        function initRegisterMode() { document.getElementById('user-select-screen').classList.add('hidden'); document.getElementById('register-screen').classList.remove('hidden'); let roleText = "××©×ª××© ×—×“×©"; if (joinRole === 'parent') roleText = "×”×•×¨×” (×× ×”×œ)"; else if (joinAge === 'child_6_10') roleText = "×™×œ×“/×” (6-10)"; else if (joinAge === 'child_10_15') roleText = "× ×¢×¨/×” (10-15)"; document.getElementById('register-role-desc').innerText = `××¦×˜×¨×£ ×‘×ª×•×¨: ${roleText}`; }
        async function completeRegistration() { const name = document.getElementById('reg-name').value; const pin = document.getElementById('reg-pin').value; if(!name || !pin || pin.length < 4) return alert('× × ×œ××œ× ×¤×¨×˜×™×'); const btn = document.querySelector('#register-screen button'); btn.innerText = "×™×•×¦×¨..."; try { await fetch(`${API}/create-user`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name, pin, role: joinRole||'child', ageGroup: joinAge||'adult', initialBalance: 0 }) }); alert('× ×•×¦×¨ ×‘×”×¦×œ×—×”!'); window.location.href = window.location.pathname; } catch (e) { alert('×©×’×™××”'); btn.innerText = "× ×¡×” ×©×•×‘"; } }
        function openInviteModal() { document.getElementById('invite-modal').classList.remove('hidden'); }
        function generateInvite(role, ageGroup) { const link = `${window.location.href.split('?')[0]}?join=true&role=${role}&age=${ageGroup}`; let msg = `×”×™×™! ××–××™×Ÿ ××•×ª×š ×œ×”×¦×˜×¨×£ ×œ-FamilyFlow ğŸ \n${link}`; if(role==='child') msg = `×”×™×™! ×”× ×” ×”××¤×œ×™×§×¦×™×” ×œ×“××™ ×”×›×™×¡ ×©×œ×š ğŸ’°\n${link}`; const url = `https://wa.me/?text=${encodeURIComponent(msg)}`; document.getElementById('invite-link-area').classList.remove('hidden'); const btn = document.getElementById('btn-send-whatsapp'); btn.onclick = () => window.open(url, '_blank'); }
        async function loadUsersForLogin() { try { const res = await fetch(`${API}/public-users`); const contentType = res.headers.get("content-type"); if (res.ok && contentType && contentType.includes("text/html")) throw new Error("SERVER_CODE_OUTDATED"); if (!res.ok) throw new Error('Error'); const users = await res.json(); document.getElementById('loading-spinner').classList.add('hidden'); document.getElementById('users-grid').classList.remove('hidden'); const grid = document.getElementById('users-grid'); grid.innerHTML = ''; users.forEach(u => { const color = u.role === 'parent' ? 'bg-blue-100 text-blue-600' : (u.age_group==='child_6_10'?'bg-green-100 text-green-600':'bg-purple-100 text-purple-600'); const icon = u.role === 'parent' ? '<i class="fa-solid fa-user-tie"></i>' : '<i class="fa-solid fa-child"></i>'; grid.innerHTML += `<div onclick="promptPin(${u.id}, '${u.name}', '${u.role}')" class="flex flex-col items-center cursor-pointer group hover:scale-105 transition"><div class="w-24 h-24 ${color} rounded-full flex items-center justify-center mb-3 shadow-sm text-3xl group-hover:shadow-md transition">${icon}</div><span class="font-bold text-gray-700 text-lg">${u.name}</span></div>`; }); } catch (error) { document.getElementById('loading-spinner').classList.add('hidden'); document.getElementById('connection-error').classList.remove('hidden'); if (error.message === "SERVER_CODE_OUTDATED") alert("× × ×œ×¢×“×›×Ÿ ××ª server.js"); } }
        function promptPin(id, name, role) { selectedUserIdForLogin = id; document.getElementById('pin-user-name').innerText = `×”×™×™ ${name}`; document.getElementById('pin-user-icon').innerHTML = role==='parent'?'<i class="fa-solid fa-user-tie"></i>':'<i class="fa-solid fa-child"></i>'; document.getElementById('pin-modal').classList.remove('hidden'); document.getElementById('pin-input').value = ''; document.getElementById('pin-input').focus(); }
        function closePinModal() { document.getElementById('pin-modal').classList.add('hidden'); selectedUserIdForLogin = null; }
        async function login() { const pin = document.getElementById('pin-input').value; if (!pin) return; try { const res = await fetch(`${API}/login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({userId: selectedUserIdForLogin, pin}) }); const data = await res.json(); if (data.success) { currentUser = data.user; document.getElementById('pin-modal').classList.add('hidden'); document.getElementById('user-select-screen').classList.add('hidden'); document.getElementById('dashboard').classList.remove('hidden'); loadDashboard(); } else { document.getElementById('error-msg').classList.remove('hidden'); } } catch (e) { alert('×©×’×™××”'); } }
        function renderFamily(members) { const famList = document.getElementById('family-list'); const bankList = document.getElementById('bank-accounts-list'); const tSel = document.getElementById('task-assignee'); const uSel = document.getElementById('t-user-select'); famList.innerHTML = ''; bankList.innerHTML = ''; tSel.innerHTML = ''; uSel.innerHTML = ''; members.forEach(m => { famList.innerHTML += `<div class="flex-shrink-0 text-center bg-white p-3 rounded-2xl border w-24 shadow-sm"><div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-2 text-blue-600 font-bold text-xl">${m.name[0]}</div><p class="font-bold text-sm truncate">${m.name}</p><p class="text-xs text-gray-500">â‚ª${m.balance}</p></div>`; if(m.role==='child') { tSel.innerHTML += `<option value="${m.id}">${m.name}</option>`; uSel.innerHTML += `<option value="${m.id}">${m.name}</option>`; bankList.innerHTML += `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center"><div><div class="font-bold text-gray-800">${m.name}</div><div class="text-xs text-gray-500">×“××™ ×›×™×¡: â‚ª${m.weekly_allowance||0} | ×¨×™×‘×™×ª: ${m.interest_rate||0}%</div></div><button onclick="openBankSettings(${m.id}, '${m.name}', ${m.weekly_allowance||0}, ${m.interest_rate||0})" class="text-purple-600 bg-purple-50 p-2 rounded-lg text-sm font-bold">×¢×¨×•×š</button></div>`; } else { uSel.innerHTML += `<option value="${m.id}">${m.name}</option>`; } }); }
        function openBankSettings(id, name, allowance, interest) { document.getElementById('bank-settings-id').value = id; document.getElementById('bank-settings-name').innerText = `×”×’×“×¨×•×ª ×¢×‘×•×¨ ${name}`; document.getElementById('bank-allowance').value = allowance; document.getElementById('bank-interest').value = interest; document.getElementById('bank-settings-modal').classList.remove('hidden'); }
        async function saveBankSettings() { const id = document.getElementById('bank-settings-id').value; const allowance = document.getElementById('bank-allowance').value; const interest = document.getElementById('bank-interest').value; await fetch(`${API}/bank/settings`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({userId: id, allowance, interest})}); document.getElementById('bank-settings-modal').classList.add('hidden'); loadDashboard(); }
        function renderLoans(loans) { const list = document.getElementById('loans-list'); list.innerHTML = ''; if (!loans || loans.length === 0) { document.getElementById('no-loans-msg').classList.remove('hidden'); return; } document.getElementById('no-loans-msg').classList.add('hidden'); loans.forEach(l => { let statusBadge = ''; let action = ''; if (l.status === 'pending') { statusBadge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold">×××ª×™×Ÿ ×œ××™×©×•×¨</span>'; if (currentUser.role === 'parent') { action = `<button onclick="openApproveLoan(${l.id}, '${l.user_name}', ${l.original_amount})" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm shadow">×˜×¤×œ</button>`; } } else if (l.status === 'active') { statusBadge = '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">×¤×¢×™×œ</span>'; if (currentUser.id == l.user_id) { action = `<button onclick="repayLoan(${l.id}, ${l.remaining_amount})" class="bg-green-600 text-white px-3 py-1 rounded text-sm shadow">×¡×’×•×¨ ×—×•×‘ (â‚ª${l.remaining_amount})</button>`; } else { action = `<span class="text-xs text-gray-400">× ×•×ª×¨: â‚ª${l.remaining_amount}</span>`; } } else if (l.status === 'rejected') { statusBadge = '<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">× ×“×—×”</span>'; } list.innerHTML += `<div class="card p-4 border border-indigo-50 animate-item"><div class="flex justify-between items-start mb-2"><div><h4 class="font-bold text-gray-800">${l.reason} <span class="text-xs font-normal text-gray-500">(${l.user_name})</span></h4><div class="text-xs text-gray-500">×¡×›×•× ××§×•×¨×™: â‚ª${l.original_amount} ${l.interest_rate > 0 ? `(+${l.interest_rate}% ×¨×™×‘×™×ª)` : ''}</div></div>${statusBadge}</div><div class="flex justify-between items-center mt-2">${action}</div></div>`; }); }
        function openLoanModal() { document.getElementById('loan-modal').classList.remove('hidden'); }
        async function submitLoanRequest() { const amount = document.getElementById('loan-amount').value; const reason = document.getElementById('loan-reason').value; if(!amount || !reason) return alert('×—×¡×¨×™× ×¤×¨×˜×™×'); await fetch(`${API}/loans/request`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:currentUser.id, amount, reason})}); document.getElementById('loan-modal').classList.add('hidden'); loadDashboard(); }
        function openApproveLoan(id, name, amount) { document.getElementById('approve-loan-id').value = id; document.getElementById('approve-loan-desc').innerText = `${name} ××‘×§×©/×ª â‚ª${amount}`; document.getElementById('approve-loan-interest').value = 0; document.getElementById('approve-loan-modal').classList.remove('hidden'); }
        async function handleLoan(status) { const id = document.getElementById('approve-loan-id').value; const interest = document.getElementById('approve-loan-interest').value; await fetch(`${API}/loans/handle`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({loanId:id, status, interestRate:interest})}); document.getElementById('approve-loan-modal').classList.add('hidden'); loadDashboard(); }
        async function repayLoan(id, amount) { if(!confirm(`×”×× ×œ×”×—×–×™×¨ â‚ª${amount} ××”×™×ª×¨×” ×©×œ×š?`)) return; const res = await fetch(`${API}/loans/repay`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({loanId:id, amount, userId:currentUser.id})}); const data = await res.json(); if(!data.success) alert(data.message); else { triggerConfetti(); loadDashboard(); } }
        function renderTasks(tasks) { const list=document.getElementById('tasks-list'); list.innerHTML=''; if(tasks.length===0)document.getElementById('no-tasks-msg').classList.remove('hidden'); else {document.getElementById('no-tasks-msg').classList.add('hidden'); tasks.forEach(task=>{let action=currentUser.role==='child'&&task.status==='pending'?`<button onclick="updateTask(${task.id},'done')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow hover:bg-blue-700 transition">×¡×™×™××ª×™</button>`:(currentUser.role==='parent'&&task.status==='done'?`<button onclick="updateTask(${task.id},'approved')" class="bg-green-500 text-white px-4 py-2 rounded-xl text-xs font-bold shadow hover:bg-green-600 transition">××©×¨</button>`:`<span class="text-xs text-gray-400 font-bold bg-gray-100 px-2 py-1 rounded">${task.status==='done'?'×××ª×™×Ÿ':'×‘×ª×”×œ×™×š'}</span>`); list.innerHTML+=`<div class="card p-4 flex justify-between items-center animate-item border border-gray-50"><div><p class="font-bold text-gray-800">${task.title} <span class="text-yellow-600 text-xs bg-yellow-50 px-2 py-0.5 rounded-md border border-yellow-100 font-bold">â‚ª${task.reward}</span></p><p class="text-xs text-gray-400 mt-1">${task.assignee_name}</p></div><div>${action}</div></div>`;});} }
        function renderShoppingList(items) { const pList=document.getElementById('shopping-pending-list'); const aList=document.getElementById('shopping-active-list'); pList.innerHTML=''; aList.innerHTML=''; let hasP=false; items.forEach(i=>{ if(i.status==='pending'){hasP=true; pList.innerHTML+=`<div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl text-sm border border-gray-100"><span>${i.item_name} <span class="text-xs text-gray-400">(${i.requester_name})</span></span>${currentUser.role==='parent'?`<button onclick="updShop(${i.id},'approved')" class="text-green-600 bg-green-50 p-1.5 rounded-lg hover:bg-green-100 transition"><i class="fa-solid fa-check"></i></button>`:''}</div>`;} else if(i.status!=='bought'){const chk=currentUser.role==='parent'?`<input type="checkbox" onchange="updShop(${i.id},this.checked?'in_cart':'approved')" class="shop-check w-5 h-5 accent-pink-500 rounded-md cursor-pointer" ${i.status==='in_cart'?'checked':''}>`:'<span class="text-pink-500 text-xs">â—</span>'; aList.innerHTML+=`<div class="flex gap-3 p-3 border-b last:border-0 border-gray-50 animate-item items-center">${chk}<div class="${i.status==='in_cart'?'line-through text-gray-300':'font-medium text-gray-700'}">${i.item_name}</div></div>`;} }); document.getElementById('shopping-pending-area').classList.toggle('hidden', !hasP); }
        function renderTransactions(trans) { const l=document.getElementById('transactions-list'); l.innerHTML=''; trans.forEach(t=>{const inc=t.type==='income'; const d=new Date(t.date); const dS=d.toLocaleDateString('he-IL',{day:'numeric',month:'numeric'}); const isF=d>new Date(); const fB=isF?'<span class="text-[10px] bg-gray-100 px-1 rounded ml-1">×¢×ª×™×“×™</span>':''; l.innerHTML+=`<div class="card p-4 flex justify-between items-center animate-item border-r-4 ${inc?'border-green-400':'border-red-400'} shadow-sm ${isF?'opacity-70 bg-gray-50':''}"><div><p class="font-bold text-gray-800">${t.description} ${fB}</p><p class="text-xs text-gray-400 mt-0.5">${dS} â€¢ ${t.user_name||''}</p></div><span class="${inc?'text-green-600':'text-red-600'} font-bold text-lg tracking-tight">${inc?'+':'-'}â‚ª${t.amount}</span></div>`;}); }
        function renderBudget(budgets) { const list = document.getElementById('budget-bars'); list.innerHTML = ''; const labels = { 'general': '×›×œ×œ×™', 'food': '××•×›×œ', 'toys': '×¦×¢×¦×•×¢×™×', 'clothes': '×‘×’×“×™×', 'entertainment': '×‘×™×œ×•×™×™×', 'transport': '× ×¡×™×¢×•×ª', 'groceries': '×¡×•×¤×¨ ×•×‘×™×ª', 'savings': '×—×™×¡×›×•×Ÿ' }; budgets.forEach(b => { const label = labels[b.category] || b.category; const percent = b.limit > 0 ? Math.min(100, (b.spent / b.limit) * 100) : 0; let color = 'bg-teal-500'; if(percent > 80) color = 'bg-yellow-500'; if(percent >= 100) color = 'bg-red-500'; list.innerHTML += `<div onclick="openEditBudget('${b.category}', ${b.limit}, '${label}')" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 transition"><div class="flex justify-between items-end mb-2"><span class="font-bold text-gray-700">${label}</span><span class="text-xs font-bold ${percent>=100?'text-red-500':'text-gray-500'}">â‚ª${b.spent} / â‚ª${b.limit}</span></div><div class="w-full bg-gray-100 rounded-full h-3"><div class="${color} h-3 rounded-full progress-bar" style="width: ${percent}%"></div></div></div>`; }); }
        async function loadBudget() { const res = await fetch(`${API}/budget/status`); const data = await res.json(); renderBudget(data); }
        function openEditBudget(cat, limit, label) { document.getElementById('edit-budget-cat').value = cat; document.getElementById('edit-budget-cat-name').innerText = label; document.getElementById('edit-budget-limit').value = limit; document.getElementById('edit-budget-modal').classList.remove('hidden'); }
        async function saveBudgetLimit() { const cat = document.getElementById('edit-budget-cat').value; const limit = document.getElementById('edit-budget-limit').value; await fetch(`${API}/budget/set`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({category:cat, limit})}); document.getElementById('edit-budget-modal').classList.add('hidden'); loadBudget(); }
        
        async function updateTask(id,s){await fetch(`${API}/tasks/update`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({taskId:id,status:s})}); if(s==='done') triggerConfetti(); loadDashboard();}
        async function submitShopItem(){const n=document.getElementById('shop-item-name').value; if(!n)return; await fetch(`${API}/shopping/add`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({itemName:n,userId:currentUser.id})}); document.getElementById('shopping-modal').classList.add('hidden'); loadDashboard();}
        async function updShop(id,s){await fetch(`${API}/shopping/update`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({itemId:id,status:s})}); loadDashboard();}
        async function submitCheckout(){const a=document.getElementById('checkout-amount').value; if(!a)return; await fetch(`${API}/shopping/checkout`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({totalAmount:a,userId:currentUser.id})}); document.getElementById('checkout-modal').classList.add('hidden'); loadDashboard();}
        function openTaskModal(){document.getElementById('task-modal').classList.remove('hidden');}
        function openShoppingModal(){document.getElementById('shopping-modal').classList.remove('hidden');}
        function openCheckoutModal(){document.getElementById('checkout-modal').classList.remove('hidden');}
        function openGoalModal(){document.getElementById('goal-modal').classList.remove('hidden');}
        function closeModal(){document.getElementById('transaction-modal').classList.add('hidden');}
        async function submitTransaction(){const a=document.getElementById('t-amount').value,d=document.getElementById('t-desc').value,cat=document.getElementById('t-category').value,date=document.getElementById('t-date').value; const u=currentUser.role==='parent'?document.getElementById('t-user-select').value:currentUser.id; if(!a)return alert('×—×¡×¨ ×¡×›×•×'); await fetch(`${API}/transaction`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:u,amount:a,description:d,category:cat,type:currentType, date:date})}); closeModal(); loadDashboard();}
        function logout(){location.reload();}
    </script>
</body>
</html>
