<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); }
        .modal { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .animate-item { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .nav-tab.active { background-color: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
        #product-suggestions { max-height: 250px; overflow-y: auto; }
        .item-in-cart { background-color: #f0fdf4 !important; border-color: #bbf7d0 !important; }
        .item-in-cart .item-text { text-decoration: line-through; color: #86efac; }
        .badge-math { background: #dbeafe; color: #1e40af; }
        .badge-reading { background: #fce7f3; color: #9d174d; }
        .badge-finance { background: #dcfce7; color: #166534; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 bg-gray-50">

    <!-- ××¡×š ×˜×¢×™× ×” -->
    <div id="user-select-screen" class="w-full max-w-2xl text-center">
        <h1 class="text-5xl font-black text-gray-800 mb-2 tracking-tight">FamilyFlow</h1>
        <div id="loading-spinner" class="mb-8"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-600"></i><p class="mt-2 text-sm text-gray-400">×˜×•×¢×Ÿ...</p></div>
        <div id="users-grid" class="grid grid-cols-2 md:grid-cols-3 gap-8 justify-center hidden"></div>
        <div id="connection-error" class="hidden text-red-500 mt-8">×©×’×™××ª ×—×™×‘×•×¨. <button onclick="location.reload()" class="underline font-bold">× ×¡×” ×©×•×‘</button></div>
        <div id="server-config" class="mt-12 text-xs text-gray-300"><button onclick="document.getElementById('manual-server-input').classList.toggle('hidden')">×”×’×“×¨×•×ª ×©×¨×ª</button><div id="manual-server-input" class="hidden mt-2"><input type="text" id="custom-app-name" placeholder="App Name" class="border p-1 rounded text-center"><button onclick="saveAppNameAndRetry()" class="bg-gray-200 px-2 py-1 rounded ml-1">×©××•×¨</button></div></div>
        <button onclick="initRegisterMode()" class="mt-8 text-gray-400 font-bold hover:text-blue-600 underline hidden" id="btn-new-account">×¤×ª×™×—×ª ×—×©×‘×•×Ÿ ×—×“×©</button>
    </div>

    <!-- ××¡×š ×”×¨×©××” -->
    <div id="register-screen" class="hidden w-full max-w-md card p-8 text-center animate-item">
        <div class="mb-6 text-green-500 text-6xl"><i class="fa-solid fa-gift animate-bounce"></i></div>
        <h2 class="text-3xl font-black text-gray-800 mb-2">×‘×¨×•×›×™× ×”×‘××™×!</h2>
        <p id="register-role-desc" class="text-gray-500 mb-6 text-lg">×‘×•××• × ×¤×ª×— ×œ×›× ×—×©×‘×•×Ÿ</p>
        <input type="text" id="reg-name" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-3 text-lg" placeholder="×©× ×¤×¨×˜×™">
        <select id="reg-role" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-3 text-lg bg-white" onchange="toggleBirthYear()"><option value="child">×™×œ×“/×”</option><option value="parent">×”×•×¨×”</option></select>
        <div id="birth-year-container"><input type="number" id="reg-year" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-3 text-lg" placeholder="×©× ×ª ×œ×™×“×” (×œ××©×œ: 2015)"></div>
        <input type="password" id="reg-pin" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-6 text-center text-xl tracking-[0.5em]" placeholder="****" maxlength="4">
        <button onclick="completeRegistration()" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-2xl font-bold shadow-lg text-lg">×™×¦×™×¨×ª ×—×©×‘×•×Ÿ</button>
        <button onclick="location.reload()" class="mt-4 text-gray-400 font-bold">×‘×™×˜×•×œ</button>
    </div>

    <!-- ××•×“×œ PIN -->
    <div id="pin-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-xs rounded-3xl p-8 shadow-2xl text-center"><div id="pin-user-icon" class="w-20 h-20 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl"></div><h3 id="pin-user-name" class="text-2xl font-bold mb-6 text-gray-800"></h3><input type="password" id="pin-input" class="w-full p-4 text-center text-3xl border-2 border-gray-200 rounded-2xl mb-6 focus:border-blue-500 outline-none tracking-[0.5em]" placeholder="****" maxlength="4"><div class="flex gap-3"><button onclick="closePinModal()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600">×‘×™×˜×•×œ</button><button onclick="login()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">×›× ×¡</button></div><p id="error-msg" class="text-red-500 mt-4 hidden text-sm font-bold">×§×•×“ ×©×’×•×™</p></div></div>

    <!-- ×“×©×‘×•×¨×“ -->
    <div id="dashboard" class="hidden w-full max-w-md pb-32 relative">
        <!-- ×¡×¨×’×œ Spy Mode -->
        <div id="spy-mode-bar" class="hidden bg-orange-500 text-white text-center py-2 px-4 font-bold sticky top-0 z-30 flex justify-between items-center shadow-md rounded-b-xl mb-[-20px]">
            <span>ğŸ‘ï¸ ×¦×•×¤×” ×›-<span id="spy-child-name"></span></span>
            <button onclick="exitSpyMode()" class="bg-white/20 px-2 py-1 rounded text-xs hover:bg-white/40">×—×–×•×¨ ×œ×”×•×¨×”</button>
        </div>

        <header class="flex justify-between items-center mb-6 p-4 sticky top-0 bg-[#f8fafc]/90 backdrop-blur-sm z-10 pt-8">
            <div onclick="openEditProfileModal()" class="cursor-pointer group">
                <h2 id="user-name" class="text-3xl font-black text-gray-800 tracking-tight group-hover:text-blue-600 transition"></h2>
                <div class="flex items-center gap-2 mt-1">
                    <span id="user-role" class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded-full"></span>
                    <i class="fa-solid fa-pen text-[10px] text-gray-300 group-hover:text-gray-500"></i>
                </div>
            </div>
            <div class="flex gap-3"><button onclick="openInviteModal()" id="btn-invite" class="hidden w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-blue-600 hover:bg-blue-50"><i class="fa-solid fa-user-plus"></i></button><button onclick="logout()" class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-gray-400 hover:text-red-500"><i class="fa-solid fa-right-from-bracket"></i></button></div>
        </header>

        <div class="mx-4 mb-8">
            <div class="card p-8 text-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white shadow-xl">
                <p class="text-blue-100 text-sm font-medium mb-1">×™×ª×¨×” × ×•×›×—×™×ª</p>
                <h1 id="balance" class="text-6xl font-black tracking-tighter mb-2">â‚ª0</h1>
                <div id="bank-info-child" class="hidden mt-4 flex justify-center gap-4 text-xs bg-white/10 p-2 rounded-xl backdrop-blur-md">
                    <div class="px-2 border-l border-white/20"><span class="block opacity-70">×“××™ ×›×™×¡</span><span class="font-bold text-lg" id="info-allowance">â‚ª0</span></div>
                    <div class="px-2 border-l border-white/20"><span class="block opacity-70">×¨×™×‘×™×ª</span><span class="font-bold text-lg" id="info-interest">0%</span></div>
                    <div class="px-2"><span class="block opacity-70">XP</span><span class="font-bold text-lg" id="info-xp">0</span></div>
                </div>
            </div>
        </div>

        <div class="mx-4 mb-6 bg-white p-1.5 rounded-2xl shadow-sm flex overflow-x-auto gap-1 no-scrollbar">
            <button onclick="switchTab('tasks')" id="tab-tasks" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap text-gray-500">××©×™××•×ª</button>
            <button onclick="switchTab('shopping')" id="tab-shopping" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap text-gray-500">×§× ×™×•×ª ğŸ›’</button>
            <button onclick="switchTab('academy')" id="tab-academy" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap text-gray-500">××§×“××™×”</button>
            <button onclick="switchTab('goals')" id="tab-goals" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap text-gray-500">×™×¢×“×™×</button>
            <button onclick="switchTab('budget')" id="tab-budget" class="nav-tab hidden flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap bg-teal-50 text-teal-700 border border-teal-100">×ª×§×¦×™×‘</button>
            <button onclick="switchTab('loans')" id="tab-loans" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap text-gray-500">×”×œ×•×•××•×ª</button>
            <button onclick="switchTab('bank')" id="tab-bank" class="nav-tab hidden flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap bg-purple-50 text-purple-700 border border-purple-100">×”×‘× ×§</button>
            <button onclick="switchTab('family')" id="tab-family" class="nav-tab hidden flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap text-gray-500">××©×¤×—×”</button>
        </div>

        <div id="section-shopping" class="mx-4 mb-8 hidden">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 text-xl">×¡×•×¤×¨</h3><div class="flex gap-2"><button onclick="openHistoryModal()" class="text-sm bg-gray-100 text-gray-700 px-3 py-2 rounded-full font-bold shadow-sm hover:bg-gray-200"><i class="fa-solid fa-clock-rotate-left"></i> ×”×™×¡×˜×•×¨×™×”</button><button onclick="openShoppingModal()" class="text-sm bg-pink-100 text-pink-700 px-4 py-2 rounded-full font-bold shadow-sm hover:bg-pink-200">+ ×¤×¨×™×˜</button></div></div>
            <div class="bg-white p-3 rounded-xl shadow-sm mb-4 flex items-center gap-2 border border-gray-100"><i class="fa-solid fa-store text-pink-500"></i><input type="text" id="store-name-input" class="w-full outline-none text-sm" placeholder="××™×¤×” ×§×•× ×™× ×”×™×•×? (×œ××©×œ: ×¨××™ ×œ×•×™)"></div>
            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 px-1">×¨×©×™××” ×œ×§× ×™×™×”</h4><div id="shopping-active-list" class="space-y-2 mb-20"></div>
            <div class="fixed bottom-0 left-0 w-full bg-white p-4 shadow-[0_-5px_20px_rgba(0,0,0,0.1)] rounded-t-3xl z-20"><div class="flex justify-between items-center mb-3"><span class="text-gray-500 text-sm">×¡×”"×› ×‘×¢×’×œ×”:</span><span id="live-cart-total" class="text-2xl font-black text-gray-800">â‚ª0.00</span></div><button onclick="checkout()" class="w-full bg-pink-600 text-white py-3 rounded-xl font-bold shadow-lg transform active:scale-95 transition flex justify-center gap-2"><i class="fa-solid fa-cash-register"></i> ×¡×™×•× ×§× ×™×™×”</button></div>
        </div>

        <div id="section-academy" class="mx-4 mb-8 hidden">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 text-xl">×”××§×“××™×”</h3><div class="text-xs bg-gray-200 px-2 py-1 rounded text-gray-600" id="user-age-display"></div></div>
            <div id="assigned-quizzes-container" class="hidden mb-6"><h4 class="text-sm font-bold text-orange-600 mb-2 border-b border-orange-100 pb-1">ğŸŒŸ ××©×™××•×ª ×××‘×/×××</h4><div id="assigned-list" class="space-y-3"></div></div>
            <h4 class="text-sm font-bold text-gray-500 mb-2">××ª×’×¨×™× ×–××™× ×™×</h4><div id="academy-list" class="grid grid-cols-1 gap-4 pb-20"></div>
        </div>

        <div id="section-family" class="mx-4 mb-8 hidden"><h3 class="font-bold text-gray-800 text-xl mb-4">× ×™×”×•×œ ×”×™×œ×“×™×</h3><div id="family-list-manage" class="space-y-3 pb-20"></div></div>
        <div id="section-tasks" class="mx-4 mb-8 hidden"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 text-xl">××©×™××•×ª</h3><button id="btn-add-task" onclick="openTaskModal()" class="hidden text-sm bg-purple-100 text-purple-700 px-4 py-2 rounded-full font-bold">+ ××©×™××”</button></div><div id="tasks-list" class="space-y-3"></div></div>
        <div id="section-goals" class="mx-4 mb-8 hidden"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 text-xl">×”×™×¢×“×™× ×©×œ×™</h3><button onclick="openGoalModal()" class="text-sm bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full font-bold">+ ×—×“×©</button></div><div id="goals-list" class="space-y-4"></div></div>
        <div id="section-budget" class="mx-4 mb-8 hidden"><h3 class="font-bold text-gray-800 text-xl mb-4">×ª×§×¦×™×‘ ×—×•×“×©×™</h3><div id="budget-bars" class="space-y-4"></div></div>
        <div id="section-loans" class="mx-4 mb-8 hidden"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 text-xl">×”×œ×•×•××•×ª ×•××©×¨××™</h3><button onclick="openLoanModal()" class="text-sm bg-indigo-100 text-indigo-700 px-4 py-2 rounded-full font-bold">+ ×‘×§×© ×”×œ×•×•××”</button></div><div id="loans-list" class="space-y-4"></div></div>
        <div id="section-bank" class="mx-4 mb-8 hidden"><div class="bg-gradient-to-r from-purple-600 to-indigo
