<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyFlow - Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .modal { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .animate-item { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 bg-gray-50">

    <div id="user-select-screen" class="w-full max-w-2xl text-center">
        <h1 class="text-5xl font-black text-gray-800 mb-2 tracking-tight">FamilyFlow</h1>
        <p class="text-gray-400 mb-8"> 1:  砖转砖</p>
        
        <div id="loading-spinner" class="mb-8"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-600"></i><p class="mt-2 text-sm text-gray-400">注 砖转砖...</p></div>
        
        <div id="users-grid" class="grid grid-cols-2 md:grid-cols-3 gap-8 justify-center hidden mb-10"></div>
        
        <button onclick="initRegisterMode()" id="btn-new-account" class="hidden mt-4 bg-blue-600 text-white px-6 py-3 rounded-full font-bold shadow hover:bg-blue-700 transition">
            <i class="fa-solid fa-plus ml-2"></i> 驻转转 砖 砖
        </button>

        <div class="mt-16 border-t pt-6 flex justify-center gap-4">
            <button onclick="factoryReset()" class="text-xs text-red-500 border border-red-200 px-4 py-2 rounded-lg hover:bg-red-50 transition flex items-center gap-2">
                <i class="fa-solid fa-trash"></i> 驻住 转 (拽转 )
            </button>
            <button onclick="runSetupDB()" class="text-xs text-green-600 border border-green-200 px-4 py-2 rounded-lg hover:bg-green-50 transition flex items-center gap-2">
                <i class="fa-solid fa-database"></i> 转拽转 DB (Setup)
            </button>
        </div>
    </div>

    <div id="register-screen" class="hidden w-full max-w-md card p-8 text-center animate-item">
        <div class="mb-6 text-green-500 text-6xl"><i class="fa-solid fa-gift animate-bounce"></i></div>
        <h2 class="text-3xl font-black text-gray-800 mb-2">专 !</h2>
        <p class="text-gray-500 mb-6 text-lg">爪专转 砖转砖 砖</p>
        
        <input type="text" id="reg-name" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-3 text-lg" placeholder="砖 驻专">
        <select id="reg-role" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-3 text-lg bg-white">
            <option value="parent">专 ()</option>
            <option value="child">/</option>
        </select>
        <input type="number" id="reg-year" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-3 text-lg" placeholder="砖转  (砖: 2015)">
        <input type="password" id="reg-pin" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-6 text-center text-xl tracking-[0.5em]" placeholder="拽 住 (4 住驻专转)" maxlength="4">
        
        <button onclick="completeRegistration()" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-2xl font-bold shadow-lg text-lg">爪专 砖</button>
        <button onclick="location.reload()" class="mt-4 text-gray-400 font-bold"></button>
    </div>

    <div id="pin-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white w-full max-w-xs rounded-3xl p-8 shadow-2xl text-center">
            <div id="pin-user-icon" class="w-20 h-20 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl"></div>
            <h3 id="pin-user-name" class="text-2xl font-bold mb-6 text-gray-800"></h3>
            <input type="password" id="pin-input" class="w-full p-4 text-center text-3xl border-2 border-gray-200 rounded-2xl mb-6 focus:border-blue-500 outline-none tracking-[0.5em]" placeholder="****" maxlength="4">
            <div class="flex gap-3">
                <button onclick="closePinModal()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600"></button>
                <button onclick="login()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">住</button>
            </div>
            <p id="error-msg" class="text-red-500 mt-4 hidden text-sm font-bold">拽 砖</p>
        </div>
    </div>

    <div id="dashboard" class="hidden w-full max-w-md text-center pt-20">
        <div class="text-6xl text-green-500 mb-4"><i class="fa-solid fa-check-circle"></i></div>
        <h2 class="text-3xl font-bold text-gray-800">转专转 爪!</h2>
        <p class="text-xl mt-2 text-gray-600">砖, <span id="user-name-display" class="font-bold"></span></p>
        <div class="mt-8 bg-blue-50 p-4 rounded-xl text-blue-800">
            <p>  砖转砖 注.</p>
            <p class="text-sm mt-2">转 转转拽 拽 砖转砖 住驻.</p>
        </div>
        <button onclick="location.reload()" class="mt-8 bg-gray-800 text-white px-6 py-3 rounded-xl font-bold">转转拽</button>
    </div>

    <script>
        const API = window.location.hostname.includes('onrender.com') ? '/api' : `https://${window.location.hostname}/api`;
        let selectedUserIdForLogin = null;

        // --- Init ---
        window.onload = loadUsers;

        async function loadUsers() {
            try {
                const res = await fetch(`${API}/public-users`);
                const users = await res.json();
                
                document.getElementById('loading-spinner').classList.add('hidden');
                
                if (users.length === 0) {
                    // No users - Show Register Button Prominently
                    document.getElementById('users-grid').innerHTML = '<p class="col-span-3 text-gray-400"> 砖转砖 专砖.<br>抓  驻转转 砖 专砖.</p>';
                    document.getElementById('users-grid').classList.remove('hidden');
                    document.getElementById('btn-new-account').classList.remove('hidden');
                } else {
                    // Show Users
                    const grid = document.getElementById('users-grid');
                    grid.innerHTML = '';
                    users.forEach(u => {
                        const color = u.role === 'parent' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600';
                        const icon = u.role === 'parent' ? '<i class="fa-solid fa-user-tie"></i>' : '<i class="fa-solid fa-child"></i>';
                        grid.innerHTML += `
                            <div onclick="promptPin(${u.id}, '${u.name}', '${u.role}')" class="flex flex-col items-center cursor-pointer group hover:scale-105 transition">
                                <div class="w-24 h-24 ${color} rounded-full flex items-center justify-center mb-3 shadow-sm text-3xl group-hover:shadow-md transition">${icon}</div>
                                <span class="font-bold text-gray-700 text-lg">${u.name}</span>
                            </div>`;
                    });
                    document.getElementById('users-grid').classList.remove('hidden');
                    document.getElementById('btn-new-account').classList.remove('hidden'); // Allow adding more
                }
            } catch (e) {
                alert('砖转 转拽砖专转 注 砖专转');
            }
        }

        // --- Module 1 Functions: System ---
        async function factoryReset() {
            if (!confirm('专转! 锔\n驻注  转拽 转  砖转砖 转.\n 砖?')) return;
            try {
                const res = await fetch(`${API}/admin/reset-data`, { method: 'POST' });
                if (res.ok) {
                    alert('注专转 驻住. 注转 转拽 砖 转 转.');
                    runSetupDB();
                }
            } catch (e) { alert('砖 驻住'); }
        }

        async function runSetupDB() {
            try {
                const res = await fetch('/setup-db');
                const data = await res.json();
                if (data.success) {
                    alert('注专转  砖砖! \n注转 转 爪专 砖转砖 专砖.');
                    location.reload();
                }
            } catch (e) { alert('砖 转拽'); }
        }

        // --- Module 1 Functions: Auth ---
        function initRegisterMode() {
            document.getElementById('user-select-screen').classList.add('hidden');
            document.getElementById('register-screen').classList.remove('hidden');
        }

        async function completeRegistration() {
            const name = document.getElementById('reg-name').value;
            const role = document.getElementById('reg-role').value;
            const year = document.getElementById('reg-year').value;
            const pin = document.getElementById('reg-pin').value;

            if(!name || !year || pin.length < 4) return alert('  转  驻专');

            try {
                await fetch(`${API}/create-user`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, role, birthYear: year, pin })
                });
                alert('砖转砖 爪专 爪!');
                location.reload();
            } catch (e) { alert('砖 爪专转 砖转砖'); }
        }

        function promptPin(id, name, role) {
            selectedUserIdForLogin = id;
            document.getElementById('pin-user-name').innerText = name;
            document.getElementById('pin-user-icon').innerHTML = role==='parent'?'<i class="fa-solid fa-user-tie"></i>':'<i class="fa-solid fa-child"></i>';
            document.getElementById('pin-modal').classList.remove('hidden');
            document.getElementById('pin-input').value = '';
            document.getElementById('pin-input').focus();
        }

        function closePinModal() {
            document.getElementById('pin-modal').classList.add('hidden');
        }

        async function login() {
            const pin = document.getElementById('pin-input').value;
            if (pin.length < 4) return;
            
            try {
                const res = await fetch(`${API}/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ userId: selectedUserIdForLogin, pin })
                });
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('pin-modal').classList.add('hidden');
                    document.getElementById('user-select-screen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    document.getElementById('user-name-display').innerText = data.user.name;
                } else {
                    document.getElementById('error-msg').classList.remove('hidden');
                }
            } catch (e) { alert('砖转 转专转'); }
        }
    </script>
</body>
</html>
