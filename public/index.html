<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); }
        .modal { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .animate-item { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .nav-tab.active { background-color: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
        #product-suggestions { max-height: 250px; overflow-y: auto; }
        /* ×¢×™×¦×•×‘ ×œ×¤×¨×™×˜ ×©× ×™×§× ×” */
        .item-in-cart { background-color: #f0fdf4 !important; border-color: #bbf7d0 !important; }
        .item-in-cart .item-text { text-decoration: line-through; color: #86efac; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 bg-gray-50">

    <!-- ××¡×š ×˜×¢×™× ×” -->
    <div id="user-select-screen" class="w-full max-w-2xl text-center">
        <h1 class="text-5xl font-black text-gray-800 mb-2 tracking-tight">FamilyFlow</h1>
        <div id="loading-spinner" class="mb-8"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-600"></i><p class="mt-2 text-sm text-gray-400">×˜×•×¢×Ÿ...</p></div>
        <div id="users-grid" class="grid grid-cols-2 md:grid-cols-3 gap-8 justify-center hidden"></div>
        <div id="connection-error" class="hidden text-red-500 mt-8">×©×’×™××ª ×—×™×‘×•×¨. <button onclick="location.reload()" class="underline font-bold">× ×¡×” ×©×•×‘</button></div>
        <div id="server-config" class="mt-12 text-xs text-gray-300"><button onclick="document.getElementById('manual-server-input').classList.toggle('hidden')">×”×’×“×¨×•×ª ×©×¨×ª</button><div id="manual-server-input" class="hidden mt-2"><input type="text" id="custom-app-name" placeholder="App Name" class="border p-1 rounded text-center"><button onclick="saveAppNameAndRetry()" class="bg-gray-200 px-2 py-1 rounded ml-1">×©××•×¨</button></div></div>
    </div>

    <!-- ××¡×š ×”×¨×©××” -->
    <div id="register-screen" class="hidden w-full max-w-md card p-8 text-center animate-item">
        <div class="mb-6 text-green-500 text-6xl"><i class="fa-solid fa-gift animate-bounce"></i></div><h2 class="text-3xl font-black text-gray-800 mb-2">×‘×¨×•×›×™× ×”×‘××™×!</h2><p id="register-role-desc" class="text-gray-500 mb-8 text-lg">×‘×•××• × ×¤×ª×— ×œ×›× ×—×©×‘×•×Ÿ</p><input type="text" id="reg-name" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-3 text-lg" placeholder="××™×š ×§×•×¨××™× ×œ×š?"><input type="password" id="reg-pin" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-6 text-center text-xl tracking-[0.5em]" placeholder="****" maxlength="4"><button onclick="completeRegistration()" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-2xl font-bold shadow-lg text-lg">×™×¦×™×¨×ª ×—×©×‘×•×Ÿ</button>
    </div>

    <!-- ××•×“×œ PIN -->
    <div id="pin-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-xs rounded-3xl p-8 shadow-2xl text-center"><div id="pin-user-icon" class="w-20 h-20 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl"></div><h3 id="pin-user-name" class="text-2xl font-bold mb-6 text-gray-800"></h3><input type="password" id="pin-input" class="w-full p-4 text-center text-3xl border-2 border-gray-200 rounded-2xl mb-6 focus:border-blue-500 outline-none tracking-[0.5em]" placeholder="****" maxlength="4"><div class="flex gap-3"><button onclick="closePinModal()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600">×‘×™×˜×•×œ</button><button onclick="login()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">×›× ×¡</button></div><p id="error-msg" class="text-red-500 mt-4 hidden text-sm font-bold">×§×•×“ ×©×’×•×™</p></div></div>

    <!-- ×“×©×‘×•×¨×“ -->
    <div id="dashboard" class="hidden w-full max-w-md pb-32">
        <header class="flex justify-between items-center mb-6 p-4 sticky top-0 bg-[#f8fafc]/90 backdrop-blur-sm z-10">
            <div><h2 id="user-name" class="text-3xl font-black text-gray-800 tracking-tight"></h2><div class="flex items-center gap-2 mt-1"><span id="user-role" class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded-full"></span><span id="user-rank" class="rank-badge hidden"></span></div></div>
            <div class="flex gap-3"><button onclick="openInviteModal()" id="btn-invite" class="hidden w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-blue-600 hover:bg-blue-50"><i class="fa-solid fa-user-plus"></i></button><button onclick="logout()" class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-gray-400 hover:text-red-500"><i class="fa-solid fa-right-from-bracket"></i></button></div>
        </header>

        <!-- ×™×ª×¨×” -->
        <div class="mx-4 mb-8">
            <div class="card p-8 text-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white shadow-xl">
                <p class="text-blue-100 text-sm font-medium mb-1">×™×ª×¨×” × ×•×›×—×™×ª</p>
                <h1 id="balance" class="text-6xl font-black tracking-tighter mb-2">â‚ª0</h1>
                <div id="bank-info-child" class="hidden mt-4 flex justify-center gap-4 text-xs bg-white/10 p-2 rounded-xl backdrop-blur-md">
                    <div class="px-2 border-l border-white/20"><span class="block opacity-70">×“××™ ×›×™×¡</span><span class="font-bold text-lg" id="info-allowance">â‚ª0</span></div>
                    <div class="px-2 border-l border-white/20"><span class="block opacity-70">×¨×™×‘×™×ª</span><span class="font-bold text-lg" id="info-interest">0%</span></div>
                    <div class="px-2"><span class="block opacity-70">XP</span><span class="font-bold text-lg" id="info-xp">0</span></div>
                </div>
            </div>
        </div>

        <!-- ×˜××‘×™× -->
        <div class="mx-4 mb-6 bg-white p-1.5 rounded-2xl shadow-sm flex overflow-x-auto gap-1 no-scrollbar">
            <button onclick="switchTab('tasks')" id="tab-tasks" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap text-gray-500">××©×™××•×ª</button>
            <button onclick="switchTab('shopping')" id="tab-shopping" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap text-gray-500">×§× ×™×•×ª ğŸ›’</button>
            <button onclick="switchTab('academy')" id="tab-academy" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap text-gray-500">××§×“××™×”</button>
            <button onclick="switchTab('goals')" id="tab-goals" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap text-gray-500">×™×¢×“×™×</button>
            <button onclick="switchTab('budget')" id="tab-budget" class="nav-tab hidden flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap bg-teal-50 text-teal-700 border border-teal-100">×ª×§×¦×™×‘</button>
            <button onclick="switchTab('loans')" id="tab-loans" class="nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap text-gray-500">×”×œ×•×•××•×ª</button>
            <button onclick="switchTab('bank')" id="tab-bank" class="nav-tab hidden flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap bg-purple-50 text-purple-700 border border-purple-100">×”×‘× ×§</button>
        </div>

        <!-- ××–×•×¨ ×§× ×™×•×ª (SHOPPING) - ××§×‘×¥ 1 ××©×•×“×¨×’ -->
        <div id="section-shopping" class="mx-4 mb-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-800 text-xl">×¡×•×¤×¨</h3>
                <div class="flex gap-2">
                    <button onclick="openHistoryModal()" class="text-sm bg-gray-100 text-gray-700 px-3 py-2 rounded-full font-bold shadow-sm hover:bg-gray-200"><i class="fa-solid fa-clock-rotate-left"></i> ×”×™×¡×˜×•×¨×™×”</button>
                    <button onclick="openShoppingModal()" class="text-sm bg-pink-100 text-pink-700 px-4 py-2 rounded-full font-bold shadow-sm hover:bg-pink-200">+ ×¤×¨×™×˜</button>
                </div>
            </div>

            <div class="bg-white p-3 rounded-xl shadow-sm mb-4 flex items-center gap-2 border border-gray-100">
                <i class="fa-solid fa-store text-pink-500"></i>
                <input type="text" id="store-name-input" class="w-full outline-none text-sm" placeholder="××™×¤×” ×§×•× ×™× ×”×™×•×? (×œ××©×œ: ×¨××™ ×œ×•×™)">
            </div>

            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 px-1">×¨×©×™××” ×œ×§× ×™×™×”</h4>
            <div id="shopping-active-list" class="space-y-2 mb-20"></div>

            <div class="fixed bottom-0 left-0 w-full bg-white p-4 shadow-[0_-5px_20px_rgba(0,0,0,0.1)] rounded-t-3xl z-20">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-gray-500 text-sm">×¡×”"×› ×‘×¢×’×œ×”:</span>
                    <span id="live-cart-total" class="text-2xl font-black text-gray-800">â‚ª0.00</span>
                </div>
                <button onclick="checkout()" class="w-full bg-pink-600 text-white py-3 rounded-xl font-bold shadow-lg transform active:scale-95 transition flex justify-center gap-2">
                    <i class="fa-solid fa-cash-register"></i> ×¡×™×•× ×§× ×™×™×”
                </button>
            </div>
        </div>

        <!-- ×©××¨ ×”××–×•×¨×™× -->
        <div id="section-tasks" class="mx-4 mb-8 hidden"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 text-xl">××©×™××•×ª</h3><button id="btn-add-task" onclick="openTaskModal()" class="hidden text-sm bg-purple-100 text-purple-700 px-4 py-2 rounded-full font-bold">+ ××©×™××”</button></div><div id="tasks-list" class="space-y-3"></div></div>
        <div id="section-academy" class="mx-4 mb-8 hidden"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 text-xl">×”××§×“××™×” ×”×¤×™× × ×¡×™×ª</h3><button id="btn-add-quiz" onclick="openAddQuizModal()" class="hidden text-sm bg-orange-100 text-orange-700 px-4 py-2 rounded-full font-bold">+ ×—×™×“×•×Ÿ</button></div><div id="academy-list" class="space-y-4"></div><p id="no-quiz-msg" class="text-center text-gray-400 text-sm py-8 bg-white rounded-2xl border border-dashed border-gray-200 hidden">××™×Ÿ ×—×™×“×•× ×™× ×–××™× ×™× ×›×¨×’×¢ ğŸ“š</p></div>
        <div id="section-goals" class="mx-4 mb-8 hidden"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 text-xl">×”×™×¢×“×™× ×©×œ×™</h3><button onclick="openGoalModal()" class="text-sm bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full font-bold">+ ×—×“×©</button></div><div id="goals-list" class="space-y-4"></div></div>
        <div id="section-budget" class="mx-4 mb-8 hidden"><h3 class="font-bold text-gray-800 text-xl mb-4">×ª×§×¦×™×‘ ×—×•×“×©×™</h3><div id="budget-bars" class="space-y-4"></div></div>
        <div id="section-loans" class="mx-4 mb-8 hidden"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 text-xl">×”×œ×•×•××•×ª ×•××©×¨××™</h3><button onclick="openLoanModal()" class="text-sm bg-indigo-100 text-indigo-700 px-4 py-2 rounded-full font-bold">+ ×‘×§×© ×”×œ×•×•××”</button></div><div id="loans-list" class="space-y-4"></div></div>
        <div id="section-bank" class="mx-4 mb-8 hidden"><div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-6 text-white mb-6 shadow-lg"><h3 class="text-xl font-bold mb-1">× ×™×”×•×œ ×”×‘× ×§</h3><button onclick="runPayday()" class="w-full bg-white text-purple-700 font-bold py-3 rounded-xl shadow mt-4">×”×¤×¢×œ ×™×•× ×ª×©×œ×•× (PayDay)</button></div><h4 class="font-bold text-gray-800 mb-3 px-1">×—×©×‘×•× ×•×ª ×™×œ×“×™×</h4><div id="bank-accounts-list" class="space-y-3"></div></div>

        <!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” ×¦×¤×™× -->
        <div id="floating-actions" class="fixed bottom-6 left-0 w-full px-4 pointer-events-none"><div class="max-w-md mx-auto grid grid-cols-2 gap-4 pointer-events-auto"><button onclick="openModal('income')" class="bg-white/90 backdrop-blur border border-green-100 text-green-700 p-4 rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2"><i class="fa-solid fa-circle-plus text-xl"></i> ×”×›× ×¡×”</button><button onclick="openModal('expense')" class="bg-white/90 backdrop-blur border border-red-100 text-red-700 p-4 rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2"><i class="fa-solid fa-circle-minus text-xl"></i> ×”×•×¦××”</button></div></div>
        
        <div id="family-section" class="mx-4 mb-8 hidden mt-8 pt-8 border-t border-gray-200"><h3 class="font-bold text-gray-800 text-lg mb-4">×‘× ×™ ×”××©×¤×—×”</h3><div id="family-list" class="flex gap-4 overflow-x-auto pb-4 no-scrollbar"></div></div>
        <div class="mx-4 pb-20"><h3 class="font-bold text-gray-800 text-lg mb-4">×¤×¢×™×œ×•×ª ××—×¨×•× ×”</h3><div id="transactions-list" class="space-y-3"></div></div>
    </div>

    <!-- ××•×“×œ×™× -->
    <div id="history-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col">
            <h3 class="text-xl font-bold mb-4 text-center text-gray-800">×”×™×¡×˜×•×¨×™×™×ª ×§× ×™×•×ª</h3>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-3"></div>
            <button onclick="document.getElementById('history-modal').classList.add('hidden')" class="w-full py-3 bg-gray-100 font-bold rounded-xl mt-4">×¡×’×•×¨</button>
        </div>
    </div>
    
    <div id="shopping-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-visible"><h3 class="text-xl font-bold mb-4 text-center text-pink-600">×”×•×¡×¤×” ×œ×¡×•×¤×¨ ğŸ›’</h3><div class="relative"><input type="text" id="shop-item-name" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-2 text-lg focus:border-pink-500 outline-none" placeholder="×—×¤×© ××•×¦×¨ (×œ××©×œ: ×—×œ×‘)..." oninput="searchProducts(this.value)" onfocus="searchProducts(this.value)" autocomplete="off"><div id="product-suggestions" class="hidden absolute w-full bg-white border border-gray-100 rounded-xl shadow-lg z-50 top-full mt-1"></div></div><div class="flex gap-3 mt-4"><button onclick="document.getElementById('shopping-modal').classList.add('hidden')" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">×‘×™×˜×•×œ</button><button onclick="submitShopItem()" class="flex-1 py-3 bg-pink-600 text-white rounded-xl font-bold shadow-lg">×”×•×¡×£</button></div></div></div>
    <div id="edit-budget-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center text-teal-600">×¢×¨×™×›×ª ×ª×§×¦×™×‘</h3><p id="edit-budget-cat-name" class="text-center text-gray-600 mb-4"></p><input type="hidden" id="edit-budget-cat"><label class="block text-xs font-bold text-gray-500 mb-1">×ª×§×¨×” ×—×•×“×©×™×ª (â‚ª)</label><input type="number" id="edit-budget-limit" class="w-full p-4 border-2 rounded-2xl mb-6 text-xl font-bold text-center" placeholder="0"><div class="flex gap-3"><button onclick="document.getElementById('edit-budget-modal').classList.add('hidden')" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">×‘×™×˜×•×œ</button><button onclick="saveBudgetLimit()" class="flex-1 py-3 bg-teal-600 text-white rounded-xl font-bold">×©××•×¨</button></div></div></div>
    <div id="invite-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center text-blue-600">×”×–×× ×”</h3><div class="space-y-3 mb-6"><button onclick="generateInvite('parent','adult')" class="w-full text-right p-4 border rounded-2xl">×‘×Ÿ/×‘×ª ×–×•×’</button><button onclick="generateInvite('child','child_6_10')" class="w-full text-right p-4 border rounded-2xl">×™×œ×“ (6-10)</button><button onclick="generateInvite('child','child_10_15')" class="w-full text-right p-4 border rounded-2xl">× ×¢×¨ (10-15)</button></div><div id="invite-link-area" class="hidden bg-blue-50 p-4 rounded-2xl mb-4 text-center"><button id="btn-send-whatsapp" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold">×©×œ×— ×‘×•×•×¦××¤</button></div><button onclick="document.getElementById('invite-modal').classList.add('hidden');" class="w-full py-3 bg-gray-100 font-bold rounded-xl">×¡×’×•×¨</button></div></div>
    <div id="loan-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center text-indigo-600">×‘×§×©×ª ×”×œ×•×•××”</h3><input type="number" id="loan-amount" class="w-full p-3 border rounded-xl mb-3" placeholder="×›××” ×¦×¨×™×š?"><input type="text" id="loan-reason" class="w-full p-3 border rounded-xl mb-6" placeholder="×œ××”?"><div class="flex gap-3"><button onclick="document.getElementById('loan-modal').classList.add('hidden')" class="flex-1 bg-gray-100 rounded-xl font-bold">×‘×™×˜×•×œ</button><button onclick="submitLoanRequest()" class="flex-1 bg-indigo-600 text-white rounded-xl font-bold">×©×œ×— ×‘×§×©×”</button></div></div></div>
    <div id="approve-loan-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-2 text-center text-indigo-600">××™×©×•×¨ ×”×œ×•×•××”</h3><p id="approve-loan-desc" class="text-center text-gray-600 text-sm mb-6"></p><input type="hidden" id="approve-loan-id"><label class="block text-xs font-bold text-gray-500 mb-1">×¨×™×‘×™×ª (%)</label><input type="number" id="approve-loan-interest" class="w-full p-3 border rounded-xl mb-6 text-lg font-bold" value="0"><div class="flex gap-3"><button onclick="handleLoan('rejected')" class="flex-1 py-3 bg-red-100 text-red-600 rounded-xl font-bold">×“×—×”</button><button onclick="handleLoan('active')" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold">××©×¨</button></div></div></div>
    <div id="bank-settings-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-1 text-center">×”×’×“×¨×•×ª ×‘× ×§</h3><input type="hidden" id="bank-settings-id"><label class="block text-xs font-bold text-gray-500 mb-1">×“××™ ×›×™×¡</label><input type="number" id="bank-allowance" class="w-full p-3 border rounded-xl mb-4"><label class="block text-xs font-bold text-gray-500 mb-1">×¨×™×‘×™×ª</label><input type="number" id="bank-interest" class="w-full p-3 border rounded-xl mb-6"><div class="flex gap-3"><button onclick="document.getElementById('bank-settings-modal').classList.add('hidden')" class="flex-1 bg-gray-100 rounded-xl">×‘×™×˜×•×œ</button><button onclick="saveBankSettings()" class="flex-1 bg-purple-600 text-white rounded-xl">×©××•×¨</button></div></div></div>
    <div id="goal-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center text-yellow-600">×™×¢×“ ×—×“×©</h3><input type="text" id="goal-title" class="w-full p-3 border rounded-xl mb-3" placeholder="×œ××” ×—×•×¡×›×™×?"><input type="number" id="goal-target" class="w-full p-3 border rounded-xl mb-6" placeholder="×›××” ×¦×¨×™×š?"><div class="flex gap-3"><button onclick="document.getElementById('goal-modal').classList.add('hidden')" class="flex-1 bg-gray-100 rounded-xl">×‘×™×˜×•×œ</button><button onclick="submitGoal()" class="flex-1 bg-yellow-500 text-white rounded-xl">×¦×•×¨</button></div></div></div>
    <div id="deposit-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-2 text-center text-green-600">×”×¤×§×“×”</h3><input type="hidden" id="deposit-goal-id"><input type="number" id="deposit-amount" class="w-full p-4 border-2 rounded-2xl mb-6 text-3xl text-center" placeholder="â‚ª0"><div class="flex gap-3"><button onclick="document.getElementById('deposit-modal').classList.add('hidden')" class="flex-1 bg-gray-100 rounded-xl">×‘×™×˜×•×œ</button><button onclick="submitDeposit()" class="flex-1 bg-green-600 text-white rounded-xl">×”×¤×§×“</button></div></div></div>
    <div id="task-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center">××©×™××”</h3><input type="text" id="task-title" class="w-full p-3 border rounded-xl mb-3" placeholder="×ª×™××•×¨"><input type="number" id="task-reward" class="w-full p-3 border rounded-xl mb-3" placeholder="×ª×’××•×œ"><select id="task-assignee" class="w-full p-3 border rounded-xl mb-6 bg-white"></select><div class="flex gap-3"><button onclick="document.getElementById('task-modal').classList.add('hidden')" class="flex-1 bg-gray-100 rounded-xl">×‘×™×˜×•×œ</button><button onclick="submitTask()" class="flex-1 bg-purple-600 text-white rounded-xl">×¦×•×¨</button></div></div></div>
    <div id="transaction-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 id="modal-title" class="text-xl font-bold mb-6 text-center">×ª× ×•×¢×”</h3><input type="number" id="t-amount" class="w-full p-3 border rounded-xl mb-3 text-lg" placeholder="×¡×›×•×"><input type="text" id="t-desc" class="w-full p-3 border rounded-xl mb-3" placeholder="×ª×™××•×¨"><select id="t-category" class="w-full p-3 border rounded-xl mb-3 bg-white"><option value="general">×›×œ×œ×™</option><option value="food">××•×›×œ ×•××¡×¢×“×•×ª</option><option value="toys">×¦×¢×¦×•×¢×™×</option><option value="clothes">×‘×’×“×™×</option><option value="entertainment">×‘×™×œ×•×™×™×</option><option value="transport">× ×¡×™×¢×•×ª</option><option value="groceries">×¡×•×¤×¨ ×•×§× ×™×•×ª ×œ×‘×™×ª</option><option value="savings">×—×™×¡×›×•×Ÿ ×•×”×©×§×¢×•×ª</option></select><div id="t-user-select-container" class="hidden mb-6"><select id="t-user-select" class="w-full p-3 border rounded-xl bg-white"></select></div><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 bg-gray-100 rounded-xl">×‘×™×˜×•×œ</button><button onclick="submitTransaction()" class="flex-1 bg-blue-600 text-white rounded-xl">×©××•×¨</button></div></div></div>
    <div id="checkout-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center">×¡×™×•× ×§× ×™×™×”</h3><input type="number" id="checkout-amount" class="w-full p-4 border rounded-2xl mb-6 text-3xl text-center" placeholder="×¡×”×´×›"><div class="flex gap-3"><button onclick="document.getElementById('checkout-modal').classList.add('hidden')" class="flex-1 bg-gray-100 rounded-xl">×‘×™×˜×•×œ</button><button onclick="submitCheckout()" class="flex-1 bg-gray-900 text-white rounded-xl">××™×©×•×¨</button></div></div></div>
    
    <div id="quiz-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative"><button onclick="document.getElementById('quiz-modal').classList.add('hidden')" class="absolute top-4 left-4 text-gray-400"><i class="fa-solid fa-times text-xl"></i></button><div class="text-center mb-6"><span class="bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-xs font-bold mb-2 inline-block">×—×™×“×•×Ÿ</span><h3 id="quiz-question" class="text-xl font-bold text-gray-800"></h3><p id="quiz-content" class="text-sm text-gray-500 mt-2 bg-gray-50 p-3 rounded-xl hidden"></p></div><div id="quiz-options" class="space-y-3"></div><input type="hidden" id="quiz-id-input"></div></div>
    <div id="add-quiz-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl h-[90vh] overflow-y-auto"><h3 class="text-xl font-bold mb-4 text-center text-orange-600">×—×™×“×•×Ÿ ×—×“×©</h3><input type="text" id="new-quiz-q" class="w-full p-3 border rounded-xl mb-3" placeholder="×©××œ×”"><textarea id="new-quiz-content" class="w-full p-3 border rounded-xl mb-3 h-20" placeholder="×ª×•×›×Ÿ ×¢×–×¨"></textarea><div class="space-y-2 mb-4"><div class="flex gap-2"><input type="radio" name="correct-opt" value="0" checked><input type="text" id="opt-0" class="w-full p-2 border rounded-lg" placeholder="×ª×©×•×‘×” 1"></div><div class="flex gap-2"><input type="radio" name="correct-opt" value="1"><input type="text" id="opt-1" class="w-full p-2 border rounded-lg" placeholder="×ª×©×•×‘×” 2"></div><div class="flex gap-2"><input type="radio" name="correct-opt" value="2"><input type="text" id="opt-2" class="w-full p-2 border rounded-lg" placeholder="×ª×©×•×‘×” 3"></div><div class="flex gap-2"><input type="radio" name="correct-opt" value="3"><input type="text" id="opt-3" class="w-full p-2 border rounded-lg" placeholder="×ª×©×•×‘×” 4"></div></div><div class="flex gap-2 mb-4"><input type="number" id="new-quiz-reward" class="w-full p-3 border rounded-xl" value="2"><select id="new-quiz-age" class="w-full p-3 border rounded-xl bg-white"><option value="child_6_10">6-10</option><option value="child_10_15">10-15</option><option value="teen_15_18">15+</option><option value="all">×›×•×œ×</option></select></div><div class="flex gap-3"><button onclick="document.getElementById('add-quiz-modal').classList.add('hidden')" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">×‘×™×˜×•×œ</button><button onclick="createQuiz()" class="flex-1 py-3 bg-orange-600 text-white rounded-xl font-bold">×¦×•×¨</button></div></div></div>

    <script>
        const storedAppName = localStorage.getItem('custom_app_name');
        const defaultAppName = 'family-flow-app'; 
        const APP_NAME = storedAppName || defaultAppName;
        let API = window.location.hostname.includes('onrender.com') ? '/api' : `https://${APP_NAME}.onrender.com/api`;
        
        let currentUser = null;
        let shoppingCart = []; 
        let currentTab = 'tasks';

        const productsDB = { "××•×¦×¨×™ ×—×œ×‘ ×•×‘×™×¦×™×": ["×—×œ×‘ ×ª× ×•×‘×” 3%", "×—×œ×‘ ×™×•×˜×‘×ª×”", "×§×•×˜×’' ×ª× ×•×‘×” 5%", "×’×‘×™× ×” ×œ×‘× ×” 5%", "×’×‘×™× ×” ×¦×”×•×‘×” ×¢××§", "×©×× ×ª ××ª×•×§×”", "××¢×“×Ÿ ××™×œ×§×™", "×™×•×’×•×¨×˜ ×™×•×¤×œ×”", "×—×××”", "×‘×™×¦×™× L (×ª×‘× ×™×ª 12)", "×‘×™×¦×™× XL"], "×œ×—× ×•×××¤×™×": ["×œ×—× ××—×™×“ ×¤×¨×•×¡", "×œ×—× ××œ×", "×—×œ×” ×œ×©×‘×ª", "×¤×™×ª×•×ª", "×œ×—×× ×™×•×ª", "×¤×™×¨×•×¨×™ ×œ×—×"], "×¤×™×¨×•×ª ×•×™×¨×§×•×ª": ["×¢×’×‘× ×™×•×ª", "××œ×¤×¤×•× ×™×", "×‘×¦×œ ×™×‘×©", "×ª×¤×•×—×™ ××“××”", "×’×–×¨", "×¤×œ×¤×œ ××“×•×", "×—×¡×”", "×œ×™××•×Ÿ", "×‘× × ×•×ª", "×ª×¤×•×— ×¢×¥ ×—×¨××•×Ÿ", "××’×¡", "××‘×˜×™×—", "××œ×•×Ÿ", "×¢× ×‘×™×"], "××–×•×•×” ×•×‘×™×©×•×œ": ["××•×¨×– ×¤×¨×¡×™", "×¤×¡×˜×” ×¤× ×”", "×¤×¡×˜×” ×¡×¤×’×˜×™", "×¤×ª×™×ª×™×", "×§×•×¡×§×•×¡", "×©××Ÿ ×–×™×ª", "×©××Ÿ ×§× ×•×œ×”", "×¡×•×›×¨ ×œ×‘×Ÿ", "×§××— ×œ×‘×Ÿ", "××œ×—", "×¤×œ×¤×œ ×©×—×•×¨", "××‘×§×ª ××¨×§", "×§×¤×” × ××¡", "×ª×”", "×©×•×§×•×œ×™×ª", "×“×‘×©", "×˜×—×™× ×”", "×˜×•× ×”", "×©×™××•×¨×™×"], "×‘×©×¨ ×•×§×¤×•××™×": ["×—×–×” ×¢×•×£ ×˜×¨×™", "×‘×©×¨ ×˜×—×•×Ÿ ×˜×¨×™", "×©× ×™×¦×œ ×ª×™×¨×¡", "× ×§× ×™×§×™×•×ª", "×¤×™×¦×” ××¢×“× ×•×ª", "×¡× ×¤×¨×•×¡×˜"], "× ×™×§×™×•×Ÿ ×•×¤××¨×": ["× ×™×™×¨ ×˜×•××œ×˜", "××’×‘×•×ª × ×™×™×¨", "××’×‘×•× ×™×", "× ×•×–×œ ×›×œ×™×", "××§×•× ×•××™×§×”", "××‘×§×ª ×›×‘×™×¡×”", "×©××¤×•", "×¡×‘×•×Ÿ ×’×•×£", "××©×—×ª ×©×™× ×™×™×"], "×—×˜×™×¤×™× ×•×©×ª×™×™×”": ["×‘××‘×”", "×‘×™×¡×œ×™", "×ª×¤×•×¦'×™×¤×¡", "×‘×™×™×’×œ×”", "×©×•×§×•×œ×“ ×¤×¨×”", "×§×•×§×” ×§×•×œ×”", "××™× ××™× ×¨×œ×™×", "××™×¥ ×ª×¤×•×–×™×"] };

        function searchProducts(query) {
            const list = document.getElementById('product-suggestions');
            list.innerHTML = '';
            if (!query) { renderSuggestions({"× ×¤×•×¦×™×": ["×—×œ×‘", "×œ×—×", "×‘×™×¦×™×", "×¢×’×‘× ×™×•×ª", "××œ×¤×¤×•× ×™×"]}); list.classList.remove('hidden'); return; }
            let matches = {}; let hasResults = false;
            for (const [cat, items] of Object.entries(productsDB)) { const m = items.filter(p => p.includes(query)); if (m.length > 0) { matches[cat] = m; hasResults = true; } }
            if (hasResults) { renderSuggestions(matches); list.classList.remove('hidden'); } else { list.classList.add('hidden'); }
        }
        function renderSuggestions(groupedItems) {
            const list = document.getElementById('product-suggestions');
            for (const [category, items] of Object.entries(groupedItems)) {
                const header = document.createElement('div'); header.className = "bg-gray-50 px-3 py-1 text-xs font-bold text-gray-500 sticky top-0"; header.innerText = category; list.appendChild(header);
                items.forEach(item => { const div = document.createElement('div'); div.className = "p-3 hover:bg-pink-50 cursor-pointer border-b border-gray-100 last:border-0 text-gray-700 pl-4"; div.innerText = item; div.onclick = () => { document.getElementById('shop-item-name').value = item; list.classList.add('hidden'); }; list.appendChild(div); });
            }
        }
        document.addEventListener('click', (e) => { if (!document.getElementById('shopping-modal').contains(e.target)) document.getElementById('product-suggestions').classList.add('hidden'); });

        window.onload = async () => { if (new URLSearchParams(window.location.search).get('join') === 'true') initRegisterMode(); else loadUsersForLogin(); };

        async function loadDashboard() {
            document.getElementById('user-name').innerText = currentUser.name;
            document.getElementById('user-role').innerText = currentUser.role === 'parent' ? '×× ×”×œ/×ª' : '×œ×§×•×—';
            if (currentUser.role === 'parent') { document.getElementById('btn-invite').classList.remove('hidden'); document.getElementById('tab-bank').classList.remove('hidden'); document.getElementById('tab-budget').classList.remove('hidden'); document.getElementById('btn-add-quiz').classList.remove('hidden'); }
            
            const res = await fetch(`${API}/data/${currentUser.id}`); const data = await res.json();
            document.getElementById('balance').innerText = `â‚ª${data.user.balance}`;
            if (currentUser.role === 'parent' && data.family) { document.getElementById('family-section').classList.remove('hidden'); renderFamily(data.family); }
            
            renderTasks(data.tasks); renderShoppingList(data.shopping_list); renderTransactions(data.transactions); renderGoals(data.goals); renderLoans(data.loans); renderAcademy(data.quizzes);
            
            if (!currentTab) currentTab = 'tasks';
            switchTab(currentTab);
        }

        // --- Shopping Logic Updated ---
        function renderShoppingList(items) {
            const activeList = document.getElementById('shopping-active-list');
            activeList.innerHTML = '';
            shoppingCart = []; 

            items.forEach(i => {
                if (i.status === 'approved' || i.status === 'in_cart') {
                    const inCart = i.status === 'in_cart';
                    const priceVal = i.estimated_price || i.last_price || 0; 
                    const storeHint = i.last_store ? `(× ×¨×›×© ×‘-${i.last_store})` : '';
                    
                    let dealBadge = '';
                    // ×—×›××ª ×”××•× ×™× ×¢× ×ª××¨×™×š
                    if (i.best_price && parseFloat(priceVal) > parseFloat(i.best_price)) {
                        const date = i.best_date ? new Date(i.best_date).toLocaleDateString('he-IL') : '';
                        const dateStr = date ? `(×¢×•×“×›×Ÿ ×‘-${date})` : '';
                        dealBadge = `
                            <div class="mt-1 text-[10px] bg-red-50 text-red-600 px-2 py-1 rounded-md border border-red-100 font-bold inline-flex items-center gap-1">
                                <i class="fa-solid fa-arrow-trend-down"></i>
                                ×–×•×œ ×™×•×ª×¨ ×‘-${i.best_store}: â‚ª${i.best_price} ${dateStr}
                            </div>
                        `;
                    }

                    shoppingCart.push({ id: i.id, name: i.item_name, price: parseFloat(priceVal), inCart: inCart });

                    activeList.innerHTML += `
                        <div class="p-3 bg-white rounded-xl shadow-sm border ${inCart ? 'item-in-cart border-green-200' : 'border-gray-50'} animate-item transition-colors duration-300">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" onchange="toggleCartItem(${i.id}, this.checked)" class="w-6 h-6 accent-pink-500 rounded-md cursor-pointer" ${inCart ? 'checked' : ''}>
                                
                                <div class="flex-1">
                                    <div class="${inCart ? 'item-text' : 'font-medium text-gray-700'} text-lg">
                                        ${i.item_name}
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        ×‘×™×§×©/×”: ${i.requester_name || '?'}
                                        <span class="mr-1">${storeHint}</span>
                                    </div>
                                    ${dealBadge} 
                                </div>

                                <div class="flex items-center bg-gray-50 rounded-lg px-2 py-1">
                                    <span class="text-gray-400 text-xs mr-1">â‚ª</span>
                                    <input type="number" 
                                        value="${priceVal > 0 ? priceVal : ''}" 
                                        placeholder="0"
                                        class="w-16 bg-transparent text-right font-bold text-gray-700 outline-none"
                                        onchange="updateItemPrice(${i.id}, this.value)">
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            updateLiveTotal();
        }

        async function openHistoryModal() {
            const modal = document.getElementById('history-modal');
            const list = document.getElementById('history-list');
            list.innerHTML = '<p class="text-center text-gray-400">×˜×•×¢×Ÿ ×”×™×¡×˜×•×¨×™×”...</p>';
            modal.classList.remove('hidden');

            const res = await fetch(`${API}/shopping/history`);
            const history = await res.json();
            
            list.innerHTML = '';
            if(history.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 py-10">××™×Ÿ ×¢×“×™×™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×§× ×™×•×ª</p>';
                return;
            }

            history.forEach(h => {
                const date = new Date(h.trip_date).toLocaleDateString();
                const itemsHtml = h.items.map(i => `<div class="flex justify-between text-sm text-gray-600 py-1 border-b border-gray-50 last:border-0"><span>${i.item_name}</span><span>â‚ª${i.estimated_price}</span></div>`).join('');
                
                list.innerHTML += `
                    <div class="border rounded-xl p-4 bg-gray-50">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <div class="font-bold text-gray-800">${h.store_name}</div>
                                <div class="text-xs text-gray-500">${date} â€¢ ${h.item_count} ×¤×¨×™×˜×™×</div>
                            </div>
                            <div class="text-lg font-black text-green-600">â‚ª${h.total_amount}</div>
                        </div>
                        <details class="group">
                            <summary class="text-xs text-blue-500 cursor-pointer list-none">×”×¦×’ ×¤×™×¨×•×˜</summary>
                            <div class="mt-2 pl-2 border-r-2 border-blue-100">
                                ${itemsHtml}
                            </div>
                        </details>
                    </div>
                `;
            });
        }

        function updateItemPrice(id, price) {
            const item = shoppingCart.find(x => x.id === id);
            if (item) item.price = parseFloat(price) || 0;
            updateLiveTotal();
            fetch(`${API}/shopping/update-price`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ itemId: id, price: price }) });
        }

        async function toggleCartItem(id, checked) {
            const item = shoppingCart.find(x => x.id === id);
            if (item) item.inCart = checked;
            // ×¢×“×›×•×Ÿ ×•×™×–×•××œ×™ ××™×™×“×™ ×œ×¤× ×™ ×©×¨×ª
            renderShoppingList(await (await fetch(`${API}/data/${currentUser.id}`)).json().then(d => d.shopping_list)); 
            
            await fetch(`${API}/shopping/update`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ itemId: id, status: checked ? 'in_cart' : 'approved' }) });
            // ×˜×¢×™× ×” ××—×“×© ×›×“×™ ×œ×•×•×“× ×¡× ×›×¨×•×Ÿ
            const res = await fetch(`${API}/data/${currentUser.id}`);
            const data = await res.json();
            renderShoppingList(data.shopping_list);
        }

        function updateLiveTotal() {
            const total = shoppingCart.filter(i => i.inCart).reduce((sum, i) => sum + i.price, 0);
            document.getElementById('live-cart-total').innerText = `â‚ª${total.toFixed(2)}`;
        }

        async function checkout() {
            const storeName = document.getElementById('store-name-input').value;
            if (!storeName) return alert('× × ×œ×”×–×™×Ÿ ××ª ×©× ×”×—× ×•×ª ×œ×¤× ×™ ×¡×™×•× ×”×§× ×™×™×”');
            const cartItems = shoppingCart.filter(i => i.inCart);
            if (cartItems.length === 0) return alert('×”×¢×’×œ×” ×¨×™×§×”!');
            const total = cartItems.reduce((sum, i) => sum + i.price, 0);
            if (total === 0 && !confirm('×”×¡×›×•× ×”×•× 0. ×œ×”××©×™×š?')) return;

            await fetch(`${API}/shopping/checkout`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ totalAmount: total, userId: currentUser.id, storeName: storeName, items: cartItems })
            });

            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            alert(`×§× ×™×™×” ×‘×¡×š â‚ª${total} × ×¨×©××” ×‘×”×¦×œ×—×”!`);
            document.getElementById('store-name-input').value = ''; 
            loadDashboard(); // ×–×” ×™× ×§×” ××ª ×”×¨×©×™××” (×›×™ ×”×¡×˜×˜×•×¡ ×”×¤×š ×œ-bought)
        }

        // --- ×©××¨ ×”×¤×•× ×§×¦×™×•×ª ---
        function switchTab(tab) {
            currentTab = tab;
            ['tasks', 'shopping', 'goals', 'budget', 'bank', 'loans', 'academy'].forEach(t => { 
                document.getElementById(`section-${t}`)?.classList.add('hidden');
                const btn = document.getElementById(`tab-${t}`);
                if(btn) btn.className = "nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap text-gray-500 hover:bg-gray-50";
            });
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            let color = 'bg-blue-100 text-blue-700'; 
            if(tab==='shopping') { document.getElementById('floating-actions').classList.add('hidden'); } else { document.getElementById('floating-actions').classList.remove('hidden'); }
            if(tab==='shopping') color='bg-pink-100 text-pink-700';
            document.getElementById(`tab-${tab}`).className = `nav-tab flex-1 py-2.5 px-4 rounded-xl font-bold text-sm text-center transition whitespace-nowrap ${color} shadow-sm`;
        }

        // ... ×”×¢×ª×§×ª ×©××¨ ×”×¤×•× ×§×¦×™×•×ª ×”×§×™×™××•×ª ...
        function saveAppNameAndRetry() { const input = document.getElementById('custom-app-name').value; if (!input) return alert('× × ×œ×”×–×™×Ÿ ×©×'); let cleanName = input.replace('https://', '').replace('.onrender.com', '').split('/')[0]; localStorage.setItem('custom_app_name', cleanName); location.reload(); }
        function initRegisterMode() { document.getElementById('user-select-screen').classList.add('hidden'); document.getElementById('register-screen').classList.remove('hidden'); let roleText = "××©×ª××© ×—×“×©"; if (joinRole === 'parent') roleText = "×”×•×¨×” (×× ×”×œ)"; else if (joinAge === 'child_6_10') roleText = "×™×œ×“/×” (6-10)"; else if (joinAge === 'child_10_15') roleText = "× ×¢×¨/×” (10-15)"; document.getElementById('register-role-desc').innerText = `××¦×˜×¨×£ ×‘×ª×•×¨: ${roleText}`; }
        async function completeRegistration() { const name = document.getElementById('reg-name').value; const pin = document.getElementById('reg-pin').value; if(!name || !pin || pin.length < 4) return alert('× × ×œ××œ× ×¤×¨×˜×™×'); const btn = document.querySelector('#register-screen button'); btn.innerText = "×™×•×¦×¨..."; try { await fetch(`${API}/create-user`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name, pin, role: joinRole||'child', ageGroup: joinAge||'adult', initialBalance: 0 }) }); alert('× ×•×¦×¨ ×‘×”×¦×œ×—×”!'); window.location.href = window.location.pathname; } catch (e) { alert('×©×’×™××”'); btn.innerText = "× ×¡×” ×©×•×‘"; } }
        function openInviteModal() { document.getElementById('invite-modal').classList.remove('hidden'); }
        function generateInvite(role, ageGroup) { const link = `${window.location.href.split('?')[0]}?join=true&role=${role}&age=${ageGroup}`; let msg = `×”×™×™! ××–××™×Ÿ ××•×ª×š ×œ×”×¦×˜×¨×£ ×œ-FamilyFlow ğŸ \n${link}`; if(role==='child') msg = `×”×™×™! ×”× ×” ×”××¤×œ×™×§×¦×™×” ×œ×“××™ ×”×›×™×¡ ×©×œ×š ğŸ’°\n${link}`; const url = `https://wa.me/?text=${encodeURIComponent(msg)}`; document.getElementById('invite-link-area').classList.remove('hidden'); const btn = document.getElementById('btn-send-whatsapp'); btn.onclick = () => window.open(url, '_blank'); }
        async function loadUsersForLogin() { try { const res = await fetch(`${API}/public-users`); const contentType = res.headers.get("content-type"); if (res.ok && contentType && contentType.includes("text/html")) throw new Error("SERVER_CODE_OUTDATED"); if (!res.ok) throw new Error('Error'); const users = await res.json(); document.getElementById('loading-spinner').classList.add('hidden'); document.getElementById('users-grid').classList.remove('hidden'); const grid = document.getElementById('users-grid'); grid.innerHTML = ''; users.forEach(u => { const color = u.role === 'parent' ? 'bg-blue-100 text-blue-600' : (u.age_group==='child_6_10'?'bg-green-100 text-green-600':'bg-purple-100 text-purple-600'); const icon = u.role === 'parent' ? '<i class="fa-solid fa-user-tie"></i>' : '<i class="fa-solid fa-child"></i>'; grid.innerHTML += `<div onclick="promptPin(${u.id}, '${u.name}', '${u.role}')" class="flex flex-col items-center cursor-pointer group hover:scale-105 transition"><div class="w-24 h-24 ${color} rounded-full flex items-center justify-center mb-3 shadow-sm text-3xl group-hover:shadow-md transition">${icon}</div><span class="font-bold text-gray-700 text-lg">${u.name}</span></div>`; }); } catch (error) { document.getElementById('loading-spinner').classList.add('hidden'); document.getElementById('connection-error').classList.remove('hidden'); if (error.message === "SERVER_CODE_OUTDATED") alert("× × ×œ×¢×“×›×Ÿ ××ª server.js"); } }
        function promptPin(id, name, role) { selectedUserIdForLogin = id; document.getElementById('pin-user-name').innerText = `×”×™×™ ${name}`; document.getElementById('pin-user-icon').innerHTML = role==='parent'?'<i class="fa-solid fa-user-tie"></i>':'<i class="fa-solid fa-child"></i>'; document.getElementById('pin-modal').classList.remove('hidden'); document.getElementById('pin-input').value = ''; document.getElementById('pin-input').focus(); }
        function closePinModal() { document.getElementById('pin-modal').classList.add('hidden'); selectedUserIdForLogin = null; }
        async function login() { const pin = document.getElementById('pin-input').value; if (!pin) return; try { const res = await fetch(`${API}/login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({userId: selectedUserIdForLogin, pin}) }); const data = await res.json(); if (data.success) { currentUser = data.user; document.getElementById('pin-modal').classList.add('hidden'); document.getElementById('user-select-screen').classList.add('hidden'); document.getElementById('dashboard').classList.remove('hidden'); loadDashboard(); } else { document.getElementById('error-msg').classList.remove('hidden'); } } catch (e) { alert('×©×’×™××”'); } }
        function renderFamily(members) { const famList = document.getElementById('family-list'); const bankList = document.getElementById('bank-accounts-list'); const tSel = document.getElementById('task-assignee'); const uSel = document.getElementById('t-user-select'); famList.innerHTML = ''; bankList.innerHTML = ''; tSel.innerHTML = ''; uSel.innerHTML = ''; members.forEach(m => { famList.innerHTML += `<div class="flex-shrink-0 text-center bg-white p-3 rounded-2xl border w-24 shadow-sm"><div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-2 text-blue-600 font-bold text-xl">${m.name[0]}</div><p class="font-bold text-sm truncate">${m.name}</p><p class="text-xs text-gray-500">â‚ª${m.balance}</p></div>`; if(m.role==='child') { tSel.innerHTML += `<option value="${m.id}">${m.name}</option>`; uSel.innerHTML += `<option value="${m.id}">${m.name}</option>`; bankList.innerHTML += `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center"><div><div class="font-bold text-gray-800">${m.name}</div><div class="text-xs text-gray-500">×“××™ ×›×™×¡: â‚ª${m.weekly_allowance||0} | ×¨×™×‘×™×ª: ${m.interest_rate||0}%</div></div><button onclick="openBankSettings(${m.id}, '${m.name}', ${m.weekly_allowance||0}, ${m.interest_rate||0})" class="text-purple-600 bg-purple-50 p-2 rounded-lg text-sm font-bold">×¢×¨×•×š</button></div>`; } else { uSel.innerHTML += `<option value="${m.id}">${m.name}</option>`; } }); }
        function openBankSettings(id, name, allowance, interest) { document.getElementById('bank-settings-id').value = id; document.getElementById('bank-settings-name').innerText = `×”×’×“×¨×•×ª ×¢×‘×•×¨ ${name}`; document.getElementById('bank-allowance').value = allowance; document.getElementById('bank-interest').value = interest; document.getElementById('bank-settings-modal').classList.remove('hidden'); }
        async function saveBankSettings() { const id = document.getElementById('bank-settings-id').value; const allowance = document.getElementById('bank-allowance').value; const interest = document.getElementById('bank-interest').value; await fetch(`${API}/bank/settings`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({userId: id, allowance, interest})}); document.getElementById('bank-settings-modal').classList.add('hidden'); loadDashboard(); }
        async function runPayday() { if(!confirm('×”×× ×œ×—×œ×§ ×“××™ ×›×™×¡ ×•×¨×™×‘×™×•×ª ×œ×›×œ ×”×™×œ×“×™×?')) return; const res = await fetch(`${API}/bank/payday`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({userId: currentUser.id})}); const data = await res.json(); if(data.success) { let msg = '×™×•× ×”×ª×©×œ×•× ×‘×•×¦×¢ ×‘×”×¦×œ×—×”! ğŸ’¸\n\n'; if(data.report.length > 0) msg += data.report.join('\n'); else msg += '×œ× ×”×™×• ×¢×“×›×•× ×™× (×‘×“×•×§ ×”×’×“×¨×•×ª ×“××™ ×›×™×¡)'; alert(msg); loadDashboard(); } }
        function renderLoans(loans) { const list = document.getElementById('loans-list'); list.innerHTML = ''; if (!loans || loans.length === 0) { document.getElementById('no-loans-msg')?.classList.remove('hidden'); return; } document.getElementById('no-loans-msg')?.classList.add('hidden'); loans.forEach(l => { let statusBadge = ''; let action = ''; if (l.status === 'pending') { statusBadge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold">×××ª×™×Ÿ ×œ××™×©×•×¨</span>'; if (currentUser.role === 'parent') { action = `<button onclick="openApproveLoan(${l.id}, '${l.user_name}', ${l.original_amount})" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm shadow">×˜×¤×œ</button>`; } } else if (l.status === 'active') { statusBadge = '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">×¤×¢×™×œ</span>'; if (currentUser.id == l.user_id) { action = `<button onclick="repayLoan(${l.id}, ${l.remaining_amount})" class="bg-green-600 text-white px-3 py-1 rounded text-sm shadow">×¡×’×•×¨ ×—×•×‘ (â‚ª${l.remaining_amount})</button>`; } else { action = `<span class="text-xs text-gray-400">× ×•×ª×¨: â‚ª${l.remaining_amount}</span>`; } } else if (l.status === 'rejected') { statusBadge = '<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">× ×“×—×”</span>'; } list.innerHTML += `<div class="card p-4 border border-indigo-50 animate-item"><div class="flex justify-between items-start mb-2"><div><h4 class="font-bold text-gray-800">${l.reason} <span class="text-xs font-normal text-gray-500">(${l.user_name})</span></h4><div class="text-xs text-gray-500">×¡×›×•× ××§×•×¨×™: â‚ª${l.original_amount} ${l.interest_rate > 0 ? `(+${l.interest_rate}% ×¨×™×‘×™×ª)` : ''}</div></div>${statusBadge}</div><div class="flex justify-between items-center mt-2">${action}</div></div>`; }); }
        function openLoanModal() { document.getElementById('loan-modal').classList.remove('hidden'); }
        async function submitLoanRequest() { const amount = document.getElementById('loan-amount').value; const reason = document.getElementById('loan-reason').value; if(!amount || !reason) return alert('×—×¡×¨×™× ×¤×¨×˜×™×'); await fetch(`${API}/loans/request`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:currentUser.id, amount, reason})}); document.getElementById('loan-modal').classList.add('hidden'); loadDashboard(); }
        function openApproveLoan(id, name, amount) { document.getElementById('approve-loan-id').value = id; document.getElementById('approve-loan-desc').innerText = `${name} ××‘×§×©/×ª â‚ª${amount}`; document.getElementById('approve-loan-interest').value = 0; document.getElementById('approve-loan-modal').classList.remove('hidden'); }
        async function handleLoan(status) { const id = document.getElementById('approve-loan-id').value; const interest = document.getElementById('approve-loan-interest').value; await fetch(`${API}/loans/handle`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({loanId:id, status, interestRate:interest})}); document.getElementById('approve-loan-modal').classList.add('hidden'); loadDashboard(); }
        function renderTasks(tasks) { const list=document.getElementById('tasks-list'); list.innerHTML=''; if(tasks.length===0)document.getElementById('no-tasks-msg')?.classList.remove('hidden'); else {document.getElementById('no-tasks-msg')?.classList.add('hidden'); tasks.forEach(task=>{let action=currentUser.role==='child'&&task.status==='pending'?`<button onclick="updateTask(${task.id},'done')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow hover:bg-blue-700 transition">×¡×™×™××ª×™</button>`:(currentUser.role==='parent'&&task.status==='done'?`<button onclick="updateTask(${task.id},'approved')" class="bg-green-500 text-white px-4 py-2 rounded-xl text-xs font-bold shadow hover:bg-green-600 transition">××©×¨</button>`:`<span class="text-xs text-gray-400 font-bold bg-gray-100 px-2 py-1 rounded">${task.status==='done'?'×××ª×™×Ÿ':'×‘×ª×”×œ×™×š'}</span>`); list.innerHTML+=`<div class="card p-4 flex justify-between items-center animate-item border border-gray-50"><div><p class="font-bold text-gray-800">${task.title} <span class="text-yellow-600 text-xs bg-yellow-50 px-2 py-0.5 rounded-md border border-yellow-100 font-bold">â‚ª${task.reward}</span></p><p class="text-xs text-gray-400 mt-1">${task.assignee_name}</p></div><div>${action}</div></div>`;});} }
        function renderTransactions(trans) { const l=document.getElementById('transactions-list'); l.innerHTML=''; trans.forEach(t=>{const inc=t.type==='income'; l.innerHTML+=`<div class="card p-4 flex justify-between items-center animate-item border-r-4 ${inc?'border-green-400':'border-red-400'} shadow-sm"><div><p class="font-bold text-gray-800">${t.description}</p><p class="text-xs text-gray-400 mt-0.5">${new Date(t.date).toLocaleDateString()}</p></div><span class="${inc?'text-green-600':'text-red-600'} font-bold text-lg tracking-tight">${inc?'+':'-'}â‚ª${t.amount}</span></div>`;}); }
        function renderAcademy(quizzes) { const list = document.getElementById('academy-list'); list.innerHTML = ''; if (!quizzes || quizzes.length === 0) { document.getElementById('no-quiz-msg').classList.remove('hidden'); return; } document.getElementById('no-quiz-msg').classList.add('hidden'); quizzes.forEach(q => { let action = `<button onclick="startQuiz(${q.id}, '${q.question}', '${escape(q.content||'')}', ${JSON.stringify(q.options)})" class="bg-orange-500 text-white px-4 py-2 rounded-xl font-bold shadow-md hover:bg-orange-600 transition">×”×ª×—×œ</button>`; if (currentUser.role === 'parent') { action = `<span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">×œ×’×™×œ××™: ${q.target_age_group}</span>`; } list.innerHTML += `<div class="card p-5 border border-orange-50 animate-item"><div class="flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 text-xl"><i class="fa-solid fa-graduation-cap"></i></div><div><h4 class="font-bold text-gray-800 text-sm md:text-base">${q.question}</h4><div class="text-xs text-gray-500 mt-1 flex gap-2"><span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-md font-bold">â‚ª${q.reward}</span><span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded-md font-bold">+20 XP</span></div></div></div><div>${action}</div></div></div>`; }); }
        function startQuiz(id, question, content, options) { document.getElementById('quiz-id-input').value = id; document.getElementById('quiz-question').innerText = question; const contentEl = document.getElementById('quiz-content'); if (content && content !== 'null') { contentEl.innerText = unescape(content); contentEl.classList.remove('hidden'); } else { contentEl.classList.add('hidden'); } const optsDiv = document.getElementById('quiz-options'); optsDiv.innerHTML = ''; options.forEach((opt, idx) => { optsDiv.innerHTML += `<button onclick="submitAnswer(${id}, ${idx})" class="w-full text-right p-3 border-2 border-gray-100 rounded-xl hover:border-orange-200 hover:bg-orange-50 transition font-medium text-gray-700">${opt}</button>`; }); document.getElementById('quiz-modal').classList.remove('hidden'); }
        async function submitAnswer(quizId, answerIndex) { const res = await fetch(`${API}/academy/answer`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: currentUser.id, quizId, answerIndex }) }); const data = await res.json(); document.getElementById('quiz-modal').classList.add('hidden'); if (data.correct) { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); alert(`×›×œ ×”×›×‘×•×“! ğŸ‰\n×”×¨×•×•×—×ª â‚ª${data.reward} ×•-20 × ×§×•×“×•×ª XP!`); loadDashboard(); } else { alert('×œ× × ×•×¨×, × ×¡×” ×©×•×‘ ×‘×¤×¢× ×”×‘××”! ğŸ˜‰'); } }
        function openAddQuizModal() { document.getElementById('add-quiz-modal').classList.remove('hidden'); }
        async function createQuiz() { const q = document.getElementById('new-quiz-q').value, c = document.getElementById('new-quiz-content').value, r = document.getElementById('new-quiz-reward').value, age = document.getElementById('new-quiz-age').value; const correct = document.querySelector('input[name="correct-opt"]:checked').value; const options = [document.getElementById('opt-0').value, document.getElementById('opt-1').value, document.getElementById('opt-2').value, document.getElementById('opt-3').value]; if (!q || options.some(o => !o)) return alert('×—×¡×¨×™× ×¤×¨×˜×™×'); await fetch(`${API}/academy/create`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: 'trivia', question: q, content: c, options: options, correctIndex: parseInt(correct), reward: r, targetAge: age }) }); document.getElementById('add-quiz-modal').classList.add('hidden'); loadDashboard(); }
        function renderGoals(goals) { const list = document.getElementById('goals-list'); list.innerHTML = ''; if (!goals || goals.length === 0) { document.getElementById('no-goals-msg')?.classList.remove('hidden'); return; } document.getElementById('no-goals-msg')?.classList.add('hidden'); goals.forEach(g => { const percent = Math.min(100, Math.round((g.current_amount / g.target_amount) * 100)); list.innerHTML += `<div class="card p-5 animate-item border border-gray-50"><div class="flex justify-between items-center mb-3"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-yellow-50 rounded-full flex items-center justify-center text-yellow-500 text-xl"><i class="fa-solid fa-star"></i></div><div><h4 class="font-bold text-gray-800">${g.title}</h4><p class="text-xs text-gray-500 font-bold">×™×¢×“: â‚ª${g.target_amount}</p></div></div>${percent===100 ? '<span class="text-green-600 font-bold text-xs bg-green-50 px-2 py-1 rounded-lg">×”×•×©×œ×! ğŸ‰</span>' : `<button onclick="openDepositModal(${g.id})" class="bg-green-600 text-white text-xs font-bold px-4 py-2 rounded-full shadow-md hover:bg-green-700 transition">×”×¤×§×“</button>`}</div><div class="w-full bg-gray-100 rounded-full h-3 mb-2"><div class="bg-yellow-400 h-3 rounded-full progress-bar shadow-sm" style="width: ${percent}%"></div></div><div class="flex justify-between text-xs font-bold text-gray-400"><span>â‚ª${g.current_amount}</span><span>${percent}%</span></div></div>`; }); }
        function openGoalModal() { document.getElementById('goal-modal').classList.remove('hidden'); }
        async function submitGoal() { const t = document.getElementById('goal-title').value, ta = document.getElementById('goal-target').value; await fetch(`${API}/goals`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:currentUser.id,title:t,targetAmount:ta})}); document.getElementById('goal-modal').classList.add('hidden'); loadDashboard(); }
        function openDepositModal(id) { document.getElementById('deposit-goal-id').value=id; document.getElementById('deposit-modal').classList.remove('hidden'); }
        async function submitDeposit() { const id=document.getElementById('deposit-goal-id').value,am=document.getElementById('deposit-amount').value; await fetch(`${API}/goals/deposit`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:currentUser.id,goalId:id,amount:am})}); document.getElementById('deposit-modal').classList.add('hidden'); triggerConfetti(); loadDashboard(); }
        function renderBudget(budgets) { const list = document.getElementById('budget-bars'); list.innerHTML = ''; const labels = { 'general': '×›×œ×œ×™', 'food': '××•×›×œ', 'toys': '×¦×¢×¦×•×¢×™×', 'clothes': '×‘×’×“×™×', 'entertainment': '×‘×™×œ×•×™×™×', 'transport': '× ×¡×™×¢×•×ª', 'groceries': '×¡×•×¤×¨ ×•×‘×™×ª', 'savings': '×—×™×¡×›×•×Ÿ' }; budgets.forEach(b => { const label = labels[b.category] || b.category; const percent = b.limit > 0 ? Math.min(100, (b.spent / b.limit) * 100) : 0; let color = 'bg-teal-500'; if(percent > 80) color = 'bg-yellow-500'; if(percent >= 100) color = 'bg-red-500'; list.innerHTML += `<div onclick="openEditBudget('${b.category}', ${b.limit}, '${label}')" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 transition"><div class="flex justify-between items-end mb-2"><span class="font-bold text-gray-700">${label}</span><span class="text-xs font-bold ${percent>=100?'text-red-500':'text-gray-500'}">â‚ª${b.spent} / â‚ª${b.limit}</span></div><div class="w-full bg-gray-100 rounded-full h-3"><div class="${color} h-3 rounded-full progress-bar" style="width: ${percent}%"></div></div></div>`; }); }
        async function loadBudget() { const res = await fetch(`${API}/budget/status`); const data = await res.json(); renderBudget(data); }
        function openEditBudget(cat, limit, label) { document.getElementById('edit-budget-cat').value = cat; document.getElementById('edit-budget-cat-name').innerText = label; document.getElementById('edit-budget-limit').value = limit; document.getElementById('edit-budget-modal').classList.remove('hidden'); }
        async function saveBudgetLimit() { const cat = document.getElementById('edit-budget-cat').value; const limit = document.getElementById('edit-budget-limit').value; await fetch(`${API}/budget/set`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({category:cat, limit})}); document.getElementById('edit-budget-modal').classList.add('hidden'); loadBudget(); }
        function triggerConfetti() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
        async function submitTask(){const t=document.getElementById('task-title').value,r=document.getElementById('task-reward').value,a=document.getElementById('task-assignee').value; await fetch(`${API}/tasks`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:t,reward:r,assignedTo:a})}); document.getElementById('task-modal').classList.add('hidden'); loadDashboard();}
        async function updateTask(id,s){await fetch(`${API}/tasks/update`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({taskId:id,status:s})}); if(s==='done') triggerConfetti(); loadDashboard();}
        function openTaskModal(){document.getElementById('task-modal').classList.remove('hidden');}
        async function submitShopItem(){const n=document.getElementById('shop-item-name').value; if(!n)return; await fetch(`${API}/shopping/add`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({itemName:n,userId:currentUser.id})}); document.getElementById('shopping-modal').classList.add('hidden'); loadDashboard();}
        async function updShop(id,s){await fetch(`${API}/shopping/update`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({itemId:id,status:s})}); loadDashboard();}
        function openShoppingModal(){document.getElementById('shopping-modal').classList.remove('hidden');}
        function openCheckoutModal(){document.getElementById('checkout-modal').classList.remove('hidden');}
        async function submitCheckout(){const a=document.getElementById('checkout-amount').value; if(!a)return; await fetch(`${API}/shopping/checkout`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({totalAmount:a,userId:currentUser.id})}); document.getElementById('checkout-modal').classList.add('hidden'); loadDashboard();}
        function closeModal(){document.getElementById('transaction-modal').classList.add('hidden');}
        function openModal(t){currentType=t; document.getElementById('transaction-modal').classList.remove('hidden'); document.getElementById('modal-title').innerText=t==='income'?'×”×›× ×¡×”':'×”×•×¦××”'; if(currentUser.role==='parent'){document.getElementById('t-user-select-container').classList.remove('hidden'); document.getElementById('t-user-select').value=currentUser.id;}}
        async function submitTransaction(){const a=document.getElementById('t-amount').value,d=document.getElementById('t-desc').value,cat=document.getElementById('t-category').value; const u=currentUser.role==='parent'?document.getElementById('t-user-select').value:currentUser.id; await fetch(`${API}/transaction`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:u,amount:a,description:d,category:cat,type:currentType})}); closeModal(); loadDashboard();}
        function logout(){location.reload();}
        function startDemoMode() { isDemoMode=true; document.getElementById('connection-error').classList.add('hidden'); renderLoginUsers([{id:1,name:'×”×“×’××”',role:'child',weekly_allowance:20,xp:100}]); }
    </script>
</body>
</html>
