<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oneflow Life â€” ×“××• ××§×•××™</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Rubik', sans-serif; background:#f1f5f9; }
    .hidden { display:none !important; }
    .loader { width: 16px; height:16px; border:2px solid #e2e8f0; border-top-color:#3b82f6; border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .cheapest-badge { font-size: 11px; color: #065f46; background:#ecfdf5; padding:3px 6px; border-radius: 8px; display:inline-flex; gap:6px; align-items:center; }
  </style>
</head>
<body class="p-4">

  <div class="max-w-3xl mx-auto">
    <header class="mb-4 text-center">
      <h1 class="text-3xl font-bold">Oneflow Life â€” ×“××• ××§×•××™</h1>
      <p class="text-sm text-slate-500">×××©×§ ×—×“×©× ×™ ×œ××©×§ ×”×‘×™×ª (×“××•)</p>
    </header>

    <!-- Nav Tabs -->
    <div class="mb-4">
      <div class="bg-white p-1 rounded-2xl shadow-sm flex gap-1">
        <button onclick="switchTab('feed')" id="tab-feed" class="tab-btn tab-active flex-1 py-2 rounded-xl font-bold">×¨××©×™</button>
        <button onclick="switchTab('bank')" id="tab-bank" class="tab-btn flex-1 py-2 rounded-xl font-bold">×‘× ×§</button>
        <button onclick="switchTab('tasks')" id="tab-tasks" class="tab-btn flex-1 py-2 rounded-xl font-bold">××©×™××•×ª</button>
        <button onclick="switchTab('academy')" id="tab-academy" class="tab-btn flex-1 py-2 rounded-xl font-bold">××§×“××™×”</button>
        <button onclick="switchTab('shop')" id="tab-shop" class="tab-btn flex-1 py-2 rounded-xl font-bold">×§× ×™×•×ª</button>
        <button onclick="switchTab('budget')" id="tab-budget" class="tab-btn flex-1 py-2 rounded-xl font-bold">×ª×§×¦×™×‘</button>
        <button onclick="switchTab('admin')" id="tab-admin" class="tab-btn flex-1 py-2 rounded-xl font-bold">× ×™×”×•×œ</button>
      </div>
    </div>

    <!-- CONTENT AREAS -->
    <div id="content-feed" class="bg-white p-4 rounded-xl shadow mb-4">
      <h2 class="font-bold text-lg mb-2">×‘×¨×•×›×™× ×”×‘××™× â€” ×œ×•×— ×‘×§×¨×”</h2>
      <p class="text-sm text-slate-500">×™×ª×¨×” × ×•×›×—×™×ª: <span id="user-balance" class="font-bold">â‚ª0</span></p>
    </div>

    <div id="content-bank" class="hidden bg-white p-4 rounded-xl shadow mb-4">
      <h2 class="font-bold text-lg mb-2">×”×‘× ×§ ×”××©×¤×—×ª×™</h2>
      <div class="mb-3">
        <div class="flex gap-2">
          <button onclick="triggerPayday()" class="btn-payday bg-green-500 text-white px-4 py-2 rounded">×‘×¦×¢ PayDay</button>
          <button onclick="openBankSettingsModal()" class="bg-slate-100 px-3 py-2 rounded">×”×’×“×¨×•×ª ×‘× ×§</button>
        </div>
      </div>
      <div id="bank-accounts-list" class="space-y-3"></div>
    </div>

    <div id="content-tasks" class="hidden bg-white p-4 rounded-xl shadow mb-4">
      <div class="flex justify-between items-center mb-3">
        <h2 class="font-bold text-lg">××©×™××•×ª</h2>
        <button onclick="openTaskModal()" class="bg-blue-600 text-white px-3 py-2 rounded">×”×•×¡×£ ××©×™××”</button>
      </div>
      <div id="tasks-list" class="space-y-2"></div>
    </div>

    <div id="content-academy" class="hidden bg-white p-4 rounded-xl shadow mb-4">
      <div class="flex justify-between items-center mb-3">
        <h2 class="font-bold text-lg">×”××§×“××™×” ×”×¤×™× × ×¡×™×ª</h2>
        <button onclick="fetchBundles()" class="text-sm text-slate-600">×¨×¢× ×•×Ÿ</button>
      </div>
      <div id="academy-list" class="space-y-2"></div>
    </div>

    <div id="content-shop" class="hidden bg-white p-4 rounded-xl shadow mb-4">
      <div class="flex justify-between items-center mb-3">
        <h2 class="font-bold text-lg">×¡×•×¤×¨ ×—×›× ğŸ›’</h2>
        <div class="flex items-center gap-2">
          <span id="cart-total-display" class="font-bold">â‚ª0.00</span>
          <button onclick="openCheckout()" class="bg-green-600 text-white px-3 py-1.5 rounded">×¡×™×•× ×§× ×™×™×”</button>
        </div>
      </div>

      <div class="mb-3 grid grid-cols-3 gap-2">
        <input id="shop-item" class="col-span-2 p-2 border rounded" placeholder="×”×•×¡×¤×ª ×¤×¨×™×˜...">
        <input id="shop-quantity" type="number" min="1" value="1" class="p-2 border rounded text-center">
        <div class="col-span-3 flex gap-2 mt-2">
          <button onclick="submitShopItem()" class="bg-pink-500 text-white px-4 py-2 rounded">×”×•×¡×£</button>
          <input id="shop-est-price" placeholder="××—×™×¨ ××©×•×¢×¨ (â‚ª)" class="p-2 border rounded w-40" type="number" step="0.1">
          <div id="suggestions" class="hidden absolute bg-white border rounded mt-12 w-80 z-30"></div>
        </div>
      </div>

      <div id="shop-list" class="space-y-2 min-h-[120px]"></div>

      <div class="mt-4 flex gap-2">
        <button onclick="openHistoryModal()" class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded">×”×™×¡×˜×•×¨×™×™×ª ×§× ×™×•×ª</button>
        <button onclick="toggleSelectAll()" class="bg-blue-50 text-blue-600 px-3 py-1 rounded">×‘×—×¨ ×”×›×œ/×‘×˜×œ</button>
      </div>
    </div>

    <div id="content-budget" class="hidden bg-white p-4 rounded-xl shadow mb-4">
      <h2 class="font-bold text-lg mb-2">×ª×§×¦×™×‘</h2>
      <div id="budget-list"></div>
    </div>

    <div id="content-admin" class="hidden bg-white p-4 rounded-xl shadow mb-4">
      <h2 class="font-bold text-lg mb-2">× ×™×”×•×œ</h2>
      <div id="members-list" class="space-y-2"></div>
    </div>

    <!-- CHECKOUT MODAL -->
    <div id="checkout-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
      <div class="bg-white p-6 rounded-xl w-full max-w-lg">
        <h3 class="font-bold mb-2">×¡×™×›×•× ×§× ×™×™×”</h3>
        <input id="checkout-store" placeholder="×©× ×—× ×•×ª" class="p-2 border rounded w-full mb-3">
        <div id="checkout-items-list" class="space-y-2 max-h-64 overflow-y-auto mb-4"></div>
        <div class="flex justify-between items-center mb-4">
          <b>×¡×”"×›:</b> <span id="checkout-total-display">â‚ª0.00</span>
        </div>
        <div class="flex gap-2">
          <button onclick="closeCheckout()" class="p-2 border rounded flex-1">×‘×™×˜×•×œ</button>
          <button onclick="submitSmartCheckout()" class="p-2 bg-green-600 text-white rounded flex-1">×¡×™×™× ×•×ª×¢×“×›×Ÿ</button>
        </div>
      </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="history-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
      <div class="bg-white p-6 rounded-xl w-full max-w-xl max-h-[80vh] overflow-y-auto">
        <h3 class="font-bold mb-3">×”×™×¡×˜×•×¨×™×™×ª ×§× ×™×•×ª</h3>
        <div id="history-list" class="space-y-3"></div>
        <div class="mt-4 flex gap-2">
          <button onclick="document.getElementById('history-modal').classList.add('hidden')" class="p-2 border rounded">×¡×’×•×¨</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Inline frontend logic (uses /api/*)
    const API = '/api';
    let currentUser = { id: 1, nickname: '××‘×', role: 'ADMIN' };
    let currentGroup = { id: 1, name: '××©×¤×—×ª ×“××•' };
    let shoppingListCache = [];
    let bundlesCache = [];
    let membersCache = [];

    window.onload = () => { fetchData(); attachUI(); };

    function attachUI() {
      document.getElementById('shop-item').addEventListener('input', debounce(suggestProducts, 200));
      switchTab('feed');
    }

    /* Tabs */
    function switchTab(t) {
      ['feed','bank','tasks','academy','shop','budget','admin'].forEach(k=>{
        const el = document.getElementById('content-'+k);
        if (el) el.classList.toggle('hidden', k !== t);
        const tab = document.getElementById('tab-'+k);
        if (tab) tab.classList.toggle('tab-active', k === t);
      });
    }

    /* Fetch data */
    async function fetchData() {
      try {
        const res = await fetch(`${API}/data/${currentUser.id}`);
        if (!res.ok) return;
        const j = await res.json();
        // populate UI
        document.getElementById('user-balance').innerText = `â‚ª${j.user.balance || 0}`;
        shoppingListCache = j.shopping_list || [];
        bundlesCache = j.quiz_bundles || [];
        renderShopList();
        renderAcademy(bundlesCache);
        renderTasks(j.tasks || []);
        renderMembers();
        calcCartTotal();
      } catch (e) { console.error(e); }
    }

    /* ---------- SHOPPING UI & Logic ---------- */
    function renderShopList() {
      const list = document.getElementById('shop-list');
      list.innerHTML = '';
      if (shoppingListCache.length === 0) { list.innerHTML = '<p class="text-center text-slate-400 py-6">×”×¨×©×™××” ×¨×™×§×”</p>'; return; }
      fetchCheapestFromHistory().then(cheapestMap => {
        shoppingListCache.forEach(i=>{
          const cheaper = cheapestMap[i.item_name];
          const row = document.createElement('div');
          row.className = 'bg-white p-3 rounded-xl border flex items-center gap-3 shadow-sm';
          row.innerHTML = `
            <input type="checkbox" ${i.status === 'in_cart' ? 'checked' : ''} onchange="updateShop(${i.id}, this.checked ? 'in_cart' : 'pending')" class="w-5 h-5">
            <div class="flex-1">
              <div class="flex justify-between items-center">
                <div class="font-medium">${i.item_name} <span class="text-xs text-slate-400">x${i.quantity||1}</span></div>
                <div class="text-[11px] text-slate-500">${i.requester_name||''}</div>
              </div>
              ${cheaper ? `<div class="mt-1"><span class="cheapest-badge">× ××¦× ×–×•×œ ×™×•×ª×¨: â‚ª${cheaper.price} â€¢ ${cheaper.store_name} â€¢ ${new Date(cheaper.recorded_at).toLocaleDateString()}</span> <button onclick="applyCheapestPrice(${i.id}, ${cheaper.price})" class="ml-2 text-[11px] text-green-700">×”×—×œ×£</button></div>` : ''}
            </div>
            <button onclick="deleteItem(${i.id})" class="text-xs text-red-500">××—×§</button>
          `;
          list.appendChild(row);
        });
      });
    }

    async function submitShopItem() {
      const item = document.getElementById('shop-item').value.trim();
      const qty = Number(document.getElementById('shop-quantity').value || 1);
      const est = Number(document.getElementById('shop-est-price').value || 0) || null;
      if (!item) return alert('×™×© ×œ×”×–×™×Ÿ ×¤×¨×™×˜');
      const res = await fetch(`${API}/shopping/add`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ itemName: item, quantity: qty, userId: currentUser.id, estPrice: est })});
      const j = await res.json();
      if (j.success) { document.getElementById('shop-item').value=''; fetchData(); }
    }

    async function updateShop(id, s) { await fetch(`${API}/shopping/update`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ itemId: id, status: s })}); fetchData(); }
    async function deleteItem(id) { if (!confirm('×œ××—×•×§ ×¤×¨×™×˜ ×–×”?')) return; await fetch(`${API}/shopping/update`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ itemId:id, status:'deleted' })}); fetchData(); }

    function applyCheapestPrice(itemId, price) {
      const it = shoppingListCache.find(x => x.id === Number(itemId));
      if (it) it.suggested_price = Number(price);
      alert(`××—×™×¨ â‚ª${price} × ×©××¨ ×›×”×¦×¢×” ×œ×¤×¨×™×˜`);
    }

    function openCheckout() {
      const inCart = shoppingListCache.filter(i => i.status === 'in_cart');
      if (inCart.length === 0) return alert('××™×Ÿ ×¤×¨×™×˜×™× ××¡×•×× ×™× ×‘×¢×’×œ×”');
      const container = document.getElementById('checkout-items-list'); container.innerHTML = '';
      inCart.forEach(item=>{
        const div = document.createElement('div');
        div.className = 'bg-slate-50 p-3 rounded-xl border flex flex-col gap-2 item-row';
        div.dataset.id = item.id; div.dataset.name = item.item_name;
        div.innerHTML = `<div class="flex justify-between items-center"><div class="font-bold">${item.item_name}</div><button onclick="toggleMissingInRow(this)" class="text-xs bg-white border px-2 py-1 rounded">×—×¡×¨</button></div><div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs">â‚ª</span><input type="number" step="0.1" class="checkout-price-input w-full border rounded p-2 pl-8" value="${item.suggested_price||item.est_price||''}"></div>`;
        container.appendChild(div);
      });
      calcCheckoutTotal(); document.getElementById('checkout-modal').classList.remove('hidden');
    }

    function closeCheckout(){ document.getElementById('checkout-modal').classList.add('hidden'); }
    function toggleMissingInRow(btn){ const row = btn.closest('.item-row'); row.classList.toggle('is-missing'); row.querySelector('.checkout-price-input').disabled = row.classList.contains('is-missing'); calcCheckoutTotal(); }
    function calcCheckoutTotal(){ let total=0; document.querySelectorAll('.checkout-price-input').forEach(inp=>{ if(!inp.disabled) total+=parseFloat(inp.value)||0; }); document.getElementById('checkout-total-display').innerText = `â‚ª${total.toFixed(2)}`; document.getElementById('cart-total-display').innerText = `â‚ª${total.toFixed(2)}`; }

    async function submitSmartCheckout(){
      const store = document.getElementById('checkout-store').value || '×¡×•×¤×¨ ×›×œ×œ×™';
      let total = 0; const boughtItems = [], missingItems = [];
      document.querySelectorAll('.item-row').forEach(row=>{ const id=row.dataset.id, name=row.dataset.name; if(row.classList.contains('is-missing')) missingItems.push({id}); else { const price=parseFloat(row.querySelector('.checkout-price-input').value)||0; total+=price; boughtItems.push({id,name,quantity:1,price}); } });
      if(boughtItems.length===0) return alert('×œ× × ×‘×—×¨×• ×¤×¨×™×˜×™×');
      if(total===0){ const manual = prompt('×œ× ×”×•×–× ×• ××—×™×¨×™×. ××” ×”×¡×›×•× ×”×›×•×œ×œ?'); if(!manual) return; total = parseFloat(manual)||0; }
      await fetch(`${API}/shopping/checkout`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ totalAmount:total, userId:currentUser.id, storeName:store, boughtItems, missingItems })});
      closeCheckout(); alert('×”×§× ×™×™×” ×”×•×©×œ××”'); fetchData();
    }

    /* History modal */
    async function openHistoryModal(){
      const res = await fetch(`${API}/shopping/history?groupId=${currentGroup.id}`); const trips = await res.json();
      const list = document.getElementById('history-list'); list.innerHTML='';
      if(trips.length===0) list.innerHTML='<p class="text-center text-slate-400">××™×Ÿ ×”×™×¡×˜×•×¨×™×”</p>';
      trips.forEach(t=>{ const div=document.createElement('div'); const itemsHtml=t.items.map(i=>`<span class="text-xs bg-slate-100 px-2 py-1 rounded ml-1">${i.item_name} (x${i.quantity}) - â‚ª${i.price}</span>`).join(' '); div.className='bg-slate-50 p-3 rounded-xl'; div.innerHTML=`<div class="flex justify-between items-start mb-2"><div><h4 class="font-bold">${t.store_name}</h4><p class="text-xs text-slate-500">${new Date(t.trip_date).toLocaleDateString()} â€¢ ${t.nickname}</p></div><div class="font-bold text-slate-700">â‚ª${t.total_amount}</div></div><div class="flex flex-wrap gap-1 mb-2">${itemsHtml}</div><div class="flex gap-2"><button onclick="copyList(${t.id})" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs">×”×¢×ª×§ ×¨×©×™××” ×–×•</button></div>`; list.appendChild(div); });
      document.getElementById('history-modal').classList.remove('hidden');
    }

    async function copyList(tripId){ if(!confirm('×œ×”×¢×ª×™×§ ××ª ×›×œ ×”×¤×¨×™×˜×™× ××”×¨×©×™××” ×”×–×•?')) return; await fetch(`${API}/shopping/copy`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tripId, userId: currentUser.id })}); alert('×”×¨×©×™××” ×”×•×¢×ª×§×”'); fetchData(); document.getElementById('history-modal').classList.add('hidden'); }

    /* Suggestions */
    async function suggestProducts(){
      const q = document.getElementById('shop-item').value.trim(); const sugg = document.getElementById('suggestions');
      if(!q){ sugg.classList.add('hidden'); return; }
      const res = await fetch(`${API}/products/search?q=${encodeURIComponent(q)}`); const arr = await res.json();
      sugg.innerHTML = arr.map(p=>`<div class="p-2 suggestion-item" onclick="pickSuggestion('${escapeHtml(p.name)}')">${p.name} <span class="text-xs text-slate-400">â€¢ ${p.category}</span></div>`).join('');
      sugg.classList.remove('hidden');
    }
    function pickSuggestion(name){ document.getElementById('shop-item').value = name; document.getElementById('suggestions').classList.add('hidden'); }

    /* Crowd wisdom */
    async function fetchCheapestFromHistory(){
      try {
        const res = await fetch(`${API}/shopping/history?groupId=${currentGroup.id}`); const trips = await res.json();
        const cheapest = {};
        trips.forEach(t=> t.items.forEach(i=> { if(!i.price) return; const name=i.item_name; const price=Number(i.price); if(!cheapest[name]||price<cheapest[name].price) cheapest[name]={ price, store_name: t.store_name, recorded_at: t.trip_date }; }));
        return cheapest;
      } catch(e){ return {}; }
    }

    /* ---------- ACADEMY ---------- */
    function renderAcademy(bundles){
      const list=document.getElementById('academy-list'); list.innerHTML='';
      bundles.forEach(b=>{ const div=document.createElement('div'); div.className='bg-white p-3 rounded-xl border flex justify-between items-center'; div.innerHTML=`<div><div class="font-bold">${b.title}</div><div class="text-xs text-slate-500">×¤×¨×¡: â‚ª${b.reward} â€¢ ×¦×™×•×Ÿ ×¢×•×‘×¨: ${b.threshold}</div></div><button onclick="startQuiz(${b.id})" class="bg-purple-600 text-white px-3 py-1 rounded">×”×ª×—×œ</button>`; list.appendChild(div); });
    }

    let currentQuizData=null, currentQuestionIndex=0, quizScore=0;
    async function startQuiz(bundleId){ const res=await fetch(`${API}/academy/bundles`); const b=await res.json(); const bundle=b.find(x=>x.id===bundleId); if(!bundle) return; currentQuizData=bundle; currentQuestionIndex=0; quizScore=0; document.getElementById('quiz-runner-modal')?.classList.remove('hidden'); renderQuestion(); }
    function renderQuestion(){ if(!currentQuizData) return; const q=currentQuizData.questions[currentQuestionIndex]; document.getElementById('q-progress')?.innerText=`${currentQuestionIndex+1} / ${currentQuizData.questions.length}`; document.getElementById('q-text').innerText=q.q; const opts=document.getElementById('q-options'); if(!opts) return; opts.innerHTML=''; q.options.forEach((opt,idx)=>{ const b=document.createElement('button'); b.className='w-full p-2 rounded border text-right'; b.innerText=opt; b.onclick=()=>submitAnswer(idx); opts.appendChild(b); }); }
    async function submitAnswer(selectedIdx){ const q=currentQuizData.questions[currentQuestionIndex]; const isCorrect = selectedIdx === q.correct; if(isCorrect) quizScore++; const btns=document.querySelectorAll('#q-options button'); btns[selectedIdx].classList.add(isCorrect?'bg-green-100':'bg-red-100'); if(!isCorrect) btns[q.correct]?.classList.add('bg-green-100'); setTimeout(()=>{ currentQuestionIndex++; if(currentQuestionIndex<currentQuizData.questions.length) renderQuestion(); else finishQuiz(); },800); }
    async function finishQuiz(){ const total=currentQuizData.questions.length; const finalScore=Math.round((quizScore/total)*100); const passed=finalScore>=currentQuizData.threshold; document.getElementById('quiz-result')?.classList.remove('hidden'); if(passed){ await fetch(`${API}/academy/submit`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: currentUser.id, bundleId: currentQuizData.id, score: finalScore, reward: currentQuizData.reward })}); alert('×¢×‘×¨×ª ×•×§×™×‘×œ×ª ×¤×¨×¡!'); fetchData(); } else alert('×œ× ×¢×‘×¨, × ×¡×” ×©×•×‘'); }

    /* ---------- TASKS ---------- */
    function renderTasks(tasks){
      const list=document.getElementById('tasks-list'); list.innerHTML=''; if(!tasks||tasks.length===0){ list.innerHTML='<div class="text-center py-6 text-slate-400">××™×Ÿ ××©×™××•×ª</div>'; return; }
      tasks.forEach(t=>{ const div=document.createElement('div'); div.className='bg-white p-3 rounded-xl flex justify-between items-center'; div.innerHTML=`<div><div class="font-bold">${t.title}</div><div class="text-xs text-slate-500">${t.assignee_name||''}</div></div><div>${t.status!=='done'?`<button onclick="updateTask(${t.id}, 'done')" class="bg-blue-600 text-white px-3 py-1 rounded">×¡××Ÿ ×›×‘×•×¦×¢</button>`:''}</div>`; list.appendChild(div); });
    }

    async function openTaskModal(){ const title = prompt('×©× ×”××©×™××”'); if(!title) return; const assignee = prompt('××–×”×” ×××•× ×” (id) ××• ×¨×™×§'); await fetch(`${API}/tasks`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title, reward:0, assignedTo: assignee?Number(assignee):null, groupId: 1 })}); fetchData(); }
    async function updateTask(id, s){ await fetch(`${API}/tasks/update`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ taskId: id, status: s })}); fetchData(); }

    /* ---------- MEMBERS & ADMIN ---------- */
    async function renderMembers(){ const res = await fetch(`${API}/data/${currentUser.id}`); const j = await res.json(); membersCache = (await fetchMembers()); const el=document.getElementById('members-list'); if(!el) return; el.innerHTML=''; const users = (await fetch(`/api/users/${currentUser.id}`)).ok ? [j.user] : []; el.innerHTML = `<div class="text-sm">××©×ª××©: ${j.user.nickname} â€¢ ×ª×¤×§×™×“: ${j.user.role}</div>`; }
    async function fetchMembers(){ const res = await fetch(`${API}/data/${currentUser.id}`); const j = await res.json(); return j.members || []; }

    /* Bank PayDay trigger (client -> server) */
    async function triggerPayday(){
      if(!confirm('×œ×”×¨×™×¥ PayDay?')) return;
      const res = await fetch(`${API}/bank/payday`, { method: 'POST' });
      if(res.ok) { alert('×‘×•×¦×¢ PayDay'); fetchData(); }
    }
    function openBankSettingsModal(){ const uid = prompt('××–×”×” ××©×ª××© ×œ×©×™× ×•×™ ×”×’×“×¨×•×ª (id)'); if(!uid) return; const allowance = prompt('×“××™ ×›×™×¡ ×—×“×©×™×'); const interest = prompt('×¨×™×‘×™×ª ×—×“×©×” (×œ××©×œ 0.01)'); fetch(`${API}/bank/settings`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: Number(uid), allowance: Number(allowance), interest: Number(interest) })}).then(()=>fetchData()); }

    /* Helpers */
    function debounce(fn, wait=250){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }
    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    async function fetchCheapestFromHistory(){ try { const res = await fetch(`${API}/shopping/history?groupId=${currentGroup.id}`); const trips = await res.json(); const cheapest={}; trips.forEach(t=>t.items.forEach(i=>{ if(!i.price) return; const name=i.item_name; const price=Number(i.price); if(!cheapest[name]||price<cheapest[name].price) cheapest[name]={ price, store_name: t.store_name, recorded_at: t.trip_date }; })); return cheapest; } catch(e){ return {}; } }

    /* Suggest helpers */
    async function suggestProductsImmediate(q){ if(!q) return []; const res = await fetch(`${API}/products/search?q=${encodeURIComponent(q)}`); return await res.json(); }

    /* Quick fetch members wrapper */
    async function fetchMembersRaw(){ try { const r = await fetch(`${API}/data/${currentUser.id}`); if(!r.ok) return []; const j = await r.json(); return j.members || []; } catch(e){ return []; } }

    /* Quick calc cart total */
    function calcCartTotal(){ let total=0; shoppingListCache.filter(i=>i.status==='in_cart').forEach(i=> total += Number(i.suggested_price||i.est_price||0)); document.getElementById('cart-total-display').innerText = `â‚ª${total.toFixed(2)}`; }

  </script>
</body>
</html>
