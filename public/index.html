<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OneFlow Life</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Modern Font: Rubik -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Rubik', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        
        /* Modern Loader */
        .loader { width: 20px; height: 20px; border: 3px solid #e2e8f0; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Slider Tabs */
        .tab-btn { transition: all 0.3s ease; white-space: nowrap; border-radius: 9999px; padding: 0.6rem 1.2rem; font-size: 0.9rem; border: 1px solid transparent; background: white; color: #64748b; font-weight: 500; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .tab-active { background: #2563eb; color: white; border-color: #2563eb; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2); transform: translateY(-1px); }
        
        /* Cards & Inputs */
        .card-modern { background: white; border-radius: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02); border: 1px solid #f1f5f9; }
        .input-modern { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 0.8rem 1rem; width: 100%; transition: all 0.2s; outline: none; }
        .input-modern:focus { border-color: #3b82f6; background: white; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body class="text-slate-800">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur-md px-6 py-3 rounded-full shadow-xl border border-slate-100 hidden z-50 flex items-center gap-3 transition-all duration-300">
        <div id="toast-icon-bg" class="w-8 h-8 rounded-full flex items-center justify-center"><i id="toast-icon" class="text-white text-sm"></i></div>
        <span id="toast-message" class="font-medium text-sm text-slate-700"></span>
    </div>

    <div class="min-h-screen flex items-center justify-center p-4">
        
        <!-- Auth Container -->
        <div id="auth-container" class="w-full max-w-md bg-white rounded-[2rem] shadow-2xl overflow-hidden fade-in border border-slate-100">
            <div class="p-10 text-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                <div class="relative z-10">
                    <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-4 backdrop-blur-sm border border-white/10 shadow-lg">
                        <i class="fa-solid fa-wallet text-3xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold tracking-tight mb-1">OneFlow <span class="text-blue-200">Life</span></h1>
                    <p class="text-blue-100 text-sm font-light opacity-90">× ×™×”×•×œ ×¤×™× × ×¡×™ ×—×›× ×œ××©×¤×—×•×ª</p>
                </div>
            </div>

            <!-- Login View -->
            <div id="view-login" class="p-8">
                <h2 class="text-xl font-bold mb-6 text-slate-800">×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 mr-1">××™×™×œ ×§×‘×•×¦×”</label>
                        <input type="email" id="login-email" required class="input-modern" placeholder="admin@family.com">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 mr-1">×›×™× ×•×™</label>
                        <input type="text" id="login-nickname" required class="input-modern" placeholder="×œ××©×œ: ××‘×">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 mr-1">×¡×™×¡××”</label>
                        <input type="password" id="login-password" required class="input-modern" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-2xl transition shadow-lg shadow-blue-200 flex justify-center items-center mt-2">
                        <span id="btn-login-text">×”×ª×—×‘×¨</span>
                        <div id="btn-login-loader" class="loader hidden"></div>
                    </button>
                </form>
                <div class="mt-8 flex flex-col gap-3 text-center text-sm">
                    <button onclick="switchView('create')" class="text-blue-600 font-bold hover:bg-blue-50 py-2 rounded-xl transition">ğŸŒ± ××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? ×”×§× ×§×‘×•×¦×” ×—×“×©×”</button>
                    <button onclick="switchView('join')" class="text-slate-400 font-medium hover:text-slate-600">×¨×•×¦×” ×œ×”×¦×˜×¨×£ ×œ×§×‘×•×¦×” ×§×™×™××ª?</button>
                </div>
            </div>

            <!-- Create View -->
            <div id="view-create" class="p-8 hidden">
                <h2 class="text-xl font-bold mb-4 text-slate-800">×”×§××ª ×§×‘×•×¦×”</h2>
                <form onsubmit="handleCreate(event)" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div onclick="selectType('FAMILY')" id="type-family" class="cursor-pointer border-2 border-blue-500 bg-blue-50 text-blue-700 p-3 rounded-2xl text-center transition"><i class="fa-solid fa-heart mb-1 text-lg"></i><div class="font-bold text-xs">××©×¤×—×”</div></div>
                        <div onclick="selectType('GROUP')" id="type-group" class="cursor-pointer border-2 border-slate-100 text-slate-400 p-3 rounded-2xl text-center hover:border-blue-200 transition"><i class="fa-solid fa-briefcase mb-1 text-lg"></i><div class="font-bold text-xs">×©×•×ª×¤×™×</div></div>
                    </div>
                    <input type="hidden" id="create-type" value="FAMILY">
                    <input type="text" id="create-group-name" required placeholder="×©× ×”×§×‘×•×¦×”" class="input-modern">
                    <input type="email" id="create-email" required placeholder="××™×™×œ ×× ×”×œ" class="input-modern">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="create-nickname" required placeholder="×›×™× ×•×™" class="input-modern">
                        <input type="number" id="create-year" required placeholder="×©× ×ª ×œ×™×“×”" class="input-modern">
                    </div>
                    <input type="password" id="create-password" required placeholder="×¡×™×¡××”" class="input-modern">
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-2xl mt-4 flex justify-center items-center shadow-lg shadow-green-200"><span id="btn-create-text">×¡×™×™× ×•×”×™×¨×©×</span><div id="btn-create-loader" class="loader hidden border-t-white"></div></button>
                </form>
                <button onclick="switchView('login')" class="w-full mt-4 text-slate-400 text-sm">×‘×™×˜×•×œ</button>
            </div>

            <!-- Join View -->
            <div id="view-join" class="p-8 hidden">
                <h2 class="text-xl font-bold mb-4 text-slate-800">×”×¦×˜×¨×¤×•×ª ×œ×§×‘×•×¦×”</h2>
                <form onsubmit="handleJoin(event)" class="space-y-4">
                    <input type="email" id="join-email" required placeholder="××™×™×œ ×× ×”×œ ×”×§×‘×•×¦×”" class="input-modern">
                    <input type="text" id="join-nickname" required placeholder="×›×™× ×•×™ ×¨×¦×•×™" class="input-modern">
                    <input type="number" id="join-year" required placeholder="×©× ×ª ×œ×™×“×”" class="input-modern">
                    <input type="password" id="join-password" required placeholder="×¡×™×¡××” ××™×©×™×ª" class="input-modern">
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-2xl mt-4 flex justify-center items-center shadow-lg shadow-indigo-200"><span id="btn-join-text">×©×œ×— ×‘×§×©×”</span><div id="btn-join-loader" class="loader hidden border-t-white"></div></button>
                </form>
                <button onclick="switchView('login')" class="w-full mt-4 text-slate-400 text-sm">×‘×™×˜×•×œ</button>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard-container" class="w-full max-w-xl hidden fade-in pb-32">
            <!-- Header -->
            <header class="bg-white/80 backdrop-blur-md rounded-[1.5rem] shadow-sm p-4 mb-6 flex justify-between items-center sticky top-4 z-20 border border-white">
                <div class="flex items-center gap-3">
                    <div id="group-icon" class="w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold shadow-md"></div>
                    <div>
                        <h1 id="dash-group-name" class="font-bold text-slate-800 text-lg leading-tight"></h1>
                        <p class="text-xs text-slate-500">×”×™×™ <span id="dash-nickname" class="font-bold text-blue-600"></span></p>
                    </div>
                </div>
                <button onclick="logout()" class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 hover:bg-red-50 hover:text-red-500 transition"><i class="fa-solid fa-right-from-bracket"></i></button>
            </header>

            <!-- Slider Tabs (Fix 15) -->
            <div class="flex overflow-x-auto gap-3 mb-6 pb-2 no-scrollbar px-1">
                <button onclick="switchTab('feed')" id="tab-feed" class="tab-btn tab-active">×¤×™×“ ğŸ“Š</button>
                <button onclick="switchTab('budget')" id="tab-budget" class="tab-btn">×ª×§×¦×™×‘ ğŸ’°</button>
                <button onclick="switchTab('tasks')" id="tab-tasks" class="tab-btn">××©×™××•×ª âœ…</button>
                <button onclick="switchTab('shop')" id="tab-shop" class="tab-btn">×§× ×™×•×ª ğŸ›’</button>
                <button onclick="switchTab('loans')" id="tab-loans" class="tab-btn">×”×œ×•×•××•×ª ğŸ’¸</button>
                <button onclick="switchTab('members')" id="tab-members" class="tab-btn">× ×™×”×•×œ ğŸ‘¥</button>
            </div>

            <!-- 1. FEED -->
            <div id="content-feed">
                <div class="bg-gradient-to-br from-indigo-600 to-purple-700 text-white p-8 rounded-[2rem] shadow-xl shadow-indigo-200 text-center mb-8 relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-indigo-200 text-sm font-medium mb-1 tracking-wide uppercase">×”×™×ª×¨×” ×”× ×•×›×—×™×ª</p>
                        <h1 class="text-5xl font-black tracking-tight drop-shadow-sm" id="user-balance">â‚ª0.00</h1>
                    </div>
                    <i class="fa-solid fa-wallet absolute -bottom-6 -right-6 text-[8rem] opacity-10 rotate-12"></i>
                    <i class="fa-solid fa-coins absolute top-4 left-4 text-4xl opacity-10"></i>
                </div>
                
                <h3 class="font-bold text-slate-700 mb-3 px-2 flex items-center gap-2 text-lg"><i class="fa-solid fa-clock-rotate-left text-blue-500"></i> ×¤×¢×™×œ×•×ª ××—×¨×•× ×”</h3>
                <div id="transactions-list" class="space-y-3"></div>
            </div>

            <!-- 2. BUDGET (Fix 9) -->
            <div id="content-budget" class="hidden">
                <div class="card-modern p-6">
                    <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2 text-lg"><i class="fa-solid fa-chart-pie text-teal-500"></i> ×¡×˜×˜×•×¡ ×ª×§×¦×™×‘</h3>
                    <div id="budget-list" class="space-y-6"></div>
                </div>
            </div>

            <!-- 3. TASKS -->
            <div id="content-tasks" class="hidden space-y-4">
                <div class="flex justify-between items-center mb-2 px-2">
                    <h3 class="font-bold text-slate-700 text-lg">××©×™××•×ª</h3>
                    <button onclick="openTaskModal()" id="btn-add-task" class="text-xs bg-blue-600 text-white px-4 py-2 rounded-full font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition hidden"><i class="fa-solid fa-plus mr-1"></i> ×—×“×©×”</button>
                </div>
                <div id="tasks-list" class="space-y-3"></div>
            </div>

            <!-- 4. SHOPPING -->
            <div id="content-shop" class="hidden space-y-4">
                <div class="flex justify-between items-center mb-2 px-2">
                    <h3 class="font-bold text-slate-700 text-lg">×¨×©×™××ª ×§× ×™×•×ª</h3>
                    <button onclick="openShopModal()" class="text-xs bg-pink-500 text-white px-4 py-2 rounded-full font-bold shadow-lg shadow-pink-200 hover:bg-pink-600 transition"><i class="fa-solid fa-plus mr-1"></i> ×¤×¨×™×˜</button>
                </div>
                <div id="shop-list" class="space-y-2 mb-20"></div>
                <div id="checkout-bar" class="fixed bottom-24 left-4 right-4 bg-white/90 backdrop-blur border border-slate-200 p-4 rounded-2xl shadow-2xl flex justify-between items-center hidden z-30">
                    <span class="font-bold text-slate-700">×¡×™×™××ª× ×œ×§× ×•×ª?</span>
                    <button onclick="checkout()" class="bg-green-600 text-white px-6 py-2.5 rounded-xl font-bold shadow-md hover:bg-green-700 transition">×¡×™×•× ×•×—×™×•×‘</button>
                </div>
            </div>

            <!-- 5. LOANS -->
            <div id="content-loans" class="hidden space-y-4">
                <div class="flex justify-between items-center mb-2 px-2">
                    <h3 class="font-bold text-slate-700 text-lg">×”×œ×•×•××•×ª</h3>
                    <button onclick="openLoanModal()" class="text-xs bg-indigo-600 text-white px-4 py-2 rounded-full font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition"><i class="fa-solid fa-hand-holding-dollar mr-1"></i> ×‘×§×©×”</button>
                </div>
                <div id="loans-list" class="space-y-3"></div>
            </div>

            <!-- 6. MEMBERS -->
            <div id="content-members" class="hidden space-y-6">
                <div class="card-modern overflow-hidden">
                    <div class="p-4 border-b border-slate-50 bg-slate-50/50">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fa-solid fa-user-group text-blue-500"></i> ×—×‘×¨×™ ×”×§×‘×•×¦×”</h3>
                    </div>
                    <div id="members-list" class="divide-y divide-slate-50 p-2"></div>
                </div>
                <div id="admin-panel" class="card-modern overflow-hidden hidden border-yellow-200 bg-yellow-50/30">
                    <div class="p-4 border-b border-yellow-100">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fa-solid fa-user-clock text-yellow-500"></i> ×××ª×™× ×™× ×œ××™×©×•×¨</h3>
                        <span id="pending-count" class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden">0</span>
                    </div>
                    <div id="pending-list" class="divide-y divide-yellow-100/50 p-2"></div>
                </div>
            </div>

            <!-- Actions -->
            <div id="floating-actions" class="fixed bottom-8 left-0 w-full px-4 flex justify-center gap-6 pointer-events-none z-30">
                <button onclick="openTransactionModal('expense')" class="pointer-events-auto bg-white text-red-500 w-16 h-16 rounded-full shadow-xl flex items-center justify-center text-2xl transition transform hover:scale-110 active:scale-95 border-4 border-red-50 hover:border-red-100"><i class="fa-solid fa-minus"></i></button>
                <button onclick="openTransactionModal('income')" class="pointer-events-auto bg-blue-600 text-white w-16 h-16 rounded-full shadow-xl shadow-blue-300 flex items-center justify-center text-2xl transition transform hover:scale-110 active:scale-95 border-4 border-blue-500"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

        <!-- Modals -->
        <div id="transaction-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white w-full max-w-sm rounded-t-[2rem] sm:rounded-[2rem] p-8 shadow-2xl animate-[fadeIn_0.3s_ease-out]">
                <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6 sm:hidden"></div>
                <h3 id="trans-modal-title" class="text-xl font-bold mb-6 text-center text-slate-800"></h3>
                <input type="hidden" id="trans-type">
                <input type="number" id="trans-amount" class="w-full p-4 border-2 border-slate-100 rounded-2xl mb-4 text-4xl text-center font-bold outline-none focus:border-blue-500 transition text-slate-800 placeholder-slate-200" placeholder="0.00">
                <input type="text" id="trans-desc" class="input-modern mb-3" placeholder="×ª×™××•×¨ (×œ××©×œ: ×¤×™×¦×”)">
                <select id="trans-cat" class="input-modern mb-8 bg-white"></select>
                <div class="flex gap-3">
                    <button onclick="document.getElementById('transaction-modal').classList.add('hidden')" class="flex-1 bg-slate-100 py-3.5 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition">×‘×™×˜×•×œ</button>
                    <button onclick="submitTransaction()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl font-bold transition shadow-lg shadow-blue-200">×©××•×¨</button>
                </div>
            </div>
        </div>

        <div id="task-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl">
                <h3 class="text-xl font-bold mb-4 text-center">××©×™××” ×—×“×©×”</h3>
                <input type="text" id="task-title" class="input-modern mb-3" placeholder="××” ×¦×¨×™×š ×œ×¢×©×•×ª?">
                <input type="number" id="task-reward" class="input-modern mb-3" placeholder="×ª×’××•×œ (â‚ª)">
                <select id="task-assignee" class="input-modern mb-6 bg-white"></select>
                <div class="flex gap-3">
                    <button onclick="document.getElementById('task-modal').classList.add('hidden')" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-600">×‘×™×˜×•×œ</button>
                    <button onclick="submitTask()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">×¦×•×¨</button>
                </div>
            </div>
        </div>

        <div id="shop-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl">
                <h3 class="text-xl font-bold mb-4 text-center">×”×•×¡×¤×” ×œ×§× ×™×•×ª</h3>
                <input type="text" id="shop-item" class="input-modern mb-6" placeholder="××” ×—×¡×¨?">
                <div class="flex gap-3">
                    <button onclick="document.getElementById('shop-modal').classList.add('hidden')" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-600">×‘×™×˜×•×œ</button>
                    <button onclick="submitShopItem()" class="flex-1 bg-pink-500 text-white py-3 rounded-xl font-bold">×”×•×¡×£</button>
                </div>
            </div>
        </div>

        <div id="loan-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl">
                <h3 class="text-xl font-bold mb-4 text-center">×‘×§×©×ª ×”×œ×•×•××”</h3>
                <input type="number" id="loan-amount" class="input-modern mb-3" placeholder="×›××” ×¦×¨×™×š?">
                <input type="text" id="loan-reason" class="input-modern mb-6" placeholder="×œ××”?">
                <div class="flex gap-3">
                    <button onclick="document.getElementById('loan-modal').classList.add('hidden')" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-600">×‘×™×˜×•×œ</button>
                    <button onclick="submitLoan()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">×©×œ×—</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const API = window.location.hostname === 'localhost' ? 'http://localhost:3000/api' : '/api';
        let currentUser = null;
        let currentGroup = null;
        let pollInterval = null;
        let membersCache = [];

        // Fix 11: Expanded Categories with Icons
        const CATEGORIES = {
            income: [ 
                {value:'salary',label:'ğŸ’¼ ××©×›×•×¨×ª'}, {value:'allowance',label:'ğŸ’° ×“××™ ×›×™×¡'}, {value:'gift',label:'ğŸ ××ª× ×”'}, 
                {value:'bonus',label:'ğŸŒŸ ×‘×•× ×•×¡'}, {value:'business',label:'ğŸš€ ×¢×¡×§'}, {value:'other',label:'âœ¨ ××—×¨'} 
            ],
            expense: [ 
                {value:'food',label:'ğŸ” ××•×›×œ'}, {value:'groceries',label:'ğŸ›’ ×¡×•×¤×¨'}, {value:'transport',label:'ğŸšŒ × ×¡×™×¢×•×ª'}, 
                {value:'bills',label:'ğŸ“„ ×—×©×‘×•× ×•×ª'}, {value:'fun',label:'ğŸ‰ ×‘×™×œ×•×™×™×'}, {value:'clothes',label:'ğŸ‘• ×‘×’×“×™×'},
                {value:'health',label:'ğŸ’Š ×‘×¨×™××•×ª'}, {value:'education',label:'ğŸ“š ×—×™× ×•×š'}, {value:'other',label:'ğŸ’¸ ××—×¨'} 
            ]
        };

        window.onload = async () => {
            const saved = localStorage.getItem('ofl_session');
            if(saved) {
                try {
                    const session = JSON.parse(saved);
                    const res = await fetch(`${API}/users/${session.user.id}`);
                    if(res.ok) {
                        currentUser = await res.json();
                        currentGroup = session.group;
                        localStorage.setItem('ofl_session', JSON.stringify({user: currentUser, group: currentGroup}));
                        loadDashboard();
                    } else logout();
                } catch(e) { logout(); }
            }
        };

        function switchView(view) { ['login','create','join'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden')); document.getElementById(`view-${view}`).classList.remove('hidden'); }
        function selectType(t) { document.getElementById('create-type').value=t; document.getElementById('type-family').className=`cursor-pointer border-2 p-3 rounded-2xl text-center transition ${t==='FAMILY'?'border-blue-500 bg-blue-50 text-blue-700':'border-slate-100 text-slate-400'}`; document.getElementById('type-group').className=`cursor-pointer border-2 p-3 rounded-2xl text-center transition ${t==='GROUP'?'border-blue-500 bg-blue-50 text-blue-700':'border-slate-100 text-slate-400'}`; }
        
        async function handleLogin(e) { e.preventDefault(); authAction('login', { groupEmail: val('login-email'), nickname: val('login-nickname'), password: val('login-password') }); }
        async function handleCreate(e) { e.preventDefault(); authAction('groups', { type: val('create-type'), groupName: val('create-group-name'), adminEmail: val('create-email'), adminNickname: val('create-nickname'), birthYear: val('create-year'), password: val('create-password') }); }
        async function handleJoin(e) { e.preventDefault(); const res = await fetch(`${API}/join`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ groupEmail: val('join-email'), nickname: val('join-nickname'), birthYear: val('join-year'), password: val('join-password') }) }); const d=await res.json(); d.success ? (showToast('success', '× ×©×œ×—!'), switchView('login')) : showToast('error', d.error); }

        async function authAction(endpoint, body) {
            toggleLoader('login', true); // generic loader toggle
            try {
                const res = await fetch(`${API}/${endpoint}`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
                const data = await res.json();
                if(data.success) {
                    currentUser = data.user; currentGroup = data.group;
                    localStorage.setItem('ofl_session', JSON.stringify({user:currentUser, group:currentGroup}));
                    loadDashboard();
                } else showToast('error', data.error);
            } catch(e) { showToast('error', '×©×’×™××”'); }
            finally { toggleLoader('login', false); }
        }

        function loadDashboard() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
            document.getElementById('dash-group-name').innerText = currentGroup.name;
            document.getElementById('dash-nickname').innerText = currentUser.nickname;
            document.getElementById('user-balance').innerText = `â‚ª${currentUser.balance}`;
            document.getElementById('group-icon').innerHTML = currentGroup.type==='FAMILY'?'<i class="fa-solid fa-heart"></i>':'<i class="fa-solid fa-briefcase"></i>';
            document.getElementById('group-icon').className = `w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold shadow-md ${currentGroup.type==='FAMILY'?'bg-pink-500':'bg-blue-500'}`;
            
            if(currentUser.role === 'ADMIN') {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('btn-add-task').classList.remove('hidden');
                document.getElementById('checkout-bar').classList.remove('hidden');
                fetchPendingUsers();
                if(!pollInterval) pollInterval = setInterval(() => { fetchPendingUsers(); fetchData(); }, 5000);
            }
            fetchMembers();
            fetchData();
        }

        async function fetchData() {
            try {
                const res = await fetch(`${API}/data/${currentUser.id}`);
                const data = await res.json();
                currentUser.balance = data.user.balance;
                document.getElementById('user-balance').innerText = `â‚ª${currentUser.balance}`;
                
                // Transactions
                const tList = document.getElementById('transactions-list'); tList.innerHTML='';
                const recentT = await (await fetch(`${API}/transactions?groupId=${currentGroup.id}&userId=${currentUser.id}&limit=5`)).json();
                if(recentT.length === 0) tList.innerHTML = '<p class="text-center text-slate-400 py-4 text-sm">××™×Ÿ ×¤×¢×™×œ×•×ª ×¢×“×™×™×Ÿ</p>';
                recentT.forEach(t => tList.innerHTML+=`<div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-50 flex justify-between items-center"><div><p class="font-bold text-slate-800">${t.description} <span class="text-xs text-slate-400 font-normal">(${t.user_name})</span></p><p class="text-[10px] text-slate-400">${new Date(t.date).toLocaleDateString()}</p></div><span class="font-bold text-lg ${t.type==='income'?'text-green-500':'text-red-500'}">${t.type==='income'?'+':'-'}â‚ª${t.amount}</span></div>`);

                // Budget (Fix 9)
                const bList = document.getElementById('budget-list'); bList.innerHTML='';
                if(data.budget_status.length === 0) bList.innerHTML = '<p class="text-slate-400 text-center text-sm py-4">××™×Ÿ ×ª×§×¦×™×‘ ××•×’×“×¨</p>';
                data.budget_status.forEach(b => {
                    const pct = Math.min(100, Math.round((b.spent/b.limit)*100)) || 0;
                    let color = 'bg-blue-500'; if(pct>75) color='bg-yellow-500'; if(pct>=100) color='bg-red-500';
                    const categoryMap = {'food':'××•×›×œ','groceries':'×¡×•×¤×¨','transport':'× ×¡×™×¢×•×ª','bills':'×—×©×‘×•× ×•×ª','fun':'×‘×™×œ×•×™×™×','other':'××—×¨'};
                    const label = categoryMap[b.category] || b.category;
                    bList.innerHTML+=`<div class="mb-4"><div class="flex justify-between text-sm mb-1 font-medium"><span class="text-slate-700">${label}</span><span class="text-slate-500 text-xs">â‚ª${b.spent} / ${b.limit}</span></div><div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden"><div class="${color} h-2.5 rounded-full transition-all duration-1000 ease-out" style="width:${pct}%"></div></div></div>`;
                });

                // Tasks (Fix 12, 13, 14)
                const taskList = document.getElementById('tasks-list'); taskList.innerHTML='';
                if(data.tasks.length === 0) taskList.innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-clipboard-check text-4xl text-slate-200 mb-2"></i><p class="text-slate-400 text-sm">××™×Ÿ ××©×™××•×ª</p></div>';
                
                data.tasks.forEach(t => {
                    let action = '';
                    const isMyTask = t.assigned_to == currentUser.id;
                    const isAdmin = currentUser.role === 'ADMIN';
                    
                    if(t.status === 'pending') {
                        // Fix 12: Admin self-task
                        if(isMyTask) action = `<button onclick="updateTask(${t.id}, '${isAdmin ? 'completed_self' : 'done'}')" class="bg-blue-600 text-white px-4 py-1.5 rounded-xl text-xs font-bold shadow-md shadow-blue-100 hover:bg-blue-700 transition">×¡×™×™××ª×™</button>`;
                        else if(isAdmin) action = `<span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded-lg">×××ª×™×Ÿ ×œ×‘×™×¦×•×¢</span>`;
                    } else if (t.status === 'done') {
                        if(isAdmin) action = `<button onclick="updateTask(${t.id}, 'approved')" class="bg-green-500 text-white px-4 py-1.5 rounded-xl text-xs font-bold shadow-md shadow-green-100">××©×¨</button>`;
                        else action = `<span class="text-xs text-orange-500 font-bold bg-orange-50 px-2 py-1 rounded-lg">×××ª×™×Ÿ ×œ××™×©×•×¨</span>`;
                    }
                    taskList.innerHTML+=`<div class="card-modern p-4 flex justify-between items-center"><div><p class="font-bold text-slate-800">${t.title}</p><div class="flex items-center gap-2 mt-1"><img src="https://ui-avatars.com/api/?name=${t.assignee_name}&background=random&size=16" class="w-4 h-4 rounded-full"><span class="text-xs text-slate-500">${t.assignee_name}</span><span class="text-xs font-bold text-blue-600 bg-blue-50 px-1.5 rounded">â‚ª${t.reward}</span></div></div>${action}</div>`;
                });

                // Loans (Fix 15)
                const lList = document.getElementById('loans-list'); lList.innerHTML='';
                if(data.loans.length === 0) lList.innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-piggy-bank text-4xl text-slate-200 mb-2"></i><p class="text-slate-400 text-sm">××™×Ÿ ×”×œ×•×•××•×ª</p></div>';
                
                data.loans.forEach(l => {
                    let action = '';
                    let badge = '';
                    // Fix 15: Status Badge for child
                    if(l.status==='active') badge = '<span class="bg-green-100 text-green-700 text-[10px] px-2 py-1 rounded-full font-bold flex items-center gap-1"><i class="fa-solid fa-check"></i> ××•×©×¨</span>';
                    else if(l.status==='rejected') badge = '<span class="bg-red-100 text-red-700 text-[10px] px-2 py-1 rounded-full font-bold flex items-center gap-1"><i class="fa-solid fa-xmark"></i> × ×“×—×”</span>';
                    else if(l.status==='pending') badge = '<span class="bg-yellow-100 text-yellow-700 text-[10px] px-2 py-1 rounded-full font-bold flex items-center gap-1"><i class="fa-solid fa-clock"></i> ×××ª×™×Ÿ</span>';

                    if(currentUser.role==='ADMIN' && l.status==='pending') action = `<div class="flex gap-2 mt-3 pt-3 border-t border-slate-50"><button onclick="handleLoan(${l.id}, 'active')" class="flex-1 bg-green-500 text-white py-1.5 rounded-lg text-xs font-bold">××©×¨</button><button onclick="handleLoan(${l.id}, 'rejected')" class="flex-1 bg-red-500 text-white py-1.5 rounded-lg text-xs font-bold">×“×—×”</button></div>`;
                    
                    lList.innerHTML+=`<div class="card-modern p-4 mb-3"> <div class="flex justify-between items-start"> <div><p class="font-bold text-slate-800 text-lg">${l.reason}</p><p class="text-xs text-slate-500 mt-1">${l.user_name} â€¢ <span class="font-bold text-slate-700">â‚ª${l.original_amount}</span></p></div> ${badge} </div> ${action} </div>`;
                });

                // Shop
                const sList = document.getElementById('shop-list'); sList.innerHTML='';
                if(data.shopping_list.length === 0) sList.innerHTML = '<p class="text-center text-slate-400 py-4 text-sm">×”×¢×’×œ×” ×¨×™×§×”</p>';
                data.shopping_list.forEach(i => {
                    sList.innerHTML+=`<div class="bg-white p-3 rounded-xl border border-slate-100 flex items-center gap-3 shadow-sm"><input type="checkbox" ${i.status==='in_cart'?'checked':''} onchange="updateShop(${i.id}, this.checked ? 'in_cart' : 'pending')" class="w-5 h-5 accent-pink-500 rounded cursor-pointer"><span class="${i.status==='in_cart'?'line-through text-slate-400':'text-slate-700'} font-medium">${i.item_name}</span><span class="mr-auto text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500">${i.requester_name}</span></div>`;
                });

            } catch(e) {}
        }

        async function fetchMembers() {
            const res = await fetch(`${API}/group/members?groupId=${currentGroup.id}`);
            const list = await res.json();
            membersCache = list; 
            const container = document.getElementById('members-list'); container.innerHTML = '';
            list.forEach(m => container.innerHTML+=`<div class="p-3 flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-9 h-9 bg-slate-100 rounded-full flex items-center justify-center font-bold text-slate-500 text-sm border-2 border-white shadow-sm">${m.nickname[0]}</div><span class="font-bold text-sm text-slate-700">${m.nickname}</span></div><span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-lg">â‚ª${m.balance}</span></div>`);
        }

        async function fetchPendingUsers() {
            const res = await fetch(`${API}/admin/pending-users?groupId=${currentGroup.id}`);
            const list = await res.json();
            const container = document.getElementById('pending-list'); 
            document.getElementById('pending-count').innerText = list.length;
            document.getElementById('pending-count').classList.toggle('hidden', list.length===0);
            document.getElementById('admin-panel').classList.toggle('hidden', list.length===0);
            
            container.innerHTML = '';
            list.forEach(u => container.innerHTML+=`<div class="p-3 flex justify-between items-center bg-white rounded-xl mb-1 shadow-sm"><span class="font-bold text-sm text-slate-700">${u.nickname}</span><button onclick="approveUser(${u.id})" class="text-xs bg-green-500 text-white px-3 py-1.5 rounded-lg font-bold shadow hover:bg-green-600 transition">××©×¨</button></div>`);
        }

        function switchTab(t) {
            ['feed','tasks','shop','loans','members','budget'].forEach(x => {
                document.getElementById(`content-${x}`).classList.add('hidden');
                document.getElementById(`tab-${x}`).classList.remove('tab-active');
            });
            document.getElementById(`content-${t}`).classList.remove('hidden');
            document.getElementById(`tab-${t}`).classList.add('tab-active');
            
            // Fix 13: Refresh dropdown
            if(t==='tasks') {
                const s = document.getElementById('task-assignee'); s.innerHTML='';
                membersCache.forEach(m => s.innerHTML+=`<option value="${m.id}">${m.nickname}</option>`);
            }
        }

        async function submitTransaction() {
            const amount = val('trans-amount'); if(!amount) return;
            await fetch(`${API}/transaction`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
                userId: currentUser.id, amount, description: val('trans-desc')||'×¤×¢×•×œ×”', category: val('trans-cat'), type: val('trans-type')
            })});
            document.getElementById('transaction-modal').classList.add('hidden');
            showToast('success', '×”×¤×¢×•×œ×” × ×©××¨×” ×‘×”×¦×œ×—×”!'); fetchData();
        }

        async function submitTask() {
            await fetch(`${API}/tasks`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ title: val('task-title'), reward: val('task-reward'), assignedTo: val('task-assignee') })});
            document.getElementById('task-modal').classList.add('hidden'); fetchData();
        }
        async function updateTask(id, s) { await fetch(`${API}/tasks/update`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({taskId:id, status:s})}); fetchData(); }
        async function submitShopItem() { await fetch(`${API}/shopping/add`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({itemName: val('shop-item'), userId: currentUser.id})}); document.getElementById('shop-modal').classList.add('hidden'); fetchData(); }
        async function updateShop(id, s) { await fetch(`${API}/shopping/update`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({itemId:id, status:s})}); fetchData(); }
        async function checkout() { 
            const total = prompt('×¡×›×•× ×”×§× ×™×™×” ×”×›×•×œ×œ:'); if(!total) return;
            await fetch(`${API}/shopping/checkout`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({totalAmount:total, userId:currentUser.id, storeName:'×¡×•×¤×¨', items:[]})});
            fetchData();
        }
        async function submitLoan() { await fetch(`${API}/loans/request`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:currentUser.id, amount:val('loan-amount'), reason:val('loan-reason')})}); document.getElementById('loan-modal').classList.add('hidden'); fetchData(); }
        async function handleLoan(id, s) { await fetch(`${API}/loans/handle`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({loanId:id, status:s})}); fetchData(); }
        async function approveUser(id) { await fetch(`${API}/admin/approve-user`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:id})}); fetchPendingUsers(); }

        function openTransactionModal(t) { document.getElementById('trans-type').value=t; document.getElementById('trans-modal-title').innerText=t==='income'?'×”×›× ×¡×” ×—×“×©×”':'×”×•×¦××” ×—×“×©×”'; const s=document.getElementById('trans-cat'); s.innerHTML=''; CATEGORIES[t].forEach(c=>s.innerHTML+=`<option value="${c.value}">${c.label}</option>`); document.getElementById('transaction-modal').classList.remove('hidden'); }
        function openTaskModal() { document.getElementById('task-modal').classList.remove('hidden'); }
        function openShopModal() { document.getElementById('shop-modal').classList.remove('hidden'); }
        function openLoanModal() { document.getElementById('loan-modal').classList.remove('hidden'); }
        function logout() { localStorage.removeItem('ofl_session'); location.reload(); }
        function val(id) { return document.getElementById(id).value; }
        
        function showToast(t,m) { 
            const el=document.getElementById('toast'); 
            const iconBg = document.getElementById('toast-icon-bg');
            const icon = document.getElementById('toast-icon');
            
            el.classList.remove('hidden'); 
            document.getElementById('toast-message').innerText=m; 
            
            if(t==='success') { iconBg.className='w-8 h-8 rounded-full flex items-center justify-center bg-green-500 shadow-md shadow-green-200'; icon.className='fa-solid fa-check text-white'; }
            else { iconBg.className='w-8 h-8 rounded-full flex items-center justify-center bg-red-500 shadow-md shadow-red-200'; icon.className='fa-solid fa-xmark text-white'; }
            
            setTimeout(()=>el.classList.add('hidden'),3000); 
        }
        function toggleLoader(a,s) { 
            const txt = document.getElementById(`btn-${a}-text`);
            const ldr = document.getElementById(`btn-${a}-loader`);
            if(txt && ldr) { txt.classList.toggle('hidden',s); ldr.classList.toggle('hidden',!s); }
        }
    </script>
</body>
</html>
