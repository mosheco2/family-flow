<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyFlow - ×”××œ×</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .modal { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .nav-tab.active { background-color: #eff6ff; color: #2563eb; border-color: #bfdbfe; font-weight: 800; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .item-in-cart { background-color: #f0fdf4 !important; border-color: #bbf7d0 !important; }
        .item-in-cart .item-text { text-decoration: line-through; color: #86efac; }
        .animate-item { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex justify-center">

    <!-- 1. ××¡×š ×˜×¢×™× ×” ×•×©×’×™××” -->
    <div id="connection-error" class="hidden fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 text-center">
        <div class="text-6xl mb-4">ğŸ”Œ</div>
        <h2 class="text-2xl font-black text-gray-800 mb-2">××™×Ÿ ×ª×§×©×•×¨×ª ×œ×©×¨×ª</h2>
        <p class="text-gray-500 mb-6">×œ× ×”×¦×œ×—× ×• ×œ×”×ª×—×‘×¨ ×œ×©×¨×ª FamilyFlow.<br>×•×“× ×©×”×©×¨×ª ×¨×¥ ×•×©×™×© ×—×™×‘×•×¨ ××™× ×˜×¨× ×˜.</p>
        <div class="w-full max-w-xs">
            <input type="text" id="manual-app-name" class="w-full p-3 border rounded-xl mb-3 text-center ltr" placeholder="×©× ×”××¤×œ×™×§×¦×™×” ×‘-Render">
            <button onclick="saveAppNameAndRetry()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-3">× ×¡×” ×©×•×‘</button>
            <button onclick="startDemoMode()" class="w-full bg-gray-200 text-gray-800 py-3 rounded-xl font-bold">×›× ×¡ ×‘××¦×‘ ×”×“×’××” (××•×¤×œ×™×™×Ÿ) ğŸš€</button>
        </div>
    </div>

    <!-- 2. ××¡×š ×‘×—×™×¨×ª ××©×ª××© -->
    <div id="login-screen" class="w-full max-w-md p-6 flex flex-col items-center min-h-screen justify-center">
        <div class="mb-8 text-center">
            <h1 class="text-5xl font-black text-gray-800 tracking-tighter text-blue-600">FamilyFlow</h1>
            <p class="text-gray-400 mt-2">××¢×¨×›×ª ×œ×—×™× ×•×š ×¤×™× × ×¡×™ ××©×¤×—×ª×™</p>
        </div>
        <div id="loading-spinner" class="mb-8">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-600"></i>
        </div>
        <div id="users-grid" class="grid grid-cols-2 gap-6 w-full hidden"></div>
    </div>

    <!-- 3. ×“×©×‘×•×¨×“ ×¨××©×™ -->
    <div id="dashboard" class="hidden w-full max-w-md pb-32 min-h-screen bg-gray-50">
        <!-- ×›×•×ª×¨×ª -->
        <header class="sticky top-0 bg-gray-50/95 backdrop-blur-sm z-20 px-6 py-4 flex justify-between items-center border-b border-gray-200">
            <div>
                <h1 id="user-name" class="text-2xl font-black text-gray-800"></h1>
                <span id="user-role" class="text-xs font-bold px-2 py-0.5 rounded-full bg-blue-100 text-blue-700"></span>
            </div>
            <button onclick="logout()" class="w-10 h-10 bg-white rounded-full shadow flex items-center justify-center text-gray-400 hover:text-red-500">
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </header>

        <!-- ×›×¨×˜×™×¡ ×™×ª×¨×” -->
        <div class="px-6 py-6">
            <div class="card bg-gradient-to-br from-blue-600 to-indigo-700 text-white p-8 text-center relative overflow-hidden transform transition hover:scale-[1.02]">
                <div class="relative z-10">
                    <p class="text-blue-200 text-sm font-medium mb-1">×™×ª×¨×” × ×•×›×—×™×ª</p>
                    <h2 id="balance" class="text-5xl font-black tracking-tighter mb-4">â‚ª0.00</h2>
                    <div id="child-stats" class="hidden flex justify-center gap-6 border-t border-white/20 pt-4 mt-2">
                        <div><span class="block text-xs text-blue-200">×“××™ ×›×™×¡</span><span id="weekly-allowance" class="font-bold text-lg">â‚ª0</span></div>
                        <div><span class="block text-xs text-blue-200">XP</span><span id="xp-points" class="font-bold text-lg">0</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ×ª×¤×¨×™×˜ × ×™×•×•×˜ -->
        <div class="px-4 mb-6">
            <div class="bg-white p-1 rounded-2xl shadow-sm flex">
                <button onclick="switchTab('tasks')" id="tab-tasks" class="nav-tab flex-1 py-3 rounded-xl text-sm font-medium text-gray-500 transition">××©×™××•×ª</button>
                <button onclick="switchTab('shopping')" id="tab-shopping" class="nav-tab flex-1 py-3 rounded-xl text-sm font-medium text-gray-500 transition">×§× ×™×•×ª ğŸ›’</button>
                <button onclick="switchTab('academy')" id="tab-academy" class="nav-tab flex-1 py-3 rounded-xl text-sm font-medium text-gray-500 transition">××§×“××™×”</button>
            </div>
        </div>

        <!-- ×ª×•×›×Ÿ: ××©×™××•×ª -->
        <div id="view-tasks" class="px-6 space-y-4 hidden">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-gray-800 text-lg">××©×™××•×ª ×¤×ª×•×—×•×ª</h3>
                <button onclick="refreshData()" class="text-blue-600 text-sm"><i class="fa-solid fa-arrows-rotate"></i></button>
            </div>
            <div id="tasks-list" class="space-y-3 pb-20"></div>
        </div>

        <!-- ×ª×•×›×Ÿ: ×§× ×™×•×ª (××©×•×“×¨×’) -->
        <div id="view-shopping" class="px-6 space-y-4 hidden">
            <div class="bg-white p-2 rounded-xl shadow-sm border border-gray-100 flex items-center gap-2 mb-4 relative z-20">
                <div class="w-10 h-10 bg-pink-100 rounded-lg flex items-center justify-center text-pink-600"><i class="fa-solid fa-cart-plus"></i></div>
                <input type="text" id="new-item-input" class="flex-1 outline-none text-sm bg-transparent" placeholder="×”×•×¡×£ ××•×¦×¨ (×œ××©×œ: ×—×œ×‘)..." autocomplete="off">
                <button onclick="addItemToCart()" class="bg-pink-600 text-white w-10 h-10 rounded-lg shadow-sm hover:bg-pink-700 transition"><i class="fa-solid fa-plus"></i></button>
            </div>
            
            <div id="shopping-list" class="space-y-3 pb-32"></div>

            <!-- Checkout Bar (Floating) -->
            <div id="checkout-bar" class="fixed bottom-4 left-4 right-4 bg-gray-900 text-white p-4 rounded-2xl shadow-2xl flex justify-between items-center hidden transform transition-all duration-300 translate-y-20 z-30">
                <div><span class="text-xs text-gray-400 block">×¡×”"×› ×œ×ª×©×œ×•×</span><span id="cart-total" class="font-bold text-xl">â‚ª0.00</span></div>
                <button onclick="checkout()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-xl font-bold text-sm shadow-lg transition transform active:scale-95">×¡×™×™× ×§× ×™×™×” <i class="fa-solid fa-check ml-1"></i></button>
            </div>
        </div>

        <!-- ×ª×•×›×Ÿ: ××§×“××™×” -->
        <div id="view-academy" class="px-6 space-y-4 hidden">
            <h3 class="font-bold text-gray-800 text-lg mb-2">××ª×’×¨×™× ×–××™× ×™×</h3>
            <div id="academy-list" class="grid grid-cols-1 gap-4 pb-20"></div>
        </div>
    </div>

    <!-- ××•×“×œ PIN -->
    <div id="pin-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-50 p-6">
        <div class="bg-white w-full max-w-xs rounded-3xl p-8 shadow-2xl text-center">
            <h3 id="pin-title" class="text-xl font-bold mb-6 text-gray-800">×”×›× ×¡ ×§×•×“ ×¡×•×“×™</h3>
            <input type="tel" id="pin-input" maxlength="4" class="w-full p-4 border-2 border-gray-200 rounded-2xl mb-6 text-center text-3xl font-mono tracking-[0.5em] outline-none" placeholder="â€¢â€¢â€¢â€¢">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="document.getElementById('pin-modal').classList.add('hidden')" class="py-3 bg-gray-100 rounded-xl">×‘×™×˜×•×œ</button>
                <button onclick="verifyPin()" class="py-3 bg-blue-600 text-white rounded-xl font-bold">×›× ×™×¡×”</button>
            </div>
        </div>
    </div>

    <script>
        const STORED_APP_NAME = localStorage.getItem('custom_app_name');
        const APP_NAME = STORED_APP_NAME || 'family-flow-app';
        const IS_LOCAL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        let API = IS_LOCAL ? 'http://localhost:3000/api' : `https://${APP_NAME}.onrender.com/api`;
        if (!IS_LOCAL && window.location.hostname.includes('onrender.com')) API = '/api'; 

        let currentUser = null;
        let isDemoMode = false;
        let appData = {};
        let shoppingCart = [];

        window.onload = async () => { if (STORED_APP_NAME) document.getElementById('manual-app-name').value = STORED_APP_NAME; await initApp(); };

        async function initApp() {
            try {
                const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), 5000);
                const res = await fetch(`${API}/public-users`, { signal: controller.signal }); clearTimeout(timeoutId);
                if (!res.ok) throw new Error("Server Error");
                const users = await res.json(); renderLoginUsers(users);
            } catch (error) { document.getElementById('loading-spinner').classList.add('hidden'); document.getElementById('connection-error').classList.remove('hidden'); }
        }

        function renderLoginUsers(users) {
            document.getElementById('loading-spinner').classList.add('hidden'); document.getElementById('users-grid').classList.remove('hidden');
            const grid = document.getElementById('users-grid'); grid.innerHTML = '';
            users.forEach(u => {
                grid.innerHTML += `<div onclick="openPinModal(${u.id}, '${u.name}', '${u.role}')" class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex flex-col items-center cursor-pointer hover:scale-105 transition"><div class="w-20 h-20 ${u.role==='parent'?'bg-blue-100 text-blue-600':'bg-green-100 text-green-600'} rounded-full flex items-center justify-center text-3xl mb-4"><i class="fa-solid ${u.role==='parent'?'fa-user-tie':'fa-child'}"></i></div><h3 class="font-bold text-gray-800 text-lg">${u.name}</h3></div>`;
            });
        }

        let tempUser = null;
        function openPinModal(id, name, role) { tempUser = { id, name, role }; document.getElementById('pin-title').innerText = `×©×œ×•× ${name}`; document.getElementById('pin-input').value = ''; document.getElementById('pin-modal').classList.remove('hidden'); setTimeout(()=>document.getElementById('pin-input').focus(),100); }
        async function verifyPin() {
            const pin = document.getElementById('pin-input').value;
            if (isDemoMode) { currentUser = tempUser; enterDashboard(); return; }
            try { const res = await fetch(`${API}/login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: tempUser.id, pin }) }); const data = await res.json();
                if (data.success) { currentUser = data.user; enterDashboard(); } else alert("×§×•×“ ×©×’×•×™");
            } catch (e) { alert("×©×’×™××”"); }
        }

        async function enterDashboard() {
            document.getElementById('pin-modal').classList.add('hidden'); document.getElementById('login-screen').classList.add('hidden'); document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('user-name').innerText = currentUser.name; document.getElementById('user-role').innerText = currentUser.role==='parent'?'×× ×”×œ':'×—×•×¡×š';
            if(currentUser.role==='child'){ document.getElementById('child-stats').classList.remove('hidden'); document.getElementById('weekly-allowance').innerText=`â‚ª${currentUser.weekly_allowance}`; document.getElementById('xp-points').innerText=currentUser.xp; }
            await refreshData(); switchTab('shopping');
        }

        async function refreshData() {
            if(isDemoMode) return;
            try { const res = await fetch(`${API}/data/${currentUser.id}`); appData = await res.json();
                document.getElementById('balance').innerText = `â‚ª${appData.user.balance}`;
                if(currentUser.role==='child') document.getElementById('xp-points').innerText = appData.user.xp;
                renderTasks(); renderShopping(); renderAcademy();
            } catch(e) {}
        }

        // --- Shopping Logic ---
        function renderShopping() {
            const container = document.getElementById('shopping-list'); container.innerHTML = ''; shoppingCart = [];
            if (!appData.shopping_list || appData.shopping_list.length === 0) { container.innerHTML = `<div class="text-center text-gray-400 py-10">×”×¨×©×™××” ×¨×™×§×” ğŸ›’</div>`; updateCartTotal(); return; }
            
            appData.shopping_list.forEach(item => {
                const isInCart = item.status === 'in_cart';
                const price = parseFloat(item.estimated_price) || 0;
                if(isInCart) shoppingCart.push({id: item.id, price: price});

                let badge = '';
                // ×—×›××ª ×”××•× ×™×: ×× × ××¦× ××—×™×¨ ×–×•×œ ×™×•×ª×¨
                if (item.best_price && parseFloat(item.best_price) < price) {
                    const date = new Date(item.best_date).toLocaleDateString();
                    badge = `<div class="mt-1 inline-block bg-red-50 border border-red-100 text-red-600 text-[10px] px-2 py-0.5 rounded-full font-bold"><i class="fa-solid fa-tag mr-1"></i>× ××¦× ×‘-â‚ª${item.best_price} ×‘${item.best_store} (${date})</div>`;
                }

                container.innerHTML += `
                    <div class="card p-3 flex flex-col gap-2 ${isInCart ? 'item-in-cart' : ''} transition-all">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <button onclick="toggleCartItem(${item.id}, '${isInCart ? 'approved' : 'in_cart'}')" class="w-6 h-6 rounded-full border-2 ${isInCart ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300'} flex items-center justify-center transition shadow-sm">
                                    ${isInCart ? '<i class="fa-solid fa-check text-xs"></i>' : ''}
                                </button>
                                <div>
                                    <h4 class="font-bold text-gray-800 ${isInCart ? 'item-text' : ''}">${item.item_name}</h4>
                                    <div class="text-xs text-gray-400">${item.requester_name || ''}</div>
                                    ${badge}
                                </div>
                            </div>
                            <!-- ×©×“×” ××—×™×¨ ×œ×¢×¨×™×›×” -->
                            <div class="flex items-center bg-gray-50 rounded-lg px-2 py-1 border border-gray-200">
                                <span class="text-gray-400 text-xs mr-1">â‚ª</span>
                                <input type="number" value="${price > 0 ? price : ''}" placeholder="0" 
                                    class="w-12 bg-transparent text-right font-bold text-gray-700 outline-none text-sm"
                                    onchange="updatePrice(${item.id}, this.value)">
                            </div>
                        </div>
                    </div>
                `;
            });
            updateCartTotal();
        }

        function updateCartTotal() {
            const total = shoppingCart.reduce((sum, item) => sum + item.price, 0);
            document.getElementById('cart-total').innerText = `â‚ª${total.toFixed(2)}`;
            const bar = document.getElementById('checkout-bar');
            if (total > 0) { bar.classList.remove('hidden', 'translate-y-20'); } 
            else { bar.classList.add('translate-y-20'); setTimeout(()=>bar.classList.add('hidden'),300); }
        }

        async function addItemToCart() {
            const input = document.getElementById('new-item-input'); const name = input.value; if(!name) return;
            // ×”×•×¡×¤×” ××•×¤×˜×™××™×ª
            input.value = '';
            await fetch(`${API}/shopping/add`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ itemName: name, userId: currentUser.id }) });
            refreshData(); // ×¨×¢× ×•×Ÿ ×©×§×˜
        }

        async function updatePrice(id, price) {
            await fetch(`${API}/shopping/update-price`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ itemId: id, price }) });
            // ×¢×“×›×•×Ÿ ×œ×•×§××œ×™ ×›×“×™ ×œ× ×œ×¨×¢× ×Ÿ ××ª ×›×œ ×”×“×£
            const item = shoppingCart.find(i => i.id === id);
            if(item) item.price = parseFloat(price);
            updateCartTotal();
        }

        async function toggleCartItem(id, status) {
            await fetch(`${API}/shopping/update`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ itemId: id, status }) });
            refreshData();
        }

        async function checkout() {
            const store = prompt("××™×¤×” ××ª× ×§×•× ×™× ×¢×›×©×™×•?", "×¡×•×¤×¨××¨×§×˜");
            if (!store) return;
            const total = shoppingCart.reduce((sum, i) => sum + i.price, 0);
            const items = appData.shopping_list.filter(i => i.status === 'in_cart').map(i => ({name: i.item_name, price: i.estimated_price}));
            
            const res = await fetch(`${API}/shopping/checkout`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ totalAmount: total, userId: currentUser.id, storeName: store, items })
            });

            if(res.ok) {
                confetti(); alert(`×§× ×™×™×” ×‘×¡×š â‚ª${total} × ×¨×©××” ×‘×”×¦×œ×—×” ×‘-${store}!`);
                refreshData();
            }
        }

        // --- Other Renderers ---
        function renderTasks() {
            const list = document.getElementById('tasks-list'); list.innerHTML = '';
            if(!appData.tasks?.length) { list.innerHTML = `<div class="text-center text-gray-400 py-10">××™×Ÿ ××©×™××•×ª ğŸ‰</div>`; return; }
            appData.tasks.forEach(t => {
                let btn = '';
                if(currentUser.role==='child' && t.status==='pending') btn = `<button onclick="updateTask(${t.id},'pending_approval')" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold">×¡×™×™××ª×™</button>`;
                if(currentUser.role==='parent' && t.status==='pending_approval') btn = `<button onclick="updateTask(${t.id},'approved')" class="bg-green-100 text-green-600 px-3 py-1 rounded-lg text-xs font-bold">××©×¨</button>`;
                list.innerHTML += `<div class="card p-4 flex justify-between items-center border-r-4 ${t.status==='pending'?'border-blue-500':'border-yellow-400'}"><div><div class="font-bold">${t.title}</div><div class="text-xs text-green-600 font-bold">â‚ª${t.reward}</div></div>${btn}</div>`;
            });
        }

        function renderAcademy() {
            const list = document.getElementById('academy-list'); list.innerHTML = '';
            if(!appData.quizzes?.length) { list.innerHTML = `<div class="text-center text-gray-400 py-10">××™×Ÿ ××ª×’×¨×™× ×–××™× ×™× ğŸ“</div>`; return; }
            appData.quizzes.forEach((q, idx) => {
                list.innerHTML += `
                    <div class="card p-4 border-b-4 border-indigo-500">
                        <div class="flex justify-between mb-2"><span class="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-0.5 rounded uppercase">${q.category}</span><span class="text-green-600 font-bold text-xs">+â‚ª${q.reward}</span></div>
                        <h4 class="font-bold text-gray-800 mb-2 text-sm">${q.question}</h4>
                        ${q.content ? `<div class="bg-gray-50 p-2 rounded text-xs text-gray-600 mb-2">${q.content}</div>` : ''}
                        <div class="grid grid-cols-2 gap-2">
                            ${q.options.map((o, i) => `<button onclick="submitAnswer(${q.id}, ${i})" class="bg-white border hover:bg-indigo-50 text-xs py-2 rounded-lg transition">${o}</button>`).join('')}
                        </div>
                    </div>
                `;
            });
        }

        async function updateTask(id, s) { await fetch(`${API}/tasks/update`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({taskId:id, status:s})}); refreshData(); }
        async function submitAnswer(qid, ans) {
            const res = await fetch(`${API}/academy/answer`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:currentUser.id, quizId:qid, answerIndex:ans})});
            const d = await res.json();
            if(d.correct) { confetti(); refreshData(); } else { alert("×œ× × ×•×¨×, × ×¡×” ×©×•×‘!"); }
        }

        function switchTab(t) {
            ['tasks','shopping','academy'].forEach(x=>document.getElementById(`view-${x}`).classList.add('hidden')); document.querySelectorAll('.nav-tab').forEach(e=>e.classList.remove('active'));
            document.getElementById(`view-${t}`).classList.remove('hidden'); document.getElementById(`tab-${t}`).classList.add('active');
        }
        
        function startDemoMode() { isDemoMode = true; document.getElementById('connection-error').classList.add('hidden'); renderLoginUsers([{id:1,name:'×”×“×’××”',role:'child'}]); }
        function saveAppNameAndRetry() { const v=document.getElementById('manual-app-name').value; if(v){localStorage.setItem('custom_app_name',v); location.reload();} }
        function logout() { location.reload(); }
    </script>
</body>
</html>
